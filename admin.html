<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Builder V63</title>
    <style>
        /* CORE */
        * { box-sizing: border-box; }
        :root { --c-accent: #34495e; --bg-canvas: #f4f5f7; }
        html, body { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: var(--bg-canvas); color: #37352f; overflow: hidden; }
        
        /* LAYOUT */
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        
        /* HEADER (Collapsible Panels) */
        .app-header { background: #fff; border-bottom: 1px solid #ddd; z-index: 100; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .header-bar { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; background: #fff; position: relative; z-index: 2; }
        .header-title { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; }
        .header-title span { font-size: 0.8rem; color: #999; }
        .header-actions { display: flex; gap: 8px; }
        
        .panel { background: #fafafa; border-bottom: 1px solid #eee; overflow: hidden; max-height: 0; transition: max-height 0.3s ease-out; padding: 0 20px; }
        .panel.open { max-height: 300px; padding: 15px 20px; border-bottom: 1px solid #ddd; }
        .panel-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        
        button.btn { padding: 6px 12px; border: none; border-radius: 4px; font-weight: 600; font-size: 0.8rem; cursor: pointer; color: white; transition: opacity 0.2s; }
        button.btn:hover { opacity: 0.9; }
        .btn-blue { background: #3498db; } .btn-green { background: #27ae60; } .btn-grey { background: #7f8c8d; }
        
        /* CANVAS (The Editor) */
        .canvas-area { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 0; transition: background 0.3s; }
        
        /* BLOCK (Visual Item) */
        .widget-block { 
            position: relative; 
            border: 2px dashed rgba(0,0,0,0.1); 
            border-radius: 6px; 
            background: #fff; 
            margin: 5px; 
            min-height: 60px; 
            transition: all 0.2s; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            /* Sizing set by JS inline styles */
            width: calc(100% - 10px); 
        }
        .widget-block:hover { border-color: var(--c-accent); box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10; }
        .widget-block.dragging { opacity: 0.4; border-style: solid; transform: scale(0.95); }

        /* EDIT CONTROLS (Only in Admin) */
        .block-controls { 
            position: absolute; top: 5px; right: 5px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; z-index: 20; 
        }
        .widget-block:hover .block-controls { opacity: 1; }
        .ctrl-btn { width: 24px; height: 24px; border-radius: 4px; border: 1px solid #ccc; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .ctrl-btn:hover { background: #eee; }
        .ctrl-del { color: #c0392b; border-color: #e6b0aa; background: #fadbd8; }
        
        .resize-handle {
            position: absolute; top: 0; bottom: 0; right: -5px; width: 10px; cursor: col-resize; z-index: 30;
        }
        .resize-handle:hover { background: rgba(0,0,0,0.1); }

        /* FOOTER (Sticky) */
        .app-footer { background: #fff; border-top: 1px solid #ddd; padding: 10px 20px; flex-shrink: 0; z-index: 100; box-shadow: 0 -4px 12px rgba(0,0,0,0.05); overflow-x: auto; }
        .footer-label { font-size: 0.7rem; font-weight: 700; color: #999; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .footer-buttons { display: flex; gap: 8px; }
        
        /* BUTTON COLORS */
        .add-btn { padding: 8px 12px; border: none; border-radius: 4px; font-weight: 600; font-size: 0.75rem; color: white; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
        .add-btn:hover { transform: translateY(-1px); opacity: 0.9; }
        /* Your Palette */
        .c-text { background: #7f8c8d; } .c-date { background: #16a085; } .c-time { background: #27ae60; }
        .c-grid { background: #6aa84f; } .c-auto { background: #c0392b; } .c-custom { background: #d35400; }
        .c-cycle { background: #e67e22; } .c-count { background: #f39c12; } .c-timer { background: #8e44ad; }
        .c-seq { background: #9b59b6; } .c-cnt { background: #c90076; } .c-moon { background: #34495e; }
        .c-util { background: #95a5a6; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-card { background: white; width: 90%; max-width: 450px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow: hidden; animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; text-align: right; background: #fff; }
        
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.75rem; color: #666; margin-top: 12px; }
        label:first-child { margin-top: 0; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; }
        
        /* CONTENT STYLES (Shared with Index) */
        .widget-content { padding: 15px; height: 100%; display: flex; flex-direction: column; justify-content: center; color: var(--text-color, #37352f); }
        .txt-lg { font-size: 1.5em; font-weight: 700; line-height: 1.1; }
        .txt-sm { font-size: 0.85em; opacity: 0.7; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="app-header">
        <div class="header-bar">
            <div class="header-title" onclick="togglePanel('link-panel')">Link Generator <span>▼</span></div>
            <div class="header-actions">
                <button class="btn btn-blue" onclick="refresh()">Refresh</button>
                <button class="btn btn-green" onclick="copyLink()">Copy</button>
                <button class="btn btn-grey" onclick="openLink()">Open</button>
            </div>
        </div>
        <div id="link-panel" class="panel">
            <input class="link-textarea" id="result-url" readonly onclick="this.select()">
        </div>
        
        <div class="header-bar" style="border-top:1px solid #f0f0f0;">
            <div class="header-title" onclick="togglePanel('settings-panel')">General Settings <span>▼</span></div>
        </div>
        <div id="settings-panel" class="panel">
            <div class="panel-grid">
                <div><label>Theme</label><select id="s-theme" onchange="updateGlobal()"><option value="standard">Standard</option><option value="card">Cards</option><option value="minimal">Minimal</option></select></div>
                <div><label>Font</label><select id="s-font" onchange="updateGlobal()"><option value="sans">Sans-Serif</option><option value="serif">Serif</option><option value="mono">Monospace</option></select></div>
                <div><label>Padding</label><select id="s-pad" onchange="updateGlobal()"><option value="1rem">Normal</option><option value="0.5rem">Compact</option><option value="1.5rem">Spacious</option></select></div>
            </div>
        </div>
    </div>

    <div class="canvas-area" id="canvas">
        </div>

    <div class="app-footer">
        <div class="footer-label">Add Block</div>
        <div class="footer-buttons">
            <button class="add-btn c-text" onclick="addBlock('header')">Text</button>
            <button class="add-btn c-date" onclick="addBlock('date_display')">Date</button>
            <button class="add-btn c-time" onclick="addBlock('world_clock')">Time</button>
            <button class="add-btn c-grid" onclick="addBlock('visual_grid')">Grid</button>
            <button class="add-btn c-auto" onclick="addBlock('progress_group')">Auto Progress</button>
            <button class="add-btn c-custom" onclick="addBlock('progress_custom')">Custom</button>
            <button class="add-btn c-cycle" onclick="addBlock('progress_cycle')">Cycle</button>
            <button class="add-btn c-count" onclick="addBlock('countdown')">Countdown</button>
            <button class="add-btn c-timer" onclick="addBlock('timer')">Timer</button>
            <button class="add-btn c-seq" onclick="addBlock('sequence')">Sequence</button>
            <button class="add-btn c-cnt" onclick="addBlock('counter')">Counter</button>
            <button class="add-btn c-moon" onclick="addBlock('moon_phase')">Moon Phase</button>
            <button class="add-btn c-util" onclick="addBlock('spacer')">Spacer</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
    <div class="modal-card">
        <div class="modal-header">
            <span id="modal-title">Settings</span>
            <span style="cursor:pointer" onclick="closeModal(null, true)">✕</span>
        </div>
        <div class="modal-body" id="modal-content">
            </div>
        <div class="modal-footer">
            <button class="btn btn-blue" onclick="saveModal()">Done</button>
        </div>
    </div>
</div>

<script>
    let settings = { theme: 'standard', font: 'sans', padding: '1rem' };
    let blocks = [];
    let editingIndex = -1;

    // --- ENCODING ---
    function encode(obj) { return window.btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); }
    function decode(str) { try { return JSON.parse(decodeURIComponent(escape(window.atob(str)))); } catch(e) { return null; } }

    // --- INIT ---
    function init() {
        const hash = window.location.hash.substring(1);
        if(hash) {
            const data = decode(hash);
            if(data) {
                settings = data.settings || settings;
                blocks = data.blocks || blocks;
            }
        } else {
            blocks = [{type: 'header', text: 'Welcome', width: '100', id: 'blk_1'}];
        }
        
        // Sync Inputs
        document.getElementById('s-theme').value = settings.theme;
        document.getElementById('s-font').value = settings.font;
        document.getElementById('s-pad').value = settings.padding;
        
        render();
        updateLink();
    }

    // --- RENDER ENGINE (Single Source of Truth) ---
    function render() {
        const canvas = document.getElementById('canvas');
        let html = '';
        
        blocks.forEach((b, i) => {
            if(!b.id) b.id = 'blk_' + Math.random().toString(36).substr(2,9);
            
            // Width Logic (Inline CSS for Canvas)
            const w = b.width === '33' ? '33.33%' : b.width === '50' ? '50%' : '100%';
            
            // Generate Content (Simplified Preview)
            let content = '';
            if(b.type === 'header') content = `<div class="txt-lg">${b.text}</div>`;
            else if(b.type === 'date_display') content = `<div class="txt-lg">Monday</div><div class="txt-sm">Jan 01</div>`;
            else if(b.type === 'world_clock') content = `<div class="txt-lg">12:00</div><div class="txt-sm">Local Time</div>`;
            else content = `<div style="opacity:0.5; font-weight:bold; text-transform:uppercase; font-size:0.8rem;">${b.type.replace('_',' ')}</div><div class="txt-sm">${b.label||''}</div>`;
            
            // Color Logic
            let style = `width: calc(${w} - 10px);`;
            if(b.color && b.color !== 'default') style += `border-left: 4px solid ${b.color};`;

            html += `
            <div class="widget-block" draggable="true" id="card-${i}" data-index="${i}" style="${style}">
                <div class="block-controls">
                    <div class="ctrl-btn" onclick="resizeBlock(${i})">↔</div>
                    <div class="ctrl-btn" onclick="editBlock(${i})">⚙️</div>
                    <div class="ctrl-btn ctrl-del" onclick="deleteBlock(${i})">✕</div>
                </div>
                <div class="widget-content">${content}</div>
                <div class="resize-handle" onmousedown="startResize(${i}, event)"></div>
            </div>`;
        });
        
        canvas.innerHTML = html;
        addDragListeners();
    }

    // --- ACTIONS ---
    window.addBlock = (type) => {
        blocks.push({ type: type, width: '100', id: 'blk_' + Date.now(), label: 'New ' + type });
        render(); updateLink();
        // Scroll to bottom
        setTimeout(() => document.getElementById('canvas').scrollTop = document.getElementById('canvas').scrollHeight, 50);
    };

    window.deleteBlock = (i) => {
        blocks.splice(i, 1);
        render(); updateLink();
    };

    window.resizeBlock = (i) => {
        const w = blocks[i].width;
        blocks[i].width = w === '100' ? '50' : w === '50' ? '33' : '100';
        render(); updateLink();
    };

    // --- DRAG & DROP (Native) ---
    let dragSrc = null;
    function addDragListeners() {
        const items = document.querySelectorAll('.widget-block');
        items.forEach(item => {
            item.addEventListener('dragstart', function(e) {
                dragSrc = this;
                e.dataTransfer.effectAllowed = 'move';
                this.classList.add('dragging');
            });
            item.addEventListener('dragend', function() {
                this.classList.remove('dragging');
            });
            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                return false;
            });
            item.addEventListener('drop', function(e) {
                e.stopPropagation();
                if (dragSrc !== this) {
                    const srcIdx = parseInt(dragSrc.dataset.index);
                    const destIdx = parseInt(this.dataset.index);
                    const temp = blocks[srcIdx];
                    blocks.splice(srcIdx, 1);
                    blocks.splice(destIdx, 0, temp);
                    render(); updateLink();
                }
                return false;
            });
        });
    }

    // --- SETTINGS MODAL ---
    window.editBlock = (i) => {
        editingIndex = i;
        const b = blocks[i];
        const mBody = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = `Edit ${b.type}`;
        
        let html = ``;
        
        // Common Fields
        if('text' in b) html += `<label>Text</label><input id="inp-text" value="${b.text}">`;
        if('label' in b) html += `<label>Label</label><input id="inp-label" value="${b.label}">`;
        
        // Color Picker (Named)
        html += `<label>Accent Color</label><select id="inp-color">
            <option value="default">Default</option>
            <option value="#5b5b5b">Dark Grey</option><option value="#7f8c8d">Grey</option>
            <option value="#27ae60">Green</option><option value="#c0392b">Red</option>
            <option value="#2980b9">Blue</option><option value="#f39c12">Orange</option>
            <option value="#8e44ad">Purple</option>
        </select>`;
        
        mBody.innerHTML = html;
        if(b.color) document.getElementById('inp-color').value = b.color;
        
        document.getElementById('modal-overlay').style.display = 'flex';
    };

    window.saveModal = () => {
        const i = editingIndex;
        if(i > -1) {
            const txt = document.getElementById('inp-text');
            const lbl = document.getElementById('inp-label');
            const col = document.getElementById('inp-color');
            
            if(txt) blocks[i].text = txt.value;
            if(lbl) blocks[i].label = lbl.value;
            if(col) blocks[i].color = col.value;
            
            render(); updateLink();
            closeModal(null, true);
        }
    };

    window.closeModal = (e, force) => {
        if(force || e.target.id === 'modal-overlay') {
            document.getElementById('modal-overlay').style.display = 'none';
        }
    };

    // --- GLOBAL ---
    window.updateGlobal = () => {
        settings.theme = document.getElementById('s-theme').value;
        settings.font = document.getElementById('s-font').value;
        settings.padding = document.getElementById('s-pad').value;
        updateLink();
    };

    window.togglePanel = (id) => {
        const p = document.getElementById(id);
        p.classList.toggle('open');
    };

    window.updateLink = () => {
        const hash = encode({settings, blocks});
        const url = window.location.href.split('#')[0].replace('admin.html', 'index.html');
        document.getElementById('result-url').value = `${url}#${hash}`;
        // Update URL to save state
        window.history.replaceState(null, null, `#${hash}`);
    };

    window.refresh = () => {
        // Reloads the iframe approach if we had one, but here we just re-render
        render();
    };

    window.copyLink = () => {
        const el = document.getElementById('result-url');
        el.select();
        navigator.clipboard.writeText(el.value);
        alert("Copied!");
    };
    
    window.openLink = () => {
        window.open(document.getElementById('result-url').value, '_blank');
    };

    init();
</script>
</body>
</html>
