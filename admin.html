<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Widget Admin Pro</title>
    <style>
        /* CORE LAYOUT */
        body { margin: 0; padding: 0; height: 100vh; display: flex; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #f7f7f5; color: #37352f; overflow: hidden; }
        
        /* Left Panel (Editor) */
        .panel-left { width: 50%; padding: 25px; overflow-y: auto; border-right: 1px solid #e0e0e0; background: #fff; box-sizing: border-box; display: flex; flex-direction: column; gap: 25px;}
        
        /* Right Panel (Preview) */
        .panel-right { width: 50%; background: #eef0f2; display: flex; flex-direction: column; padding: 25px; box-sizing: border-box; }
        
        /* PREVIEW FRAME */
        .preview-wrapper {
            flex-grow: 1;
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            overflow: hidden; 
            border: 1px solid #ccc;
            display: flex; flex-direction: column;
        }
        .preview-toolbar {
            padding: 10px; background: #dfe1e6; border-bottom: 1px solid #ccc;
            display: flex; justify-content: center; align-items: center;
        }
        .preview-label { font-size: 0.75rem; font-weight: bold; color: #555; text-transform: uppercase; letter-spacing: 1px;}
        iframe { flex-grow: 1; width: 100%; border: none; background: white; }

        /* EDITOR STYLES */
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: -0.5px; }
        h2 { font-size: 0.85rem; color: #999; text-transform: uppercase; margin: 0 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 5px; letter-spacing: 0.5px; font-weight: 600;}

        /* SECTIONS */
        .section { margin-bottom: 5px; }

        /* Action Area (Link Gen) */
        .action-area { padding: 15px; background: #2c3e50; border-radius: 8px; color: white; }
        .link-box { 
            background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; 
            font-family: monospace; font-size: 0.75rem; word-break: break-all; margin-bottom: 10px; 
            max-height: 45px; overflow-y: auto; color: #aeb6bf;
        }
        .action-btns { display: flex; gap: 8px; }
        .btn-action { padding: 10px; font-size: 0.8rem; color: white; border-radius: 4px; border:none; cursor: pointer; font-weight: 600; transition: background 0.2s; }
        .btn-refresh { background: #3498db; flex: 2; }
        .btn-copy { background: #34495e; flex: 2; border: 1px solid #566573; }
        .btn-open { background: #7f8c8d; flex: 0; min-width: 40px; font-size: 1.2rem; line-height: 1rem; padding: 0; display:flex; align-items:center; justify-content:center;}
        
        .btn-refresh:hover { background: #2980b9; }
        .btn-copy:hover { background: #2c3e50; }
        .btn-open:hover { background: #95a5a6; }

        /* Block Accordion */
        .block-card { 
            background: white; border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 8px; 
            border-left: 4px solid #999; transition: all 0.2s;
        }
        .block-card.dragging { opacity: 0.5; border: 2px dashed #999; }
        
        .block-header { 
            padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; 
            background: #fbfbfa; user-select: none;
        }
        .block-header:hover { background: #f2f2f2; }
        .block-title { font-weight: 600; font-size: 0.85rem; flex-grow: 1; text-transform: uppercase; color: #555; }
        .toggle-icon { font-size: 0.7rem; color: #bbb; transition: transform 0.2s; }
        .block-card.open .toggle-icon { transform: rotate(180deg); }
        .block-content { padding: 15px; border-top: 1px solid #f0f0f0; display: none; }
        .block-card.open .block-content { display: block; }

        /* Block Colors */
        .type-header { border-left-color: #bdc3c7; }
        .type-world_clock { border-left-color: #1abc9c; }
        .type-progress_group { border-left-color: #e67e22; }
        .type-progress_custom { border-left-color: #f1c40f; }
        .type-progress_cycle { border-left-color: #9b59b6; }
        .type-countdown { border-left-color: #3498db; }
        .type-timer { border-left-color: #e74c3c; }

        /* Form Inputs */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        label { display: block; margin-bottom: 4px; font-weight: 500; font-size: 0.75rem; color: #666;}
        input, select, textarea { 
            width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; 
            font-size: 0.85rem; box-sizing: border-box; background: #fff;
        }
        input:focus, select:focus, textarea:focus { border-color: #2ecc71; outline: none; }
        
        .row { display: flex; gap: 10px; margin-top: 10px; } 
        .col { flex: 1; }
        .viz-controls { background: #f9f9f9; padding: 10px; border-radius: 4px; margin-top: 10px; border: 1px solid #eee; }

        /* Add Buttons */
        .btn-row { display: flex; gap: 8px; flex-wrap: wrap; }
        button { padding: 8px 12px; border: none; border-radius: 4px; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: transform 0.1s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        
        .btn-header { background: #ecf0f1; color: #7f8c8d; }
        .btn-time { background: #d1f2eb; color: #0e6251; }
        .btn-auto { background: #fdebd0; color: #935116; }
        .btn-custom { background: #fcf3cf; color: #7d6608; }
        .btn-cycle { background: #ebdef0; color: #5b2c6f; }
        .btn-count { background: #d6eaf8; color: #154360; }
        .btn-timer { background: #fadbd8; color: #78281f; }
        .btn-del { background: transparent; color: #c0392b; border: 1px solid #e74c3c; padding: 3px 6px; font-size: 0.65rem; }

    </style>
</head>
<body>

<div class="panel-left">
    <div style="margin-bottom: 10px;">
        <h1>Widget Builder</h1>
    </div>
    
    <div class="section">
        <h2>1. Global Settings</h2>
        <div class="settings-grid">
            <div><label>Time</label><select id="set-time" onchange="updateState()"><option value="12">12 Hour</option><option value="24">24 Hour</option></select></div>
            <div><label>Theme</label><select id="set-theme" onchange="updateState()"><option value="standard">Standard</option><option value="minimal">Minimal</option><option value="card">Cards</option></select></div>
            <div><label>Font Size</label><select id="set-font" onchange="updateState()"><option value="standard">Standard</option><option value="small">Small</option><option value="large">Large</option></select></div>
        </div>
    </div>

    <div class="action-area">
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <label style="color:#aaa; font-size:0.7rem;">YOUR WIDGET LINK</label>
        </div>
        <div class="link-box" id="result-url">Generate a link...</div>
        <div class="action-btns">
            <button class="btn-action btn-refresh" onclick="refreshPreview()">↻ REFRESH PREVIEW</button>
            <button class="btn-action btn-copy" id="btn-copy" onclick="copyLink()">COPY LINK</button>
            <button class="btn-action btn-open" onclick="window.open(generateLink(), '_blank')" title="Open in New Tab">⬈</button>
        </div>
    </div>

    <div class="section" style="flex-grow:1; display:flex; flex-direction:column;">
        <h2>2. Widget Blocks</h2>
        <div id="blocks-area"></div>
        
        <div class="btn-row" style="margin-top:15px;">
            <button class="btn-header" onclick="addBlock('header')">+ Text</button>
            <button class="btn-time" onclick="addBlock('world_clock')">+ Time</button>
            <button class="btn-auto" onclick="addBlock('progress_group')">+ Progress (Auto)</button>
            <button class="btn-custom" onclick="addBlock('progress_custom')">+ Progress (Custom)</button>
            <button class="btn-cycle" onclick="addBlock('progress_cycle')">+ Cycle</button>
            <button class="btn-count" onclick="addBlock('countdown')">+ Countdown</button>
            <button class="btn-timer" onclick="addBlock('timer')">+ Timer</button>
        </div>
    </div>
</div>

<div class="panel-right">
    <div class="preview-wrapper">
        <div class="preview-toolbar">
            <span class="preview-label">Live Desktop Preview</span>
        </div>
        <iframe id="preview-frame" src=""></iframe>
    </div>
</div>

<script>
    let settings = { use24h: false, theme: 'standard', fontSize: 'standard' };
    let blocks = [];
    
    function init() {
        try {
            const hash = window.location.hash.substring(1);
            if(hash) {
                const data = JSON.parse(atob(hash));
                if(data.settings) {
                    settings = data.settings;
                    document.getElementById('set-time').value = settings.use24h ? '24' : '12';
                    document.getElementById('set-theme').value = settings.theme;
                    document.getElementById('set-font').value = settings.fontSize;
                }
                if(data.blocks) blocks = data.blocks;
            } else {
                blocks = [{ type: 'header', text: 'Welcome' }];
            }
        } catch(e) {}
        
        renderBlocks();
        generateLink(); // Just text update
        setTimeout(refreshPreview, 500); // Initial load delay to ensure DOM is ready
    }

    // --- REFRESH LOGIC (FIXED) ---
    window.refreshPreview = () => {
        // Get the base link (index.html#...)
        const rawLink = generateLink();
        
        // We need to inject a query param BEFORE the hash to force a reload
        // Format: index.html?t=123456#hash
        const parts = rawLink.split('#');
        const baseUrl = parts[0];
        const hash = parts[1];
        
        // Add timestamp to prevent caching "struggle"
        const cacheBustedUrl = `${baseUrl}?t=${new Date().getTime()}#${hash}`;
        
        document.getElementById('preview-frame').src = cacheBustedUrl;
    };

    // --- RENDERER ---
    function renderBlocks() {
        const area = document.getElementById('blocks-area');
        area.innerHTML = '';

        blocks.forEach((block, index) => {
            const div = document.createElement('div');
            div.className = `block-card type-${block.type}`;
            div.draggable = true;
            div.dataset.index = index;

            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragover', e => e.preventDefault());
            div.addEventListener('drop', handleDrop);

            // Accordion Title
            let displayType = block.type.toUpperCase().replace('_', ' ');
            if(block.type==='world_clock') displayType="TIME";
            if(block.type==='progress_group') displayType="AUTO PROGRESS";
            let label = block.label || block.text || displayType;
            if(label.length>25) label = label.substring(0,22)+"...";

            let html = `
                <div class="block-header" onclick="toggleCard(this)">
                    <span style="color:#ccc; font-size:1.2rem;">☰</span>
                    <span class="block-title">${displayType} <span style="opacity:0.5; font-weight:400; text-transform:none; margin-left:8px;">${label}</span></span>
                    <button class="btn-del" onclick="event.stopPropagation(); removeBlock(${index})">DEL</button>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="block-content">
            `;

            // Inputs
            if (block.type === 'header') html += `<label>Text</label><input type="text" value="${block.text}" oninput="updateBlock(${index}, 'text', this.value)">`;
            else if (block.type === 'world_clock') html += `<label>Locations (JSON)</label><textarea rows="3" onchange="updateBlockJSON(${index}, 'locations', this.value, this)">${JSON.stringify(block.locations)}</textarea>`;
            else if (block.type === 'progress_group') html += `<label>Items (JSON)</label><textarea rows="3" onchange="updateBlockJSON(${index}, 'items', this.value, this)">${JSON.stringify(block.items)}</textarea>`;
            else if (block.type === 'progress_custom') html += `<label>Label</label><input type="text" value="${block.label}" oninput="updateBlock(${index}, 'label', this.value)"><div class="row"><div class="col"><label>Start</label><input type="date" value="${block.start}" oninput="updateBlock(${index}, 'start', this.value)"></div><div class="col"><label>End</label><input type="date" value="${block.end}" oninput="updateBlock(${index}, 'end', this.value)"></div></div>`;
            else if (block.type === 'progress_cycle') html += `<label>Label</label><input type="text" value="${block.label}" oninput="updateBlock(${index}, 'label', this.value)"><div class="row"><div class="col"><label>Anchor Date</label><input type="date" value="${block.anchor}" oninput="updateBlock(${index}, 'anchor', this.value)"></div><div class="col"><label>Days</label><input type="number" value="${block.days}" oninput="updateBlock(${index}, 'days', this.value)"></div></div>`;
            else if (block.type === 'countdown') html += `<label>Label</label><input type="text" value="${block.label}" oninput="updateBlock(${index}, 'label', this.value)"><div class="row"><div class="col"><label>Date</label><input type="date" value="${block.date}" oninput="updateBlock(${index}, 'date', this.value)"></div><div class="col"><label>Style</label><select onchange="updateBlock(${index}, 'style', this.value)"><option value="detailed" ${block.style=='detailed'?'selected':''}>Detailed</option><option value="days" ${block.style=='days'?'selected':''}>Days Only</option></select></div></div>`;
            else if (block.type === 'timer') html += `<label>Label</label><input type="text" value="${block.label}" oninput="updateBlock(${index}, 'label', this.value)"><div class="row"><div class="col"><label>Hours</label><input type="number" value="${block.hours}" oninput="updateBlock(${index}, 'hours', this.value)"></div><div class="col"><label>Minutes</label><input type="number" value="${block.minutes}" oninput="updateBlock(${index}, 'minutes', this.value)"></div></div>`;

            // VISUAL CONTROLS
            html += `
                <div class="viz-controls">
                    <div class="row" style="margin-top:0;">
                        <div class="col">
                            <label>Accent Color</label>
                            <div style="display:flex; gap:5px;">
                                <select onchange="updateBlock(${index}, 'color', this.value)" style="flex:1;">
                                    <option value="default" ${!block.color?'selected':''}>Default</option>
                                    <option value="gray" ${block.color=='gray'?'selected':''}>Gray</option>
                                    <option value="brown" ${block.color=='brown'?'selected':''}>Brown</option>
                                    <option value="orange" ${block.color=='orange'?'selected':''}>Orange</option>
                                    <option value="yellow" ${block.color=='yellow'?'selected':''}>Yellow</option>
                                    <option value="green" ${block.color=='green'?'selected':''}>Green</option>
                                    <option value="blue" ${block.color=='blue'?'selected':''}>Blue</option>
                                    <option value="purple" ${block.color=='purple'?'selected':''}>Purple</option>
                                    <option value="pink" ${block.color=='pink'?'selected':''}>Pink</option>
                                    <option value="red" ${block.color=='red'?'selected':''}>Red</option>
                                </select>
                                <input type="color" value="${block.color && block.color.startsWith('#') ? block.color : '#000000'}" 
                                    onchange="updateBlock(${index}, 'color', this.value)" style="width:30px; padding:0; height:32px;">
                            </div>
                        </div>
                        <div class="col">
                            <label>Width</label>
                            <select onchange="updateBlock(${index}, 'width', this.value)">
                                <option value="100" ${block.width!='50'?'selected':''}>Full (100%)</option>
                                <option value="50" ${block.width=='50'?'selected':''}>Half (50%)</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;

            html += `</div>`;
            div.innerHTML = html;
            area.appendChild(div);
        });
    }

    function toggleCard(header) { header.parentElement.classList.toggle('open'); }

    // --- STATE LOGIC ---
    function updateState() {
        settings.use24h = document.getElementById('set-time').value === '24';
        settings.theme = document.getElementById('set-theme').value;
        settings.fontSize = document.getElementById('set-font').value;
        generateLink(); // Updates text box
        // Note: We do NOT auto-refresh iframe here. User must click Refresh.
    }

    window.updateBlock = (idx, key, val) => { blocks[idx][key] = val; updateState(); };
    window.updateBlockJSON = (idx, key, val, el) => {
        try {
            blocks[idx][key] = JSON.parse(val);
            el.classList.remove('invalid');
            updateState();
        } catch(e) {
            el.classList.add('invalid');
        }
    };

    window.addBlock = (type) => {
        let b = { type };
        if(type==='header') b.text='Header';
        if(type==='world_clock') b.locations=[{label:'NYC',timezone:'America/New_York'}];
        if(type==='progress_group') b.items=[{type:'day',label:'Day'}];
        if(type==='progress_custom') { b.label='Goal'; b.start='2024-01-01'; b.end='2024-12-31'; }
        if(type==='progress_cycle') { b.label='Cycle'; b.anchor='2024-01-01'; b.days='30'; }
        if(type==='countdown') { b.label='Launch'; b.date='2025-01-01'; b.style='detailed'; }
        if(type==='timer') { b.label='Focus'; b.hours=0; b.minutes=25; }
        
        blocks.push(b);
        renderBlocks();
        const cards = document.querySelectorAll('.block-card');
        if(cards.length > 0) cards[cards.length-1].classList.add('open');
        updateState();
    };

    window.removeBlock = (idx) => { blocks.splice(idx, 1); renderBlocks(); updateState(); };

    // --- DRAG & DROP ---
    let dragSrc = null;
    function handleDragStart(e) { dragSrc = this; e.dataTransfer.effectAllowed='move'; this.classList.add('dragging'); }
    function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();
        const srcIdx = parseInt(dragSrc.dataset.index);
        const tgtIdx = parseInt(this.dataset.index);
        if (dragSrc !== this) {
            const item = blocks[srcIdx];
            blocks.splice(srcIdx, 1);
            blocks.splice(tgtIdx, 0, item);
            renderBlocks();
            updateState();
        }
        return false;
    }

    // --- LINK UTILS ---
    function generateLink() {
        const json = JSON.stringify({ settings, blocks });
        const encoded = btoa(json);
        
        let url = window.location.href.split('#')[0].split('?')[0];
        if(url.includes('admin.html')) url = url.replace('admin.html', 'index.html');
        else if(url.endsWith('/')) url += 'index.html';
        else {
            const lastSlash = url.lastIndexOf('/');
            if(lastSlash !== -1) url = url.substring(0, lastSlash) + '/index.html';
            else url += '/index.html';
        }

        const final = `${url}#${encoded}`;
        document.getElementById('result-url').innerText = final;
        return final;
    }

    window.copyLink = () => {
        navigator.clipboard.writeText(document.getElementById('result-url').innerText)
            .then(() => {
                const btn = document.getElementById('btn-copy');
                const prev = btn.innerText;
                btn.innerText = "COPIED!";
                setTimeout(() => btn.innerText = prev, 1500);
            });
    };

    init();
</script>
</body>
</html>
