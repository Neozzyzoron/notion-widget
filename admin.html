<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Admin V66</title>
    <style>
        /* CORE */
        * { box-sizing: border-box; }
        :root { --c-accent: #34495e; --bg-canvas: #f4f5f7; }
        html, body { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: var(--bg-canvas); color: #37352f; overflow: hidden; }
        
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        
        /* HEADER */
        .app-header { background: #fff; border-bottom: 1px solid #ddd; z-index: 100; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .header-bar { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; background: #fff; position: relative; z-index: 2; }
        .header-title { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; }
        .header-title span { font-size: 0.8rem; color: #999; }
        .header-actions { display: flex; gap: 8px; }
        
        /* DARK SETTINGS PANEL */
        .panel { background: #2c3e50; color: white; overflow: hidden; max-height: 0; transition: max-height 0.3s ease-out; }
        .panel.open { max-height: 400px; padding: 20px; border-bottom: 1px solid #1a252f; overflow-y: auto; }
        .panel-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; }
        .panel label { color: #bdc3c7; text-transform: uppercase; letter-spacing: 1px; font-size: 0.7rem; margin-bottom: 5px; display: block; }
        .panel select { background: #34495e; color: white; border: 1px solid #465c71; }
        @media(max-width: 768px) { .panel-grid { grid-template-columns: 1fr 1fr; } }
        
        /* CANVAS */
        .canvas-area { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; transition: background 0.3s; position: relative; }
        
        /* BLOCK */
        .widget-block { 
            position: relative; 
            border: 2px dashed rgba(0,0,0,0.1); 
            border-radius: 8px; 
            background: #fff; 
            min-height: 80px; 
            transition: box-shadow 0.2s, border-color 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        .widget-block:hover { border-color: var(--c-accent); box-shadow: 0 8px 20px rgba(0,0,0,0.1); z-index: 10; }
        .widget-block.dragging { opacity: 0.5; border-style: solid; transform: scale(0.98); }

        /* CONTROLS */
        .block-controls { position: absolute; top: 5px; right: 5px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; z-index: 20; }
        .widget-block:hover .block-controls { opacity: 1; }
        .ctrl-btn { width: 24px; height: 24px; border-radius: 4px; border: 1px solid #ccc; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: #555; }
        .ctrl-btn:hover { background: #eee; }
        .ctrl-del { color: #c0392b; border-color: #e6b0aa; background: #fadbd8; }
        
        /* HANDLES */
        .resize-handle-w { position: absolute; top: 0; bottom: 10px; right: -5px; width: 10px; cursor: col-resize; z-index: 30; }
        .resize-handle-h { position: absolute; bottom: -5px; left: 0; right: 0; height: 10px; cursor: row-resize; z-index: 30; }

        /* FOOTER */
        .app-footer { background: #fff; border-top: 1px solid #ddd; padding: 10px 20px; flex-shrink: 0; z-index: 100; box-shadow: 0 -4px 12px rgba(0,0,0,0.05); overflow-x: auto; }
        .footer-label { font-size: 0.7rem; font-weight: 700; color: #999; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .footer-buttons { display: flex; gap: 6px; }
        .add-btn { padding: 8px 12px; border: none; border-radius: 4px; font-weight: 600; font-size: 0.75rem; color: white; cursor: pointer; white-space: nowrap; flex-shrink: 0; transition: transform 0.1s; }
        .add-btn:hover { transform: translateY(-1px); opacity: 0.9; }
        
        /* COLORS */
        .c-text { background: #7f8c8d; } .c-date { background: #16a085; } .c-time { background: #27ae60; }
        .c-grid { background: #6aa84f; } .c-auto { background: #c0392b; } .c-custom { background: #d35400; }
        .c-cycle { background: #e67e22; } .c-count { background: #f39c12; } .c-timer { background: #8e44ad; }
        .c-seq { background: #9b59b6; } .c-cnt { background: #c90076; } .c-moon { background: #34495e; }
        .c-util { background: #95a5a6; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-card { background: white; width: 95%; max-width: 500px; border-radius: 8px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; font-weight: 700; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-body { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; text-align: right; background: #fff; flex-shrink: 0; }
        
        /* FORM ELEMENTS */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.75rem; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; }
        .row { display: flex; gap: 10px; } .col { flex: 1; }
        
        /* SUB-LISTS */
        .sub-list { border: 1px solid #eee; border-radius: 4px; padding: 10px; background: #fafafa; margin-bottom: 10px; }
        .sub-item { display: flex; gap: 5px; margin-bottom: 8px; align-items: center; }
        .sub-item:last-child { margin-bottom: 0; }
        .btn-mini { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: 1px solid #ccc; background: #fff; border-radius: 4px; cursor: pointer; color: #555; }
        .btn-mini:hover { background: #eee; }
        .btn-mini-del { background: #fadbd8; border-color: #e6b0aa; color: #c0392b; }
        .btn-add-row { width: 100%; padding: 8px; background: #eef0f2; border: 1px dashed #ccc; border-radius: 4px; cursor: pointer; font-weight: 600; color: #666; }
        
        /* CITY SEARCH */
        .search-wrap { position: relative; flex-grow: 1; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; max-height: 150px; overflow-y: auto; z-index: 50; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .search-item { padding: 8px; font-size: 0.8rem; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .search-item:hover { background: #f5f5f5; }

        /* LINK PANEL */
        .link-panel { background: #f8f9fa; border-bottom: 1px solid #e0e0e0; overflow: hidden; max-height: 0; transition: max-height 0.3s ease-out; padding: 0 20px; }
        .link-panel.open { max-height: 100px; padding: 15px 20px; }
        .link-textarea { width: 100%; height: 60px; font-family: monospace; font-size: 0.75rem; color: #666; border: 1px solid #ddd; border-radius: 4px; padding: 8px; resize: none; background: #fff; }

        /* BUTTONS */
        button.btn { padding: 8px 16px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; color: white; }
        .btn-blue { background: #3498db; } .btn-green { background: #27ae60; } .btn-grey { background: #7f8c8d; }

        /* CONTENT PREVIEW */
        .widget-content { padding: 15px; height: 100%; display: flex; flex-direction: column; justify-content: center; pointer-events: none; color: var(--text-color, #37352f); }
        .txt-lg { font-size: 1.4em; font-weight: 700; line-height: 1.2; }
        .txt-sm { opacity: 0.7; font-size: 0.85em; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="app-header">
        <div class="header-bar">
            <div class="header-title" onclick="togglePanel('link-panel')">Link Generator <span>▼</span></div>
            <div class="header-actions">
                <button class="btn btn-blue" onclick="refresh()">Refresh</button>
                <button class="btn btn-green" onclick="copyLink()">Copy</button>
                <button class="btn btn-grey" onclick="openLink()">Open</button>
            </div>
        </div>
        <div id="link-panel" class="link-panel">
            <input class="link-textarea" id="result-url" readonly onclick="this.select()">
        </div>
        
        <div class="header-bar" style="border-top:1px solid #eee; background:#fafafa;">
            <div class="header-title" onclick="togglePanel('settings-panel')">General Settings <span>▼</span></div>
        </div>
        <div id="settings-panel" class="panel">
            <div class="panel-grid">
                <div><label>Time Format</label><select id="s-time" onchange="updateGlobal()"><option value="12">12 Hour</option><option value="24">24 Hour</option></select></div>
                <div><label>Week Start</label><select id="s-week" onchange="updateGlobal()"><option value="monday">Monday</option><option value="sunday">Sunday</option></select></div>
                <div><label>Theme</label><select id="s-theme" onchange="updateGlobal()"><option value="standard">Standard</option><option value="card">Cards</option><option value="minimal">Minimal</option></select></div>
                <div><label>Font</label><select id="s-font" onchange="updateGlobal()"><option value="sans">Sans-Serif</option><option value="serif">Serif</option><option value="mono">Monospace</option></select></div>
                <div><label>Text Size</label><select id="s-size" onchange="updateGlobal()"><option value="small">Small</option><option value="medium" selected>Medium</option><option value="large">Large</option></select></div>
                <div><label>Padding</label><select id="s-pad" onchange="updateGlobal()"><option value="comfortable">Comfortable</option><option value="compact">Compact</option><option value="spacious">Spacious</option></select></div>
            </div>
        </div>
    </div>

    <div class="canvas-area" id="canvas" onmousemove="handleDrag(event)" onmouseup="stopDrag()"></div>

    <div class="app-footer">
        <div class="footer-label">Add Block</div>
        <div class="footer-buttons">
            <button class="add-btn c-text" onclick="addBlock('header')">Text</button>
            <button class="add-btn c-date" onclick="addBlock('date_display')">Date</button>
            <button class="add-btn c-time" onclick="addBlock('world_clock')">Time</button>
            <button class="add-btn c-grid" onclick="addBlock('visual_grid')">Grid</button>
            <button class="add-btn c-auto" onclick="addBlock('progress_group')">Auto Progress</button>
            <button class="add-btn c-custom" onclick="addBlock('progress_custom')">Custom Progress</button>
            <button class="add-btn c-cycle" onclick="addBlock('progress_cycle')">Cycle</button>
            <button class="add-btn c-count" onclick="addBlock('countdown')">Countdown</button>
            <button class="add-btn c-timer" onclick="addBlock('timer')">Timer</button>
            <button class="add-btn c-seq" onclick="addBlock('sequence')">Sequence</button>
            <button class="add-btn c-cnt" onclick="addBlock('counter')">Counter</button>
            <button class="add-btn c-moon" onclick="addBlock('moon_phase')">Moon Phase</button>
            <button class="add-btn c-util" onclick="addBlock('spacer')">Spacer</button>
            <button class="add-btn c-util" onclick="addBlock('empty')">Empty Block</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-overlay">
    <div class="modal-card">
        <div class="modal-header"><span id="modal-title">Settings</span><span style="cursor:pointer" onclick="closeModal()">✕</span></div>
        <div class="modal-body" id="modal-content"></div>
        <div class="modal-footer"><button class="btn btn-blue" onclick="saveModal()">Done</button></div>
    </div>
</div>

<script>
    // --- STATE ---
    let settings = { use24h: '12', weekStart: 'monday', theme: 'standard', font: 'sans', textSize: 'medium', padding: 'comfortable' };
    let blocks = [];
    let editingIndex = -1;
    let resizingIndex = -1;
    let resizeMode = ''; 
    let startX, startY, startW, startH;

    // --- DATASETS ---
    const cityDB = [
{name:"Abidjan",tz:"Africa/Abidjan"},{name:"Abu Dhabi",tz:"Asia/Dubai"},{name:"Abuja",tz:"Africa/Lagos"},{name:"Accra",tz:"Africa/Accra"},{name:"Adak",tz:"America/Adak"},{name:"Adamstown",tz:"Pacific/Pitcairn"},{name:"Addis Ababa",tz:"Africa/Addis_Ababa"},{name:"Adelaide",tz:"Australia/Adelaide"},{name:"Alert",tz:"America/Iqaluit"},{name:"Algiers",tz:"Africa/Algiers"},{name:"Alice Springs",tz:"Australia/Darwin"},{name:"Almaty",tz:"Asia/Almaty"},{name:"Alofi",tz:"Pacific/Niue"},{name:"Amman",tz:"Asia/Amman"},{name:"Amsterdam",tz:"Europe/Amsterdam"},{name:"Amsterdam Island",tz:"Indian/Kerguelen"},{name:"Anadyr",tz:"Asia/Anadyr"},{name:"Anchorage",tz:"America/Anchorage"},{name:"Ankara",tz:"Europe/Istanbul"},{name:"Antananarivo",tz:"Indian/Antananarivo"},{name:"Apia",tz:"Pacific/Apia"},{name:"Ashgabat",tz:"Asia/Ashgabat"},{name:"Asmara",tz:"Africa/Asmara"},{name:"Astana",tz:"Asia/Almaty"},{name:"Asuncion",tz:"America/Asuncion"},{name:"Athens",tz:"Europe/Athens"},{name:"Atlanta",tz:"America/New_York"},{name:"Auckland",tz:"Pacific/Auckland"},{name:"Austin",tz:"America/Chicago"},{name:"Baghdad",tz:"Asia/Baghdad"},{name:"Baker Island",tz:"Etc/GMT+12"},{name:"Baker Lake",tz:"America/Rankin_Inlet"},{name:"Baku",tz:"Asia/Baku"},{name:"Bamako",tz:"Africa/Bamako"},{name:"Bandar Seri Begawan",tz:"Asia/Brunei"},{name:"Bangkok",tz:"Asia/Bangkok"},{name:"Bangui",tz:"Africa/Bangui"},{name:"Banjul",tz:"Africa/Banjul"},{name:"Barcelona",tz:"Europe/Madrid"},{name:"Basse-Terre",tz:"America/Guadeloupe"},{name:"Beijing",tz:"Asia/Shanghai"},{name:"Beirut",tz:"Asia/Beirut"},{name:"Belém",tz:"America/Belem"},{name:"Belgrade",tz:"Europe/Belgrade"},{name:"Belfast",tz:"Europe/Belfast"},{name:"Belmopan",tz:"America/Belize"},{name:"Belushya Guba",tz:"Europe/Moscow"},{name:"Bengaluru",tz:"Asia/Kolkata"},{name:"Berlin",tz:"Europe/Berlin"},{name:"Bern",tz:"Europe/Zurich"},{name:"Bishkek",tz:"Asia/Bishkek"},{name:"Bissau",tz:"Africa/Bissau"},{name:"Bogota",tz:"America/Bogota"},{name:"Boston",tz:"America/New_York"},{name:"Brasilia",tz:"America/Sao_Paulo"},{name:"Bratislava",tz:"Europe/Bratislava"},{name:"Brazzaville",tz:"Africa/Brazzaville"},{name:"Bridgetown",tz:"America/Barbados"},{name:"Brisbane",tz:"Australia/Brisbane"},{name:"Brussels",tz:"Europe/Brussels"},{name:"Bucharest",tz:"Europe/Bucharest"},{name:"Budapest",tz:"Europe/Budapest"},{name:"Buenos Aires",tz:"America/Argentina/Buenos_Aires"},{name:"Bujumbura",tz:"Africa/Bujumbura"},{name:"Cairns",tz:"Australia/Brisbane"},{name:"Cairo",tz:"Africa/Cairo"},{name:"Calgary",tz:"America/Edmonton"},{name:"Canberra",tz:"Australia/Sydney"},{name:"Cancún",tz:"America/Cancun"},{name:"Cape Town",tz:"Africa/Johannesburg"},{name:"Caracas",tz:"America/Caracas"},{name:"Cardiff",tz:"Europe/London"},{name:"Casablanca",tz:"Africa/Casablanca"},{name:"Cayenne",tz:"America/Cayenne"},{name:"Chatham Islands",tz:"Pacific/Chatham"},{name:"Chennai",tz:"Asia/Kolkata"},{name:"Chibougamau",tz:"America/Toronto"},{name:"Chicago",tz:"America/Chicago"},{name:"Chișinău",tz:"Europe/Chisinau"},{name:"Chita",tz:"Asia/Chita"},{name:"Chongqing",tz:"Asia/Chongqing"},{name:"Ciudad de la Paz",tz:"Africa/Malabo"},{name:"Conakry",tz:"Africa/Conakry"},{name:"Copenhagen",tz:"Europe/Copenhagen"},{name:"Coral Harbour",tz:"America/Atikokan"},{name:"Córdoba",tz:"America/Argentina/Cordoba"},{name:"Dakar",tz:"Africa/Dakar"},{name:"Dallas",tz:"America/Chicago"},{name:"Damascus",tz:"Asia/Damascus"},{name:"Danmarkshavn",tz:"America/Danmarkshavn"},{name:"Dar es Salaam",tz:"Africa/Dar_es_Salaam"},{name:"Darwin",tz:"Australia/Darwin"},{name:"Denpasar",tz:"Asia/Makassar"},{name:"Denver",tz:"America/Denver"},{name:"Detroit",tz:"America/Detroit"},{name:"Dhaka",tz:"Asia/Dhaka"},{name:"Diego Garcia",tz:"Indian/Chagos"},{name:"Dili",tz:"Asia/Dili"},{name:"Djibouti",tz:"Africa/Djibouti"},{name:"Dnipro",tz:"Europe/Kyiv"},{name:"Dodoma",tz:"Africa/Dar_es_Salaam"},{name:"Doha",tz:"Asia/Qatar"},{name:"Douglas",tz:"Europe/Isle_of_Man"},{name:"Dubai",tz:"Asia/Dubai"},{name:"Dublin",tz:"Europe/Dublin"},{name:"Dushanbe",tz:"Asia/Dushanbe"},{name:"Easter Island",tz:"Pacific/Easter"},{name:"Edinburgh",tz:"Europe/London"},{name:"Edmonton",tz:"America/Edmonton"},{name:"El Aaiún",tz:"Africa/El_Aaiun"},{name:"Eucla",tz:"Australia/Eucla"},{name:"Eureka",tz:"America/Winnipeg"},{name:"Fairbanks",tz:"America/Anchorage"},{name:"Fakaofo",tz:"Pacific/Fakaofo"},{name:"Fortaleza",tz:"America/Fortaleza"},{name:"Frankfurt",tz:"Europe/Berlin"},{name:"Freetown",tz:"Africa/Freetown"},{name:"Funafuti",tz:"Pacific/Funafuti"},{name:"Gaborone",tz:"Africa/Gaborone"},{name:"Galapagos Islands",tz:"Pacific/Galapagos"},{name:"Georgetown",tz:"America/Guyana"},{name:"Gibraltar",tz:"Europe/Gibraltar"},{name:"Gitega",tz:"Africa/Bujumbura"},{name:"Glasgow",tz:"Europe/London"},{name:"Grise Fiord",tz:"America/Iqaluit"},{name:"Guatemala City",tz:"America/Guatemala"},{name:"Hagåtña",tz:"Pacific/Guam"},{name:"Halifax",tz:"America/Halifax"},{name:"Hamilton",tz:"America/Toronto"},{name:"Hanoi",tz:"Asia/Ho_Chi_Minh"},{name:"Happy Valley-Goose Bay",tz:"America/Goose_Bay"},{name:"Harare",tz:"Africa/Harare"},{name:"Havana",tz:"America/Havana"},{name:"Helsinki",tz:"Europe/Helsinki"},{name:"Hermosillo",tz:"America/Hermosillo"},{name:"Hobart",tz:"Australia/Hobart"},{name:"Hong Kong",tz:"Asia/Hong_Kong"},{name:"Honiara",tz:"Pacific/Guadalcanal"},{name:"Honolulu",tz:"Pacific/Honolulu"},{name:"Houston",tz:"America/Chicago"},{name:"Hovd",tz:"Asia/Hovd"},{name:"Indianapolis",tz:"America/Indiana/Indianapolis"},{name:"Inuvik",tz:"America/Inuvik"},{name:"Irkutsk",tz:"Asia/Irkutsk"},{name:"Islamabad",tz:"Asia/Karachi"},{name:"Istanbul",tz:"Europe/Istanbul"},{name:"Ittoqqortoormiit",tz:"America/Scoresbysund"},{name:"Izhevsk",tz:"Europe/Samara"},{name:"Jakarta",tz:"Asia/Jakarta"},{name:"Jamestown",tz:"Atlantic/St_Helena"},{name:"Jerusalem",tz:"Asia/Jerusalem"},{name:"Johannesburg",tz:"Africa/Johannesburg"},{name:"Juba",tz:"Africa/Juba"},{name:"Juneau",tz:"America/Juneau"},{name:"Kabul",tz:"Asia/Kabul"},{name:"Kaliningrad",tz:"Europe/Kaliningrad"},{name:"Kampala",tz:"Africa/Kampala"},{name:"Kangerlussuaq",tz:"America/Nuuk"},{name:"Kansas City",tz:"America/Chicago"},{name:"Karachi",tz:"Asia/Karachi"},{name:"Kathmandu",tz:"Asia/Kathmandu"},{name:"Kemi",tz:"Europe/Helsinki"},{name:"Khartoum",tz:"Africa/Khartoum"},{name:"Khatanga",tz:"Asia/Krasnoyarsk"},{name:"Kigali",tz:"Africa/Kigali"},{name:"King Edward Point",tz:"Atlantic/South_Georgia"},{name:"Kingston",tz:"America/Jamaica"},{name:"Kinshasa",tz:"Africa/Kinshasa"},{name:"Kiritimati",tz:"Pacific/Kiritimati"},{name:"Kolkata",tz:"Asia/Kolkata"},{name:"Komsomolsk-on-Amur",tz:"Asia/Vladivostok"},{name:"Krasnoyarsk",tz:"Asia/Krasnoyarsk"},{name:"Kuala Lumpur",tz:"Asia/Kuala_Lumpur"},{name:"Kuujjuaq",tz:"America/Iqaluit"},{name:"Kuwait City",tz:"Asia/Kuwait"},{name:"Kyiv",tz:"Europe/Kyiv"},{name:"La Paz",tz:"America/La_Paz"},{name:"Lagos",tz:"Africa/Lagos"},{name:"Lahore",tz:"Asia/Karachi"},{name:"Las Vegas",tz:"America/Los_Angeles"},{name:"Lhasa",tz:"Asia/Shanghai"},{name:"Libreville",tz:"Africa/Libreville"},{name:"Lilongwe",tz:"Africa/Blantyre"},{name:"Lima",tz:"America/Lima"},{name:"Lisbon",tz:"Europe/Lisbon"},{name:"Ljubljana",tz:"Europe/Ljubljana"},{name:"Lomé",tz:"Africa/Lome"},{name:"London",tz:"Europe/London"},{name:"Longyearbyen",tz:"Arctic/Longyearbyen"},{name:"Los Angeles",tz:"America/Los_Angeles"},{name:"Luanda",tz:"Africa/Luanda"},{name:"Lubumbashi",tz:"Africa/Lubumbashi"},{name:"Lusaka",tz:"Africa/Lusaka"},{name:"Luxembourg",tz:"Europe/Luxembourg"},{name:"Madrid",tz:"Europe/Madrid"},{name:"Magadan",tz:"Asia/Magadan"},{name:"Majuro",tz:"Pacific/Majuro"},{name:"Makassar",tz:"Asia/Makassar"},{name:"Malabo",tz:"Africa/Malabo"},{name:"Male",tz:"Indian/Maldives"},{name:"Managua",tz:"America/Managua"},{name:"Manama",tz:"Asia/Bahrain"},{name:"Manaus",tz:"America/Manaus"},{name:"Manila",tz:"Asia/Manila"},{name:"Manokwari",tz:"Asia/Jayapura"},{name:"Maputo",tz:"Africa/Maputo"},{name:"Marion Island",tz:"Indian/Antananarivo"},{name:"Mary's Harbour",tz:"America/St_Johns"},{name:"Maseru",tz:"Africa/Maseru"},{name:"Mbabane",tz:"Africa/Mbabane"},{name:"Melbourne",tz:"Australia/Melbourne"},{name:"Mexico City",tz:"America/Mexico_City"},{name:"Miami",tz:"America/New_York"},{name:"Midway",tz:"Pacific/Midway"},{name:"Minneapolis",tz:"America/Chicago"},{name:"Minsk",tz:"Europe/Minsk"},{name:"Mogadishu",tz:"Africa/Mogadishu"},{name:"Monaco",tz:"Europe/Monaco"},{name:"Monrovia",tz:"Africa/Monrovia"},{name:"Montevideo",tz:"America/Montevideo"},{name:"Montréal",tz:"America/Toronto"},{name:"Moroni",tz:"Indian/Comoro"},{name:"Moscow",tz:"Europe/Moscow"},{name:"Mumbai",tz:"Asia/Kolkata"},{name:"Muscat",tz:"Asia/Muscat"},{name:"Nairobi",tz:"Africa/Nairobi"},{name:"Nassau",tz:"America/Nassau"},{name:"Naypyidaw",tz:"Asia/Yangon"},{name:"N'Djamena",tz:"Africa/Ndjamena"},{name:"New Delhi",tz:"Asia/Kolkata"},{name:"New Orleans",tz:"America/Chicago"},{name:"New York",tz:"America/New_York"},{name:"Ngerulmud",tz:"Pacific/Palau"},{name:"Niamey",tz:"Africa/Niamey"},{name:"Nicosia",tz:"Asia/Nicosia"},{name:"Norilsk",tz:"Asia/Krasnoyarsk"},{name:"Nouakchott",tz:"Africa/Nouakchott"},{name:"Novosibirsk",tz:"Asia/Novosibirsk"},{name:"Nuku'alofa",tz:"Pacific/Tongatapu"},{name:"Nusantara",tz:"Asia/Makassar"},{name:"Nuuk",tz:"America/Nuuk"},{name:"Oklahoma City",tz:"America/Chicago"},{name:"Omsk",tz:"Asia/Omsk"},{name:"Oral",tz:"Asia/Oral"},{name:"Oslo",tz:"Europe/Oslo"},{name:"Ottawa",tz:"America/Toronto"},{name:"Ouagadougou",tz:"Africa/Ouagadougou"},{name:"Palikir",tz:"Pacific/Pohnpei"},{name:"Panama",tz:"America/Panama"},{name:"Papeete",tz:"Pacific/Tahiti"},{name:"Paramaribo",tz:"America/Paramaribo"},{name:"Paris",tz:"Europe/Paris"},{name:"Perth",tz:"Australia/Perth"},{name:"Petropavlovsk-Kamchatsky",tz:"Asia/Kamchatka"},{name:"Pevek",tz:"Asia/Srednekolymsk"},{name:"Philadelphia",tz:"America/New_York"},{name:"Phnom Penh",tz:"Asia/Phnom_Penh"},{name:"Phoenix",tz:"America/Phoenix"},{name:"Pituffik",tz:"America/Thule"},{name:"Podgorica",tz:"Europe/Podgorica"},{name:"Pond Inlet",tz:"America/Iqaluit"},{name:"Ponta Delgada",tz:"Atlantic/Azores"},{name:"Pontianak",tz:"Asia/Pontianak"},{name:"Port Louis",tz:"Indian/Mauritius"},{name:"Port Moresby",tz:"Pacific/Port_Moresby"},{name:"Port of Spain",tz:"America/Port_of_Spain"},{name:"Port Vila",tz:"Pacific/Efate"},{name:"Port-au-Prince",tz:"America/Port-au-Prince"},{name:"Port-aux-Francais",tz:"Indian/Kerguelen"},{name:"Porto Novo",tz:"Africa/Porto-Novo"},{name:"Prague",tz:"Europe/Prague"},{name:"Praia",tz:"Atlantic/Cape_Verde"},{name:"Pretoria",tz:"Africa/Johannesburg"},{name:"Pune",tz:"Asia/Kolkata"},{name:"Punta Arenas",tz:"America/Punta_Arenas"},{name:"Pyongyang",tz:"Asia/Pyongyang"},{name:"Qaanaaq",tz:"America/Thule"},{name:"Quito",tz:"America/Guayaquil"},{name:"Rabat",tz:"Africa/Casablanca"},{name:"Rarotonga",tz:"Pacific/Rarotonga"},{name:"Regina",tz:"America/Regina"},{name:"Resolute Bay",tz:"America/Resolute"},{name:"Reykjavik",tz:"Atlantic/Reykjavik"},{name:"Riga",tz:"Europe/Riga"},{name:"Rio Branco",tz:"America/Rio_Branco"},{name:"Rio de Janeiro",tz:"America/Sao_Paulo"},{name:"Riyadh",tz:"Asia/Riyadh"},{name:"Rome",tz:"Europe/Rome"},{name:"Rovaniemi",tz:"Europe/Helsinki"},{name:"Saint-Denis",tz:"Indian/Reunion"},{name:"Salt Lake City",tz:"America/Denver"},{name:"Samara",tz:"Europe/Samara"},{name:"San Francisco",tz:"America/Los_Angeles"},{name:"San Jose",tz:"America/Los_Angeles"},{name:"San Juan",tz:"America/Puerto_Rico"},{name:"San Salvador",tz:"America/El_Salvador"},{name:"Sana",tz:"Asia/Aden"},{name:"Santiago",tz:"America/Santiago"},{name:"Santo Domingo",tz:"America/Santo_Domingo"},{name:"São Paulo",tz:"America/Sao_Paulo"},{name:"São Tomé",tz:"Africa/Sao_Tome"},{name:"Sarajevo",tz:"Europe/Sarajevo"},{name:"Seattle",tz:"America/Los_Angeles"},{name:"Seoul",tz:"Asia/Seoul"},{name:"Shanghai",tz:"Asia/Shanghai"},{name:"Singapore",tz:"Asia/Singapore"},{name:"Skopje",tz:"Europe/Skopje"},{name:"Sofia",tz:"Europe/Sofia"},{name:"Srednekolymsk",tz:"Asia/Srednekolymsk"},{name:"Sri Jayawardenepura Kotte",tz:"Asia/Colombo"},{name:"St. John's",tz:"America/St_Johns"},{name:"Stanley",tz:"Atlantic/Stanley"},{name:"Stockholm",tz:"Europe/Stockholm"},{name:"Sucre",tz:"America/La_Paz"},{name:"Suva",tz:"Pacific/Fiji"},{name:"Sydney",tz:"Australia/Sydney"},{name:"Taipei",tz:"Asia/Taipei"},{name:"Tallinn",tz:"Europe/Tallinn"},{name:"Tarawa",tz:"Pacific/Tarawa"},{name:"Tashkent",tz:"Asia/Tashkent"},{name:"Tbilisi",tz:"Asia/Tbilisi"},{name:"Tegucigalpa",tz:"America/Tegucigalpa"},{name:"Tehran",tz:"Asia/Tehran"},{name:"Tel Aviv",tz:"Asia/Jerusalem"},{name:"Thimphu",tz:"Asia/Thimphu"},{name:"Tiksi",tz:"Asia/Yakutsk"},{name:"Timbuktu",tz:"Africa/Bamako"},{name:"Tirana",tz:"Europe/Tirana"},{name:"Tokyo",tz:"Asia/Tokyo"},{name:"Toronto",tz:"America/Toronto"},{name:"Tórshavn",tz:"Atlantic/Faroe"},{name:"Tripoli",tz:"Africa/Tripoli"},{name:"Tromsø",tz:"Europe/Oslo"},{name:"Tunis",tz:"Africa/Tunis"},{name:"Ulaanbaatar",tz:"Asia/Ulaanbaatar"},{name:"Unalaska",tz:"America/Adak"},{name:"Ürümqi",tz:"Asia/Urumqi"},{name:"Valletta",tz:"Europe/Malta"},{name:"Vancouver",tz:"America/Vancouver"},{name:"Vatican City",tz:"Europe/Vatican"},{name:"Verkhoyansk",tz:"Asia/Vladivostok"},{name:"Victoria",tz:"Indian/Mahe"},{name:"Vienna",tz:"Europe/Vienna"},{name:"Vientiane",tz:"Asia/Vientiane"},{name:"Vilnius",tz:"Europe/Vilnius"},{name:"Vladivostok",tz:"Asia/Vladivostok"},{name:"Wake Island",tz:"Pacific/Wake"},{name:"Warsaw",tz:"Europe/Warsaw"},{name:"Washington DC",tz:"America/New_York"},{name:"Wellington",tz:"Pacific/Auckland"},{name:"Whitehorse",tz:"America/Whitehorse"},{name:"Windhoek",tz:"Africa/Windhoek"},{name:"Winnipeg",tz:"America/Winnipeg"},{name:"Yakutsk",tz:"Asia/Yakutsk"},{name:"Yamoussoukro",tz:"Africa/Abidjan"},{name:"Yangon",tz:"Asia/Yangon"},{name:"Yaoundé",tz:"Africa/Douala"},{name:"Yaren",tz:"Pacific/Nauru"},{name:"Yekaterinburg",tz:"Asia/Yekaterinburg"},{name:"Yerevan",tz:"Asia/Yerevan"},{name:"Yuzhno-Sakhalinsk",tz:"Asia/Sakhalin"},{name:"Zagreb",tz:"Europe/Zagreb"},{name:"Zürich",tz:"Europe/Zurich"}
    ];
    
    const dateTokens = [
        {val: 'day_name_full', txt: 'Day Name (Monday)'}, {val: 'day_name_short', txt: 'Day (Mon)'},
        {val: 'date_num', txt: 'Date (28)'}, {val: 'month_full', txt: 'Month Name'},
        {val: 'month_short', txt: 'Month (Jan)'}, {val: 'month_num', txt: 'Month (01)'},
        {val: 'year', txt: 'Year'}, {val: 'week_num', txt: 'Week #'},
        {val: 'day_year', txt: 'Day of Year'}, {val: 'quarter', txt: 'Quarter'},
        {val: 'separator', txt: 'Separator (|)'}, {val: 'space', txt: 'Space'}, {val: 'slash', txt: '/'}
    ];
    
    const colorPalette = [
        {val:'default', hex:'#000000', name:'Default (Black)'}, {val:'#5b5b5b', hex:'#5b5b5b', name:'Dark Grey'}, {val:'#7f8c8d', hex:'#7f8c8d', name:'Grey'},
        {val:'#bcbcbc', hex:'#bcbcbc', name:'Light Grey'}, {val:'#cc0000', hex:'#cc0000', name:'Dark Red'}, {val:'#fa2c1c', hex:'#fa2c1c', name:'Red'},
        {val:'#d35400', hex:'#d35400', name:'Pumpkin'}, {val:'#e67e22', hex:'#e67e22', name:'Orange'}, {val:'#f37736', hex:'#f37736', name:'Light Orange'},
        {val:'#f39c12', hex:'#f39c12', name:'Yellow Orange'}, {val:'#ffd700', hex:'#ffd700', name:'Gold'}, {val:'#ffe000', hex:'#ffe000', name:'Bright Yellow'},
        {val:'#8fce00', hex:'#8fce00', name:'Lime'}, {val:'#6aa84f', hex:'#6aa84f', name:'Medium Green'}, {val:'#27ae60', hex:'#27ae60', name:'Green'},
        {val:'#38761d', hex:'#38761d', name:'Forest Green'}, {val:'#16a085', hex:'#16a085', name:'Teal'}, {val:'#00ffff', hex:'#00ffff', name:'Cyan'},
        {val:'#3498db', hex:'#3498db', name:'Sky Blue'}, {val:'#2980b9', hex:'#2980b9', name:'Blue'}, {val:'#16537e', hex:'#16537e', name:'Dark Blue'},
        {val:'#34495e', hex:'#34495e', name:'Navy'}, {val:'#8e44ad', hex:'#8e44ad', name:'Purple'}, {val:'#800080', hex:'#800080', name:'Dark Purple'},
        {val:'#c90076', hex:'#c90076', name:'Magenta'}, {val:'#ffb6c1', hex:'#ffb6c1', name:'Pink'}, {val:'#b45f06', hex:'#b45f06', name:'Brown'},
        {val:'#783f04', hex:'#783f04', name:'Dark Brown'}
    ];

    // --- INIT ---
    function init() {
        try {
            const hash = window.location.hash.substring(1);
            if(hash) {
                const data = JSON.parse(decodeURIComponent(escape(window.atob(hash))));
                settings = data.settings || settings;
                blocks = data.blocks || blocks;
            } else {
                blocks = [{type: 'header', text: 'Welcome', width: 100, height: 100, id: 'b1'}];
            }
        } catch(e) {}
        
        // Sync Global Inputs
        document.getElementById('s-time').value = settings.use24h || '12';
        document.getElementById('s-week').value = settings.weekStart || 'monday';
        document.getElementById('s-theme').value = settings.theme || 'standard';
        document.getElementById('s-font').value = settings.font || 'sans';
        document.getElementById('s-size').value = settings.textSize || 'medium';
        document.getElementById('s-pad').value = settings.padding || 'comfortable';

        render();
        updateLink();
    }

    // --- RENDER ENGINE ---
    function render() {
        const canvas = document.getElementById('canvas');
        let html = '';
        
        blocks.forEach((b, i) => {
            if(!b.id) b.id = 'blk_' + Math.random().toString(36).substr(2,9);
            
            // Width
            let w = b.width || 100;
            let h = b.height || (b.type==='spacer' || b.type==='empty' ? 50 : 100);

            // Generate Preview Content
            let inner = '';
            // Basic preview logic to identify blocks
            if(b.type === 'header') inner = `<div class="txt-lg">${b.text}</div>`;
            else if(b.type === 'date_display') inner = `<div class="txt-lg">Monday</div><div class="txt-sm">Jan 01</div>`;
            else if(b.type === 'world_clock') {
                let cities = b.locations ? b.locations.length + ' Cities' : 'No Cities';
                inner = `<div class="txt-md">${cities}</div><div class="txt-lg">12:00</div>`;
            }
            else inner = `<div class="txt-sm" style="text-transform:uppercase;font-weight:bold;opacity:0.5">${b.type.replace('_',' ')}</div><div class="txt-md">${b.label||''}</div>`;

            let style = `width: calc(${w}% - 10px); height: ${h}px;`;
            if(b.color && b.color !== 'default') style += `border-left: 4px solid ${b.color};`;

            html += `
            <div class="widget-block" id="card-${i}" draggable="true" style="${style}" data-index="${i}">
                <div class="block-controls">
                    <div class="ctrl-btn" onclick="quickResize(${i})">↔</div>
                    <div class="ctrl-btn" onclick="editBlock(${i})">⚙️</div>
                    <div class="ctrl-btn ctrl-del" onclick="deleteBlock(${i})">✕</div>
                </div>
                <div class="widget-content">${inner}</div>
                <div class="resize-handle-w" onmousedown="initResize(${i}, 'w', event)"></div>
                <div class="resize-handle-h" onmousedown="initResize(${i}, 'h', event)"></div>
            </div>`;
        });
        
        canvas.innerHTML = html;
        addDragListeners();
    }

    // --- ACTIONS ---
    window.addBlock = (type) => {
        let b = { type: type, width: 50, height: 100, id: 'b_'+Date.now() };
        // Defaults
        if(type==='header') b.text = 'New Text';
        if(type==='world_clock') b.locations = [{label:'London', timezone:'Europe/London'}];
        if(type==='date_display') { b.line1=['day_name_full', 'space', 'date_num']; b.line2=['month_full', 'space', 'year']; }
        if(type==='progress_group') b.items = [{type:'life', label:'Life', visible:true},{type:'year', label:'Year', visible:true}];
        if(type==='sequence') b.steps = [{label:'Focus', duration:25}];
        if(type==='spacer' || type==='empty') b.height = 50;
        
        blocks.push(b);
        render(); updateLink();
        setTimeout(() => document.getElementById('canvas').scrollTop = document.getElementById('canvas').scrollHeight, 50);
    };

    window.deleteBlock = (i) => { blocks.splice(i, 1); render(); updateLink(); };
    
    window.quickResize = (i) => {
        const current = blocks[i].width || 100;
        if(current >= 100) blocks[i].width = 25;
        else if(current >= 75) blocks[i].width = 100;
        else if(current >= 50) blocks[i].width = 75;
        else blocks[i].width = 50;
        render(); updateLink();
    };

    // --- RESIZING LOGIC ---
    window.initResize = (i, mode, e) => {
        e.stopPropagation();
        resizingIndex = i; resizeMode = mode;
        startX = e.clientX; startY = e.clientY;
        const el = document.getElementById(`card-${i}`);
        startW = el.offsetWidth; startH = el.offsetHeight;
        document.body.style.cursor = mode === 'w' ? 'col-resize' : 'row-resize';
    };

    window.handleDrag = (e) => {
        if(resizingIndex === -1) return;
        const b = blocks[resizingIndex];
        const canvasW = document.getElementById('canvas').offsetWidth - 40; 
        
        if(resizeMode === 'w') {
            const diff = e.clientX - startX;
            let newPx = startW + diff;
            let newPct = (newPx / canvasW) * 100;
            if(newPct < 10) newPct = 10; if(newPct > 100) newPct = 100;
            b.width = newPct;
        } else {
            const diff = e.clientY - startY;
            let newH = startH + diff;
            if(newH < 30) newH = 30;
            b.height = newH;
        }
        render();
    };

    window.stopDrag = () => {
        if(resizingIndex !== -1) { resizingIndex = -1; document.body.style.cursor = 'default'; updateLink(); }
    };

    // --- DRAG & DROP ---
    let dragSrc = null;
    function addDragListeners() {
        const items = document.querySelectorAll('.widget-block');
        items.forEach(item => {
            item.addEventListener('dragstart', function(e) { dragSrc = this; e.dataTransfer.effectAllowed = 'move'; this.classList.add('dragging'); });
            item.addEventListener('dragend', function() { this.classList.remove('dragging'); });
            item.addEventListener('dragover', function(e) { e.preventDefault(); return false; });
            item.addEventListener('drop', function(e) {
                e.stopPropagation();
                if (dragSrc !== this) {
                    const srcIdx = parseInt(dragSrc.dataset.index);
                    const destIdx = parseInt(this.dataset.index);
                    const temp = blocks[srcIdx];
                    blocks.splice(srcIdx, 1);
                    blocks.splice(destIdx, 0, temp);
                    render(); updateLink();
                }
                return false;
            });
        });
    }

    // --- SETTINGS MODAL ---
    window.editBlock = (i) => {
        editingIndex = i;
        const b = blocks[i];
        const c = document.getElementById('modal-content');
        document.getElementById('modal-title').innerText = `Edit ${b.type.replace('_',' ')}`;
        
        let html = `<div class="form-group"><div class="row">
            <div class="col"><label>Width (%)</label><input type="number" id="in-width" value="${Math.round(b.width||100)}"></div>
            <div class="col"><label>Height (px)</label><input type="number" id="in-height" value="${Math.round(b.height||100)}"></div>
        </div></div>`;
        
        // Common Label
        if(!['spacer','empty'].includes(b.type)) {
           html += `<div class="form-group"><label>Label</label><input id="in-label" value="${b.label||''}"></div>`;
        }

        // TYPE SPECIFIC FIELDS
        if(b.type === 'header') {
            html += `<div class="form-group"><label>Text Content</label><input id="in-text" value="${b.text}"></div>`;
        }
        else if(b.type === 'world_clock') {
             html += `<div class="form-group"><label>Cities</label><div class="sub-list" id="mod-sub-list"></div><button class="btn-add-row" onclick="addModalCity()">+ Add City</button></div>`;
        }
        else if(b.type === 'date_display') {
             html += `<div class="form-group"><label>Line 1</label><div class="sub-list" id="mod-l1"></div><button class="btn-add-row" onclick="addDateToken('line1')">+ Element</button></div>
                      <div class="form-group"><label>Line 2</label><div class="sub-list" id="mod-l2"></div><button class="btn-add-row" onclick="addDateToken('line2')">+ Element</button></div>`;
        }
        else if(b.type === 'progress_group') {
             html += `<div class="form-group"><label>Progress Bars</label><div class="sub-list" id="mod-prog-list"></div></div>`;
        }
        else if(b.type === 'sequence') {
             html += `<div class="form-group"><label>Steps</label><div class="sub-list" id="mod-step-list"></div><button class="btn-add-row" onclick="addSequenceStep()">+ Step</button></div>`;
        }
        else if(b.type === 'visual_grid') {
             html += `<div class="form-group"><label>Grid Type</label><select id="in-gtype"><option value="year">Year</option><option value="month">Month</option><option value="life">Life</option></select></div>`;
        }
        else if(b.type === 'countdown') {
             html += `<div class="form-group"><label>Date</label><input type="date" id="in-date" value="${b.date||''}"></div>
                      <div class="form-group"><label>Include Time</label><input type="checkbox" id="in-inctime" ${b.includeTime?'checked':''}></div>`;
        }
        
        // Colors
        html += `<div class="form-group"><div class="row">
            <div class="col"><label>Accent Color</label><select id="in-color">${getColorOpts(b.color)}</select>
            <input type="color" id="in-color-hex" value="${b.color||'#000000'}" style="margin-top:5px;height:30px;padding:0;"></div>
            <div class="col"><label>Text Color</label><select id="in-tcolor">${getColorOpts(b.textColor)}</select>
            <input type="color" id="in-tcolor-hex" value="${b.textColor||'#37352f'}" style="margin-top:5px;height:30px;padding:0;"></div>
        </div></div>`;
        
        c.innerHTML = html;
        
        // Render Sub-Lists
        if(b.type === 'world_clock') renderModalCities(b.locations);
        if(b.type === 'date_display') { renderModalDateTokens('mod-l1', b.line1); renderModalDateTokens('mod-l2', b.line2); }
        if(b.type === 'progress_group') renderModalProgress(b.items);
        if(b.type === 'sequence') renderModalSequence(b.steps);
        if(b.type === 'visual_grid') document.getElementById('in-gtype').value = b.gridType;

        document.getElementById('modal-overlay').style.display = 'flex';
    };

    window.saveModal = () => {
        const b = blocks[editingIndex];
        // Save Dimensions
        b.width = parseFloat(document.getElementById('in-width').value) || 100;
        b.height = parseFloat(document.getElementById('in-height').value) || 100;
        
        // Save Common
        const lbl = document.getElementById('in-label'); if(lbl) b.label = lbl.value;
        const txt = document.getElementById('in-text'); if(txt) b.text = txt.value;
        
        // Save Colors (Priority to hex if default not selected)
        b.color = document.getElementById('in-color').value;
        b.textColor = document.getElementById('in-tcolor').value;

        // Specifics
        if(b.type === 'visual_grid') b.gridType = document.getElementById('in-gtype').value;
        if(b.type === 'countdown') {
             b.date = document.getElementById('in-date').value;
             b.includeTime = document.getElementById('in-inctime').checked;
        }

        render(); updateLink();
        closeModal();
    };

    window.closeModal = () => document.getElementById('modal-overlay').style.display = 'none';

    function getColorOpts(sel) {
        return colorPalette.map(c => `<option value="${c.hex}" ${sel===c.hex?'selected':''}>${c.name}</option>`).join('');
    }

    // --- MODAL SUB-FUNCTIONS (The V59 Logic) ---
    // CITIES
    window.renderModalCities = (locs) => {
        const c = document.getElementById('mod-sub-list'); c.innerHTML = '';
        locs.forEach((loc, i) => {
            c.innerHTML += `<div class="sub-item">
                <input value="${loc.label}" oninput="blocks[editingIndex].locations[${i}].label=this.value" placeholder="Label">
                <button class="btn-mini btn-mini-del" onclick="removeModalItem('locations', ${i})">×</button>
            </div>`;
        });
    };
    window.addModalCity = () => { blocks[editingIndex].locations.push({label:'New City', timezone:'UTC'}); editBlock(editingIndex); };

    // DATES
    window.renderModalDateTokens = (id, tokens) => {
        const c = document.getElementById(id); c.innerHTML = '';
        tokens.forEach((t, i) => {
            let val = typeof t === 'string' ? t : t.type;
            let selHtml = dateTokens.map(dt => `<option value="${dt.val}" ${val===dt.val?'selected':''}>${dt.txt}</option>`).join('');
            c.innerHTML += `<div class="sub-item">
                <select onchange="updateDateToken('${id==='mod-l1'?'line1':'line2'}', ${i}, this.value)">${selHtml}</select>
                <button class="btn-mini btn-mini-del" onclick="removeDateToken('${id==='mod-l1'?'line1':'line2'}', ${i})">×</button>
            </div>`;
        });
    };
    window.updateDateToken = (line, i, val) => { blocks[editingIndex][line][i] = val; };
    window.addDateToken = (line) => { blocks[editingIndex][line].push('space'); editBlock(editingIndex); };
    window.removeDateToken = (line, i) => { blocks[editingIndex][line].splice(i, 1); editBlock(editingIndex); };
    
    // PROGRESS
    window.renderModalProgress = (items) => {
        const c = document.getElementById('mod-prog-list'); c.innerHTML = '';
        items.forEach((item, i) => {
            c.innerHTML += `<div class="sub-item">
                <input type="checkbox" style="width:auto" ${item.visible!==false?'checked':''} onchange="blocks[editingIndex].items[${i}].visible=this.checked">
                <span style="font-size:0.8rem; width:60px;">${item.type}</span>
                <input value="${item.label}" oninput="blocks[editingIndex].items[${i}].label=this.value">
            </div>`;
        });
    };

    // SEQUENCE
    window.renderModalSequence = (steps) => {
        const c = document.getElementById('mod-step-list'); c.innerHTML = '';
        steps.forEach((s, i) => {
            c.innerHTML += `<div class="sub-item">
                <input value="${s.label}" placeholder="Step" oninput="blocks[editingIndex].steps[${i}].label=this.value">
                <input type="number" value="${s.duration}" placeholder="Min" style="width:60px" oninput="blocks[editingIndex].steps[${i}].duration=this.value">
                <button class="btn-mini btn-mini-del" onclick="removeModalItem('steps', ${i})">×</button>
            </div>`;
        });
    };
    window.addSequenceStep = () => { blocks[editingIndex].steps.push({label:'New Step', duration:10}); editBlock(editingIndex); };
    
    window.removeModalItem = (arrName, i) => { blocks[editingIndex][arrName].splice(i, 1); editBlock(editingIndex); };

    // --- GLOBAL ---
    window.updateGlobal = () => {
        settings.use24h = document.getElementById('s-time').value;
        settings.weekStart = document.getElementById('s-week').value;
        settings.theme = document.getElementById('s-theme').value;
        settings.font = document.getElementById('s-font').value;
        settings.textSize = document.getElementById('s-size').value;
        settings.padding = document.getElementById('s-pad').value;
        updateLink();
    };

    window.togglePanel = (id) => document.getElementById(id).classList.toggle('open');

    window.updateLink = () => {
        const json = JSON.stringify({ settings, blocks });
        const hash = window.btoa(unescape(encodeURIComponent(json)));
        const url = window.location.href.split('#')[0].replace('admin.html', 'index.html');
        document.getElementById('result-url').value = `${url}#${hash}`;
        window.history.replaceState(null, null, `#${hash}`);
    };
    
    window.refresh = () => render();
    window.copyLink = () => { document.getElementById('result-url').select(); document.navigator.clipboard.writeText(document.getElementById('result-url').value); };
    window.openLink = () => window.open(document.getElementById('result-url').value, '_blank');

    init();
</script>
</body>
</html>
