<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Widget Builder - Admin</title>
    <style>
        :root {
            --bg: #ffffff; --text: #37352f; --accent: #2eaadc;
            --grid-gap: 15px; --sidebar-w: 300px;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, sans-serif; margin: 0; background: #f7f6f3; color: var(--text); overflow-x: hidden; }
        
        /* Layout */
        #header { background: #fff; border-bottom: 1px solid #e9e9e8; transition: max-height 0.3s ease; overflow: hidden; }
        #header.collapsed { max-height: 40px; }
        .header-handle { background: #37352f; color: #fff; padding: 5px 10px; cursor: pointer; font-size: 12px; text-align: center; }
        .config-bar { padding: 15px; display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        
        #canvas { 
            display: grid; grid-template-columns: repeat(12, 1fr); gap: var(--grid-gap); 
            padding: 20px; padding-bottom: 120px; min-height: 80vh; max-width: 1200px; margin: 0 auto;
        }

        #footer-dock { 
            position: fixed; bottom: 0; left: 0; right: 0; background: #fff; 
            border-top: 1px solid #e9e9e8; padding: 10px; display: flex; 
            overflow-x: auto; gap: 10px; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        /* Blocks */
        .block-wrapper { 
            background: #fff; border-radius: 8px; border: 1px solid #e9e9e8; 
            position: relative; min-height: 50px; transition: box-shadow 0.2s;
            grid-column: span 12; /* Default */
        }
        .block-wrapper:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .controls { position: absolute; top: 5px; right: 5px; display: none; gap: 5px; z-index: 10; }
        .block-wrapper:hover .controls { display: flex; }
        .btn-small { padding: 2px 6px; cursor: pointer; font-size: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px; }
        
        /* Resize Handles */
        .handle-r { position: absolute; right: 0; top: 0; bottom: 0; width: 10px; cursor: ew-resize; }
        .handle-b { position: absolute; bottom: 0; left: 0; right: 0; height: 10px; cursor: ns-resize; }

        /* Modal & Warehouse */
        #modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            display: none; justify-content: center; align-items: center; z-index: 2000; 
        }
        #modal-content { background: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; }
        #warehouse { display: none; }
        
        .url-box { width: 100%; height: 60px; font-family: monospace; font-size: 11px; margin-bottom: 10px; }
        
        /* Block Specific CSS */
        .token-chip { display: inline-block; background: #eee; padding: 2px 6px; margin: 2px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

<div id="header">
    <div class="header-handle" onclick="document.getElementById('header').classList.toggle('collapsed')">General Settings / URL Generator (Click to Toggle)</div>
    <div class="config-bar">
        <div style="flex: 1; min-width: 300px;">
            <label>Live Widget URL:</label><br>
            <textarea id="output-url" class="url-box" readonly></textarea>
            <button onclick="copyUrl()">Copy URL</button>
            <button onclick="openUrl()">Open Viewer</button>
        </div>
        <div>
            <label>Font:</label>
            <select id="global-font" onchange="updateGlobal()">
                <option value="sans-serif">Sans</option>
                <option value="serif">Serif</option>
                <option value="monospace">Mono</option>
            </select>
        </div>
    </div>
</div>

<div id="canvas"></div>

<div id="footer-dock">
    <button onclick="addBlock('header')">+ Header</button>
    <button onclick="addBlock('date')">+ Date</button>
    <button onclick="addBlock('clock')">+ Clock</button>
    <button onclick="addBlock('life')">+ Life Grid</button>
    <button onclick="addBlock('moon')">+ Moon</button>
    <button onclick="addBlock('spacer')">+ Spacer</button>
</div>

<div id="modal-overlay">
    <div id="modal-content">
        <div id="modal-mount"></div>
        <hr>
        <button onclick="closeModal()">Close & Save</button>
    </div>
</div>

<div id="warehouse">
    <div id="form-header">
        <label>Text Content:</label>
        <input type="text" data-prop="content" class="form-update">
    </div>
    <div id="form-spacer">
        <label>Height (px):</label>
        <input type="number" data-prop="h" step="10" class="form-update">
    </div>
    <div id="form-life">
        <label>Birth Date:</label>
        <input type="date" data-prop="dob" class="form-update">
        <label>Expectancy:</label>
        <input type="number" data-prop="years" class="form-update">
    </div>
    </div>

<script>
/** * SHARED RENDERING ENGINE 
 * (This logic is identical in index.html)
 */
const Engine = {
    render(block) {
        let html = `<div style="padding:15px; background:${block.colors?.bg || '#fff'}; color:${block.colors?.text || '#000'}; height:100%; border-radius:inherit; box-sizing:border-box;">`;
        
        switch(block.type) {
            case 'header': 
                html += `<h2 style="margin:0">${block.content || 'Header'}</h2>`; 
                break;
            case 'life':
                const dob = new Date(block.dob || '1990-01-01');
                const diff = new Date() - dob;
                const weeksLived = Math.floor(diff / (1000 * 60 * 60 * 24 * 7));
                const totalWeeks = (block.years || 80) * 52;
                html += `<div>Life Progress</div><div style="display:grid; grid-template-columns:repeat(52, 1fr); gap:1px; margin-top:5px;">`;
                for(let i=0; i<totalWeeks; i++) {
                    const color = i < weeksLived ? (block.colors?.accent || '#37352f') : '#e9e9e8';
                    html += `<div style="width:100%; aspect-ratio:1; background:${color}"></div>`;
                }
                html += `</div>`;
                break;
            case 'moon':
                html += `<div style="font-size:2em; text-align:center;">${this.getMoonPhase()}</div>`;
                break;
            case 'spacer':
                html += `<div style="height:${block.h}px"></div>`;
                break;
            default: html += `Block: ${block.type}`;
        }
        html += `</div>`;
        return html;
    },
    getMoonPhase() {
        const phases = ['ðŸŒ‘','ðŸŒ’','ðŸŒ“','ðŸŒ”','ðŸŒ•','ðŸŒ–','ðŸŒ—','ðŸŒ˜'];
        const d = new Date();
        const day = d.getDate();
        return phases[day % 8]; // Simplified for demo
    }
};

/** ADMIN STATE MANAGEMENT **/
let state = {
    settings: { font: 'sans-serif' },
    blocks: []
};

let activeBlockId = null;

function addBlock(type) {
    const id = 'b' + Date.now();
    state.blocks.push({ id, type, content: 'New Block', w: 6, h: 100, colors: {bg: '#ffffff', text: '#37352f', accent: '#2eaadc'} });
    updateUI();
}

function updateUI() {
    const canvas = document.getElementById('canvas');
    canvas.innerHTML = '';
    
    state.blocks.forEach(block => {
        const wrapper = document.createElement('div');
        wrapper.className = 'block-wrapper';
        wrapper.style.gridColumn = `span ${block.w}`;
        wrapper.innerHTML = `
            <div class="controls">
                <button class="btn-small" onclick="editBlock('${block.id}')">Edit</button>
                <button class="btn-small" onclick="removeBlock('${block.id}')">X</button>
            </div>
            ${Engine.render(block)}
            <div class="handle-r" onmousedown="initResize(event, '${block.id}', 'w')"></div>
            <div class="handle-b" onmousedown="initResize(event, '${block.id}', 'h')"></div>
        `;
        canvas.appendChild(wrapper);
    });
    
    // Update Hash
    const hash = btoa(JSON.stringify(state));
    window.location.hash = hash;
    document.getElementById('output-url').value = window.location.origin + '/index.html#' + hash;
}

function editBlock(id) {
    activeBlockId = id;
    const block = state.blocks.find(b => b.id === id);
    const mount = document.getElementById('modal-mount');
    const form = document.getElementById(`form-${block.type}`);
    
    if (form) {
        // Hydrate form
        form.querySelectorAll('.form-update').forEach(input => {
            input.value = block[input.dataset.prop] || '';
        });
        mount.appendChild(form);
        document.getElementById('modal-overlay').style.display = 'flex';
    }
}

function closeModal() {
    const block = state.blocks.find(b => b.id === activeBlockId);
    const mount = document.getElementById('modal-mount');
    const form = mount.firstElementChild;
    
    if (form) {
        form.querySelectorAll('.form-update').forEach(input => {
            block[input.dataset.prop] = input.value;
        });
        document.getElementById('warehouse').appendChild(form);
    }
    
    document.getElementById('modal-overlay').style.display = 'none';
    updateUI();
}

function removeBlock(id) {
    state.blocks = state.blocks.filter(b => b.id !== id);
    updateUI();
}

// Resizing Logic
function initResize(e, id, dir) {
    e.preventDefault();
    const block = state.blocks.find(b => b.id === id);
    const startX = e.clientX;
    const startW = block.w;
    
    const onMove = (moveEvent) => {
        if (dir === 'w') {
            const diff = moveEvent.clientX - startX;
            const gridWidth = document.getElementById('canvas').offsetWidth / 12;
            const newW = Math.max(1, Math.min(12, Math.round(startW + diff / gridWidth)));
            block.w = newW;
        }
        updateUI();
    };
    
    const onUp = () => {
        window.removeEventListener('mousemove', onMove);
        window.removeEventListener('mouseup', onUp);
    };
    
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onUp);
}

function copyUrl() {
    const el = document.getElementById('output-url');
    el.select();
    document.execCommand('copy');
    alert('URL Copied!');
}

function openUrl() {
    window.open(document.getElementById('output-url').value, '_blank');
}

// Initial Load
if (window.location.hash) {
    try {
        state = JSON.parse(atob(window.location.hash.substring(1)));
        updateUI();
    } catch(e) { console.error("Hash load failed", e); }
}
</script>
</body>
</html>
