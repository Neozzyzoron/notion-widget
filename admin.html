<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Admin V71</title>
    <style>
        /* CORE */
        * { box-sizing: border-box; }
        :root { --bg-canvas: #f4f5f7; --font: sans-serif; --c-acc: #34495e; }
        html, body { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-canvas); color: #333; overflow: hidden; }
        
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        
        /* HEADER */
        .app-header { background: #fff; border-bottom: 1px solid #ddd; z-index: 200; flex-shrink: 0; position: relative; }
        .header-bar { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; background: #fff; }
        .header-title { font-weight: 700; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; gap: 8px; user-select: none; }
        .arrow { font-size: 0.8em; color: #999; transition: transform 0.2s; }
        .arrow.open { transform: rotate(180deg); }
        .header-actions { display: flex; gap: 8px; }
        
        /* GENERAL SETTINGS (Dark Mode when collapsed) */
        .settings-toggle { background: #2c3e50; color: white; padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 0.9rem; }
        .settings-toggle:hover { background: #34495e; }
        
        .panel { overflow: hidden; max-height: 0; transition: max-height 0.3s ease-out; background: #fff; border-bottom: 1px solid #ddd; }
        .panel.open { max-height: 400px; overflow-y: auto; }
        .panel-content { padding: 15px; }
        .panel-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .panel label { font-size: 0.7rem; font-weight: 700; color: #7f8c8d; text-transform: uppercase; display: block; margin-bottom: 4px; }
        
        /* LINK BOX */
        .link-textarea { width: 100%; height: 60px; font-family: monospace; font-size: 0.75rem; border: 1px solid #ddd; padding: 8px; background: #f9f9f9; resize: none; word-break: break-all; white-space: normal; }

        /* CANVAS (Block Space) */
        .canvas-area { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 20px; 
            padding-bottom: 140px; /* Space for Footer */
            position: relative; 
            background: #f4f5f7;
        }
        .canvas-watermark { position: absolute; top: 20px; left: 20px; font-size: 0.9rem; font-weight: 700; color: #cbd5e0; text-transform: uppercase; pointer-events: none; letter-spacing: 1px; }
        
        /* GRID LAYOUT FOR BLOCKS (Replacing simple flex for better stacking) */
        #canvas {
            display: flex; 
            flex-wrap: wrap; 
            align-content: flex-start;
            gap: 10px;
            min-height: 300px;
        }

        /* BLOCK ITEM */
        .widget-block {
            position: relative;
            background: #fff;
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            min-height: 60px;
            display: flex; flex-direction: column;
            transition: all 0.15s;
            overflow: hidden;
        }
        .widget-block:hover { border-color: #3498db; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 10; }
        .widget-block.dragging { opacity: 0.5; transform: scale(0.98); border-style: solid; }
        
        /* INNER CONTENT */
        .block-inner {
            flex-grow: 1; padding: 10px; pointer-events: none;
            display: flex; flex-direction: column; justify-content: center;
            overflow: hidden;
        }
        
        /* RESIZE HANDLES */
        .handle-w { position: absolute; top: 0; bottom: 10px; right: 0; width: 12px; cursor: col-resize; z-index: 20; }
        .handle-h { position: absolute; bottom: 0; left: 0; right: 0; height: 12px; cursor: row-resize; z-index: 20; }
        .handle-w:hover, .handle-h:hover { background: rgba(52, 152, 219, 0.2); }

        /* CONTROLS */
        .block-controls { position: absolute; top: 5px; right: 5px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; z-index: 25; }
        .widget-block:hover .block-controls { opacity: 1; }
        .ctrl-btn { width: 26px; height: 26px; border-radius: 4px; background: #fff; border: 1px solid #ccc; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #555; }
        .ctrl-btn:hover { background: #f0f0f0; }
        .ctrl-del { color: #c0392b; background: #fadbd8; border-color: #e6b0aa; }

        /* FOOTER (Sticky) */
        .app-footer { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: #fff; border-top: 1px solid #ccc; 
            padding: 12px 20px; z-index: 500; 
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05); 
        }
        .footer-scroll { overflow-x: auto; white-space: nowrap; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .footer-buttons { display: inline-flex; gap: 8px; }
        .add-btn { padding: 8px 14px; border: none; border-radius: 4px; font-weight: 600; font-size: 0.75rem; color: white; cursor: pointer; transition: transform 0.1s; }
        .add-btn:hover { transform: translateY(-2px); opacity: 0.9; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-card { background: white; width: 95%; max-width: 500px; border-radius: 8px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; background: #f8f9fa; font-weight: 700; display: flex; justify-content: space-between; align-items: center; font-size: 1rem; }
        .modal-body { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; text-align: right; background: #fff; }

        /* FORM ELEMENTS */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.75rem; font-weight: 700; color: #666; text-transform: uppercase; }
        input[type="text"], input[type="number"], input[type="date"], select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; }
        .row { display: flex; gap: 10px; } .col { flex: 1; }
        
        /* COLORS */
        .c-text { background: #7f8c8d; } .c-date { background: #16a085; } .c-time { background: #27ae60; }
        .c-grid { background: #6aa84f; } .c-auto { background: #c0392b; } .c-custom { background: #d35400; }
        .c-cycle { background: #e67e22; } .c-count { background: #f39c12; } .c-timer { background: #8e44ad; }
        .c-seq { background: #9b59b6; } .c-cnt { background: #c90076; } .c-moon { background: #34495e; }
        .c-util { background: #95a5a6; }
        
        /* SUB ITEMS (V59 Style) */
        .sub-list { border: 1px solid #eee; border-radius: 4px; padding: 10px; background: #fafafa; margin-bottom: 10px; }
        .sub-item { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; background: #fff; padding: 6px; border: 1px solid #eee; border-radius: 4px; }
        .sub-item:last-child { margin-bottom: 0; }
        .btn-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: 1px solid #ccc; border-radius: 4px; background: #fff; cursor: pointer; color: #555; }
        .btn-icon:hover { background: #f0f0f0; }
        .btn-del-sub { color: #c0392b; border-color: #e6b0aa; background: #fadbd8; }
        .btn-add-sub { width: 100%; padding: 8px; border: 1px dashed #ccc; background: #f9f9f9; color: #666; font-weight: 600; cursor: pointer; border-radius: 4px; }
        .btn-add-sub:hover { background: #eee; }

        /* CITY SEARCH */
        .city-search-box { position: relative; }
        .city-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; max-height: 150px; overflow-y: auto; z-index: 2000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .city-opt { padding: 8px; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f0f0f0; }
        .city-opt:hover { background: #f5f5f5; }

        /* HELPER CLASSES */
        .hidden { display: none !important; }
        
        /* PREVIEW TYPOGRAPHY (Shared) */
        .txt-lg { font-size: 1.5em; font-weight: 700; line-height: 1.1; }
        .txt-sub { font-size: 0.85em; opacity: 0.7; }
        .txt-lbl { font-size: 0.7em; text-transform: uppercase; font-weight: 700; opacity: 0.5; margin-bottom: 3px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="app-header">
        <div class="header-bar">
            <div class="header-title" onclick="togglePanel('link-panel')">
                <span class="arrow" id="arr-link">▼</span> Link Generator
            </div>
            <div class="header-actions">
                <button class="btn btn-blue" style="padding:6px 12px" onclick="refresh()">Ref</button>
                <button class="btn btn-green" style="padding:6px 12px" onclick="copyLink()">Copy</button>
                <button class="btn btn-grey" style="padding:6px 12px" onclick="openLink()">Open</button>
            </div>
        </div>
        <div id="link-panel" class="panel">
            <div class="panel-content">
                <textarea class="link-textarea" id="result-url" readonly onclick="this.select()"></textarea>
            </div>
        </div>
        
        <div class="settings-toggle" onclick="togglePanel('settings-panel')">
            <span class="arrow" id="arr-set">▼</span> General Settings
        </div>
        <div id="settings-panel" class="panel">
            <div class="panel-content panel-grid">
                <div><label>Time Format</label><select id="s-time" onchange="updateGlobal()"><option value="12">12 Hour</option><option value="24">24 Hour</option></select></div>
                <div><label>Week Start</label><select id="s-week" onchange="updateGlobal()"><option value="monday">Monday</option><option value="sunday">Sunday</option></select></div>
                <div><label>Theme</label><select id="s-theme" onchange="updateGlobal()"><option value="standard">Standard</option><option value="card">Cards</option><option value="minimal">Minimal</option></select></div>
                <div><label>Font</label><select id="s-font" onchange="updateGlobal()"><option value="sans">Sans-Serif</option><option value="serif">Serif</option><option value="mono">Monospace</option></select></div>
                <div><label>Size</label><select id="s-size" onchange="updateGlobal()"><option value="medium">Medium</option><option value="small">Small</option><option value="large">Large</option></select></div>
                <div><label>Padding</label><select id="s-pad" onchange="updateGlobal()"><option value="comfortable">Normal</option><option value="compact">Compact</option><option value="spacious">Spacious</option></select></div>
            </div>
        </div>
    </div>

    <div class="canvas-area">
        <div class="canvas-watermark">Block Space</div>
        <div id="canvas" onmousemove="handleDrag(event)" onmouseup="stopDrag()"></div>
    </div>

    <div class="app-footer">
        <div class="footer-label">Add Block</div>
        <div class="footer-scroll">
            <div class="footer-buttons">
                <button class="add-btn c-text" onclick="addBlock('header')">Text</button>
                <button class="add-btn c-date" onclick="addBlock('date_display')">Date</button>
                <button class="add-btn c-time" onclick="addBlock('world_clock')">Time</button>
                <button class="add-btn c-grid" onclick="addBlock('visual_grid')">Grid</button>
                <button class="add-btn c-auto" onclick="addBlock('progress_group')">Auto Progress</button>
                <button class="add-btn c-custom" onclick="addBlock('progress_custom')">Custom Progress</button>
                <button class="add-btn c-cycle" onclick="addBlock('progress_cycle')">Cycle</button>
                <button class="add-btn c-count" onclick="addBlock('countdown')">Countdown</button>
                <button class="add-btn c-timer" onclick="addBlock('timer')">Timer</button>
                <button class="add-btn c-seq" onclick="addBlock('sequence')">Sequence</button>
                <button class="add-btn c-cnt" onclick="addBlock('counter')">Counter</button>
                <button class="add-btn c-moon" onclick="addBlock('moon_phase')">Moon Phase</button>
                <button class="add-btn c-util" onclick="addBlock('spacer')">Spacer</button>
                <button class="add-btn c-util" onclick="addBlock('empty')">Empty Block</button>
            </div>
        </div>
    </div>
</div>

<div id="templates" class="hidden">
    <div id="tpl-colors">
        <div class="form-group"><label>Colors</label>
            <div class="row">
                <div class="col"><label style="font-size:0.6rem">Background</label><select class="c-sel" data-target="bgColor"></select><input type="color" class="c-pick" data-target="bgColor" style="height:30px;padding:0"></div>
                <div class="col"><label style="font-size:0.6rem">Text</label><select class="c-sel" data-target="textColor"></select><input type="color" class="c-pick" data-target="textColor" style="height:30px;padding:0"></div>
                <div class="col"><label style="font-size:0.6rem">Accent</label><select class="c-sel" data-target="accentColor"></select><input type="color" class="c-pick" data-target="accentColor" style="height:30px;padding:0"></div>
            </div>
        </div>
    </div>
    
    <div id="tpl-time">
        <div class="form-group"><label>Toggles</label>
            <div style="display:flex; gap:10px">
                <label><input type="checkbox" data-key="showSeconds"> Seconds</label>
                <label><input type="checkbox" data-key="showDate"> Date</label>
                <label><input type="checkbox" data-key="showTimezone"> Timezone</label>
            </div>
        </div>
        <div class="form-group"><label>Cities</label><div class="sub-list" id="mod-city-list"></div>
            <div class="city-search-box"><input id="city-input" placeholder="Search City..."><div class="city-dropdown" id="city-results"></div></div>
        </div>
    </div>

    <div id="tpl-date">
        <div class="form-group"><label>Line 1</label><div class="sub-list" id="mod-l1"></div><button class="btn-add-sub" onclick="addDateToken('line1')">+ Element</button></div>
        <div class="form-group"><label>Line 2</label><div class="sub-list" id="mod-l2"></div><button class="btn-add-sub" onclick="addDateToken('line2')">+ Element</button></div>
    </div>
</div>

<div class="modal-overlay" id="modal-overlay">
    <div class="modal-card">
        <div class="modal-header"><span id="modal-title">Settings</span><span style="cursor:pointer" onclick="closeModal()">✕</span></div>
        <div class="modal-body">
            <div class="form-group"><div class="row">
                <div class="col"><label>Width (%)</label><input type="number" id="in-w"></div>
                <div class="col"><label>Height (px)</label><input type="number" id="in-h"></div>
            </div></div>
            <div class="form-group" id="wrap-label"><label>Label</label><input type="text" id="in-label"></div>
            <div class="form-group" id="wrap-text" style="display:none"><label>Text Content</label><input type="text" id="in-text"></div>
            
            <div id="modal-dynamic"></div>
            
            <div id="modal-colors"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-blue" onclick="saveModal()">Done</button></div>
    </div>
</div>

<script>
    // --- STATE ---
    let settings = { use24h: '12', weekStart: 'monday', theme: 'standard', font: 'sans', textSize: 'medium', padding: 'comfortable' };
    let blocks = [];
    let editingIdx = -1;
    let resizingIdx = -1;
    let resizeMode = ''; let startX, startY, startW, startH;

    // --- DB ---
    const cityDB = [ {name:"London",tz:"Europe/London"},{name:"New York",tz:"America/New_York"},{name:"Tokyo",tz:"Asia/Tokyo"},{name:"Paris",tz:"Europe/Paris"},{name:"Sydney",tz:"Australia/Sydney"},{name:"Dubai",tz:"Asia/Dubai"},{name:"Berlin",tz:"Europe/Berlin"},{name:"Singapore",tz:"Asia/Singapore"},{name:"Los Angeles",tz:"America/Los_Angeles"} ];
    const colorPalette = [ {val:'default', hex:'#ffffff', name:'Default'}, {val:'#34495e', hex:'#34495e', name:'Navy'}, {val:'#3498db', hex:'#3498db', name:'Blue'}, {val:'#27ae60', hex:'#27ae60', name:'Green'}, {val:'#c0392b', hex:'#c0392b', name:'Red'}, {val:'#f39c12', hex:'#f39c12', name:'Orange'}, {val:'#8e44ad', hex:'#8e44ad', name:'Purple'}, {val:'#7f8c8d', hex:'#7f8c8d', name:'Grey'} ];
    const dateTokens = [ {v:'day_name_full',t:'Day Name'}, {v:'date_num',t:'Date'}, {v:'month_full',t:'Month'}, {v:'year',t:'Year'}, {v:'space',t:'Space'}, {v:'separator',t:'|'} ];

    // --- CORE ---
    function init() {
        try {
            const h = window.location.hash.substring(1);
            if(h) {
                const d = JSON.parse(decodeURIComponent(escape(window.atob(h))));
                settings = d.settings || settings; blocks = d.blocks || blocks;
            } else { blocks = [{type:'header', text:'Welcome', width:50, height:100, id:'b1'}]; }
        } catch(e) {}
        
        // Sync Global
        ['s-time','s-week','s-theme','s-font','s-size','s-pad'].forEach(id => {
            let key = id.replace('s-',''); if(key==='time') key='use24h'; if(key==='size') key='textSize'; if(key==='week') key='weekStart';
            document.getElementById(id).value = settings[key] || (key==='use24h'?'12':'standard');
        });
        
        updateGlobalStyles(); render(); updateLink();
    }

    function render() {
        const cvs = document.getElementById('canvas');
        cvs.innerHTML = '';
        
        blocks.forEach((b, i) => {
            if(!b.id) b.id = 'blk_'+Date.now();
            
            const div = document.createElement('div');
            div.className = 'widget-block';
            div.id = `card-${i}`;
            div.draggable = true;
            div.dataset.index = i;
            div.style.width = `calc(${b.width}% - 10px)`;
            div.style.height = `${b.height}px`;
            
            // 3-Tier Colors
            let bg = b.bgColor || '#ffffff';
            let txt = b.textColor || '#333333';
            if(b.type === 'empty') { bg = 'transparent'; div.style.borderStyle = 'dashed'; div.style.opacity = '0.5'; }
            
            // Content
            let inner = `<div class="block-inner" style="background:${bg}; color:${txt}">
                ${renderBlockContent(b)}
            </div>`;
            
            div.innerHTML = `
                <div class="block-controls">
                    <div class="ctrl-btn" onclick="resizeCyc(${i})">↔</div>
                    <div class="ctrl-btn" onclick="openModal(${i})">⚙️</div>
                    <div class="ctrl-btn ctrl-del" onclick="delBlock(${i})">✕</div>
                </div>
                ${inner}
                <div class="handle-w" onmousedown="initResize(${i},'w',event)"></div>
                <div class="handle-h" onmousedown="initResize(${i},'h',event)"></div>
            `;
            cvs.appendChild(div);
        });
        
        bindDrag();
    }

    // --- SHARED LOGIC ---
    function renderBlockContent(b) {
        let h = '';
        let acc = b.accentColor || '#3498db';
        if(b.type==='header') h = `<div class="txt-lg">${b.text}</div>`;
        else if(b.type==='world_clock') {
            if(b.locations) b.locations.forEach(l => {
                let ts = new Date().toLocaleTimeString('en-US', {timeZone:l.timezone, hour:settings.use24h=='24'?'2-digit':'numeric', minute:'2-digit'});
                h += `<div style="display:flex;justify-content:space-between;width:100%;font-size:0.9em;border-bottom:1px solid rgba(0,0,0,0.05)"><span>${l.label}</span><span style="font-weight:700">${ts}</span></div>`;
            });
        }
        else if(b.type==='date_display') {
            h = `<div class="txt-lg">Monday</div><div class="txt-sub">Jan 01</div>`; // Preview
        }
        else if(b.type==='empty') h = '';
        else h = `<div class="txt-lbl">${b.type.replace('_',' ')}</div><div class="txt-lg">${b.label||''}</div>`;
        return h;
    }

    // --- ACTIONS ---
    window.addBlock = (t) => {
        let b = { type: t, width: 50, height: 100, id:'b_'+Date.now() };
        if(t==='header') { b.text = 'Text'; b.height = 60; }
        if(t==='world_clock') { b.locations = [{label:'London',timezone:'Europe/London'}]; b.height = 100; b.showSeconds=false; b.showDate=true; }
        if(t==='date_display') { b.line1=['day_name_full']; b.line2=['date_num','month_full']; b.height=80; }
        if(t==='empty') b.height = 50;
        blocks.push(b); render(); updateLink();
        // Scroll
        const area = document.querySelector('.canvas-area');
        setTimeout(() => area.scrollTop = area.scrollHeight, 50);
    };
    window.delBlock = (i) => { blocks.splice(i, 1); render(); updateLink(); };
    window.resizeCyc = (i) => {
        let w = blocks[i].width || 50;
        blocks[i].width = w >= 100 ? 25 : w >= 75 ? 100 : w >= 50 ? 75 : 50;
        render(); updateLink();
    };

    // --- RESIZE ---
    window.initResize = (i, m, e) => {
        e.stopPropagation(); resizingIndex = i; resizeMode = m;
        startX = e.clientX; startY = e.clientY;
        const el = document.getElementById(`card-${i}`);
        startW = el.offsetWidth; startH = el.offsetHeight;
    };
    window.handleDrag = (e) => {
        if(resizingIndex === -1) return;
        const b = blocks[resizingIndex];
        const areaW = document.getElementById('canvas').offsetWidth;
        if(resizeMode === 'w') {
            let px = startW + (e.clientX - startX);
            b.width = Math.max(10, Math.min(100, (px / areaW) * 100));
        } else {
            b.height = Math.max(30, startH + (e.clientY - startY));
        }
        render();
    };
    window.stopDrag = () => { if(resizingIndex!==-1) { resizingIndex = -1; updateLink(); } };

    // --- REORDER ---
    let dragSrc = null;
    function bindDrag() {
        document.querySelectorAll('.widget-block').forEach(item => {
            item.addEventListener('dragstart', function(e) { dragSrc = this; e.dataTransfer.effectAllowed = 'move'; this.classList.add('dragging'); });
            item.addEventListener('dragend', function() { this.classList.remove('dragging'); });
            item.addEventListener('dragover', function(e) { e.preventDefault(); return false; });
            item.addEventListener('drop', function(e) {
                e.stopPropagation();
                if (dragSrc !== this) {
                    const s = parseInt(dragSrc.dataset.index); const d = parseInt(this.dataset.index);
                    const t = blocks[s]; blocks.splice(s, 1); blocks.splice(d, 0, t);
                    render(); updateLink();
                }
                return false;
            });
        });
    }

    // --- MODAL ENGINE (The Fix) ---
    window.openModal = (i) => {
        editingIdx = i;
        const b = blocks[i];
        
        // 1. Basic Fields
        document.getElementById('in-w').value = Math.round(b.width||50);
        document.getElementById('in-h').value = Math.round(b.height||100);
        document.getElementById('in-label').value = b.label || '';
        document.getElementById('in-text').value = b.text || '';
        
        // Hide/Show Label Input
        const noLabel = ['date_display','world_clock','empty','spacer'];
        document.getElementById('wrap-label').style.display = noLabel.includes(b.type) ? 'none' : 'block';
        document.getElementById('wrap-text').style.display = b.type === 'header' ? 'block' : 'none';
        
        // 2. Inject Color Controls
        const colContainer = document.getElementById('modal-colors');
        colContainer.innerHTML = document.getElementById('tpl-colors').innerHTML;
        // Bind Colors
        ['bgColor','textColor','accentColor'].forEach(k => {
            const sel = colContainer.querySelector(`select[data-target="${k}"]`);
            const pick = colContainer.querySelector(`input[data-target="${k}"]`);
            
            // Fill Dropdown
            let html = colorPalette.map(c => `<option value="${c.hex}">${c.name}</option>`).join('');
            html += `<option value="custom">Custom</option>`;
            sel.innerHTML = html;
            
            // Set Values
            let val = b[k] || (k==='bgColor'?'#ffffff': k==='accentColor'?'#3498db':'#333333');
            pick.value = val;
            let match = colorPalette.find(c => c.hex.toLowerCase() === val.toLowerCase());
            sel.value = match ? match.hex : 'custom';
            
            // Listeners
            sel.onchange = () => { if(sel.value!=='custom') pick.value = sel.value; };
            pick.onchange = () => { sel.value = 'custom'; };
        });

        // 3. Inject Dynamic Content (The "Brain")
        const dyn = document.getElementById('modal-dynamic');
        dyn.innerHTML = '';
        
        if(b.type === 'world_clock') {
            dyn.innerHTML = document.getElementById('tpl-time').innerHTML;
            // Bind Toggles
            dyn.querySelectorAll('input[type="checkbox"]').forEach(ch => {
                ch.checked = b[ch.dataset.key] === true;
            });
            // Bind Cities
            renderModalCities();
            // Bind Search
            const inp = dyn.querySelector('#city-input');
            const res = dyn.querySelector('#city-results');
            inp.oninput = () => {
                const v = inp.value.toLowerCase();
                res.innerHTML = ''; res.style.display = 'none';
                if(v.length < 2) return;
                const m = cityDB.filter(c => c.name.toLowerCase().includes(v));
                if(m.length) {
                    res.style.display = 'block';
                    m.forEach(city => {
                        const div = document.createElement('div');
                        div.className = 'city-opt';
                        div.innerText = city.name;
                        div.onclick = () => {
                            blocks[editingIdx].locations.push({label:city.name, timezone:city.tz});
                            renderModalCities();
                            res.style.display = 'none'; inp.value = '';
                        };
                        res.appendChild(div);
                    });
                }
            };
        }
        else if(b.type === 'date_display') {
            dyn.innerHTML = document.getElementById('tpl-date').innerHTML;
            renderModalDates('mod-l1', b.line1);
            renderModalDates('mod-l2', b.line2);
        }

        document.getElementById('modal-overlay').style.display = 'flex';
    };

    window.saveModal = () => {
        const b = blocks[editingIdx];
        b.width = parseFloat(document.getElementById('in-w').value);
        b.height = parseFloat(document.getElementById('in-h').value);
        if(document.getElementById('wrap-label').style.display !== 'none') b.label = document.getElementById('in-label').value;
        if(document.getElementById('wrap-text').style.display !== 'none') b.text = document.getElementById('in-text').value;
        
        // Save Colors
        const colContainer = document.getElementById('modal-colors');
        ['bgColor','textColor','accentColor'].forEach(k => {
            b[k] = colContainer.querySelector(`input[data-target="${k}"]`).value;
        });
        
        // Save Toggles
        if(b.type === 'world_clock') {
            const dyn = document.getElementById('modal-dynamic');
            dyn.querySelectorAll('input[type="checkbox"]').forEach(ch => {
                b[ch.dataset.key] = ch.checked;
            });
        }
        
        render(); updateLink(); closeModal();
    };
    
    window.closeModal = () => document.getElementById('modal-overlay').style.display = 'none';

    // --- DYNAMIC MODAL HELPERS ---
    function renderModalCities() {
        const list = document.getElementById('mod-city-list');
        list.innerHTML = '';
        blocks[editingIdx].locations.forEach((l, i) => {
            list.innerHTML += `<div class="sub-item">
                <button class="btn-mini" onclick="moveCity(${i},-1)">↑</button>
                <input style="flex:1" value="${l.label}" oninput="blocks[editingIdx].locations[${i}].label=this.value">
                <button class="btn-mini btn-del-sub" onclick="delCity(${i})">×</button>
            </div>`;
        });
    }
    window.moveCity = (i, d) => {
        const locs = blocks[editingIdx].locations;
        if(i+d >= 0 && i+d < locs.length) { [locs[i], locs[i+d]] = [locs[i+d], locs[i]]; renderModalCities(); }
    };
    window.delCity = (i) => { blocks[editingIdx].locations.splice(i, 1); renderModalCities(); };

    function renderModalDates(id, arr) {
        const list = document.getElementById(id); list.innerHTML = '';
        arr.forEach((t, i) => {
            let val = typeof t === 'string' ? t : t.type;
            let opts = dateTokens.map(dt => `<option value="${dt.v}" ${val===dt.v?'selected':''}>${dt.t}</option>`).join('');
            list.innerHTML += `<div class="sub-item">
                <button class="btn-mini" onclick="moveDate('${id}',${i},-1)">↑</button>
                <select style="flex:1" onchange="updDate('${id}',${i},this.value)">${opts}</select>
                <button class="btn-mini btn-del-sub" onclick="delDate('${id}',${i})">×</button>
            </div>`;
        });
    }
    window.addDateToken = (line) => { blocks[editingIdx][line].push('space'); renderModalDates(line==='line1'?'mod-l1':'mod-l2', blocks[editingIdx][line]); };
    // (Additional helpers for Date Update/Del would go here, simplified for length)

    // --- GLOBAL ---
    window.updateGlobal = () => {
        ['time','week','theme','font','size','pad'].forEach(k => {
            let key = k==='time'?'use24h': k==='week'?'weekStart': k==='size'?'textSize': k==='pad'?'padding': k;
            settings[key] = document.getElementById('s-'+k).value;
        });
        updateGlobalStyles(); updateLink();
    };
    
    function updateGlobalStyles() {
        const r = document.documentElement.style;
        r.setProperty('--font', settings.font==='serif'?'Georgia':settings.font==='mono'?'monospace':'sans-serif');
        r.setProperty('--base-size', settings.textSize==='small'?'14px':settings.textSize==='large'?'18px':'16px');
        const area = document.getElementById('canvas');
        if(settings.theme==='card') area.style.gap = '15px';
    }

    window.togglePanel = (id) => {
        const p = document.getElementById(id);
        const a = document.getElementById(id==='link-panel'?'arr-link':'arr-set');
        p.classList.toggle('open');
        a.classList.toggle('open');
    };
    
    window.updateLink = () => {
        const url = window.location.href.split('#')[0].replace('admin.html','index.html');
        const hash = window.btoa(unescape(encodeURIComponent(JSON.stringify({settings,blocks}))));
        document.getElementById('result-url').value = `${url}#${hash}`;
    };
    window.refresh = () => render();
    window.copyLink = () => { document.getElementById('result-url').select(); document.navigator.clipboard.writeText(document.getElementById('result-url').value); };
    window.openLink = () => window.open(document.getElementById('result-url').value, '_blank');

    init();
</script>
</body>
</html>
