<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Admin V73</title>
    <style>
        /* CORE */
        * { box-sizing: border-box; }
        :root { --bg-canvas: #f4f5f7; --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; --pad: 1rem; --c-acc: #34495e; }
        html, body { margin: 0; padding: 0; height: 100%; font-family: var(--font); background: var(--bg-canvas); color: #37352f; overflow: hidden; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }

        /* HEADER */
        .app-header { background: #fff; border-bottom: 1px solid #ddd; z-index: 100; flex-shrink: 0; }
        .header-bar { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .header-title { font-size: 0.95rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 10px; user-select: none; }
        .header-arrow { font-size: 0.8em; color: #999; transition: transform 0.2s; }
        .header-arrow.open { transform: rotate(180deg); }
        .header-actions { display: flex; gap: 8px; }

        /* SETTINGS (Dark Mode) */
        .settings-toggle { background: #2c3e50; color: white; padding: 10px 20px; font-weight: 600; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .settings-toggle:hover { background: #34495e; }
        .panel { overflow: hidden; max-height: 0; transition: max-height 0.3s ease-out; background: #fff; border-bottom: 1px solid #ddd; }
        .panel.open { max-height: 400px; overflow-y: auto; }
        .panel-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; padding: 20px; }
        .panel label { font-size: 0.7rem; font-weight: 700; color: #7f8c8d; text-transform: uppercase; display: block; margin-bottom: 5px; }

        /* CANVAS */
        .canvas-area { flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 140px; position: relative; background: #f4f5f7; }
        .canvas-watermark { position: absolute; top: 20px; left: 20px; font-size: 0.8rem; font-weight: 700; color: #ccc; text-transform: uppercase; pointer-events: none; }
        
        #canvas {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-auto-rows: 10px; /* Fine grain height */
            grid-gap: 15px;
            grid-auto-flow: dense; 
            padding-bottom: 100px;
        }

        /* BLOCK ITEM */
        .widget-block {
            position: relative; background: #fff; border-radius: 8px; overflow: hidden;
            border: 2px dashed #bdc3c7; display: flex; flex-direction: column;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .widget-block:hover { border-color: #3498db; box-shadow: 0 8px 20px rgba(0,0,0,0.1); z-index: 10; }
        .widget-block.dragging { opacity: 0.5; border-style: solid; }

        /* INNER CONTENT */
        .block-inner { width: 100%; height: 100%; padding: var(--pad); display: flex; flex-direction: column; justify-content: center; pointer-events: none; }

        /* CONTROLS */
        .block-controls { position: absolute; top: 5px; right: 5px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; z-index: 20; pointer-events: auto; }
        .widget-block:hover .block-controls { opacity: 1; }
        .ctrl-btn { width: 24px; height: 24px; border-radius: 4px; background: #fff; border: 1px solid #ccc; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #555; }
        .ctrl-btn:hover { background: #f0f0f0; }
        .ctrl-del { color: #c0392b; background: #fadbd8; border-color: #e6b0aa; }

        /* HANDLES */
        .handle-w { position: absolute; top: 0; bottom: 15px; right: 0; width: 15px; cursor: col-resize; z-index: 15; pointer-events: auto; }
        .handle-h { position: absolute; bottom: 0; left: 0; right: 0; height: 15px; cursor: row-resize; z-index: 15; pointer-events: auto; }
        .handle-w:hover, .handle-h:hover { background: rgba(52, 152, 219, 0.2); }

        /* FOOTER */
        .app-footer { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid #ddd; padding: 15px 20px; z-index: 500; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); }
        .footer-scroll { overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }
        .footer-buttons { display: inline-flex; gap: 8px; }
        .add-btn { padding: 8px 12px; border: none; border-radius: 4px; font-weight: 600; font-size: 0.75rem; color: white; cursor: pointer; transition: transform 0.1s; }
        .add-btn:hover { transform: translateY(-2px); opacity: 0.9; }
        
        /* COLORS */
        .c-text { background: #7f8c8d; } .c-date { background: #16a085; } .c-time { background: #27ae60; }
        .c-grid { background: #6aa84f; } .c-auto { background: #c0392b; } .c-custom { background: #d35400; }
        .c-cycle { background: #e67e22; } .c-count { background: #f39c12; } .c-timer { background: #8e44ad; }
        .c-seq { background: #9b59b6; } .c-cnt { background: #c90076; } .c-moon { background: #34495e; }
        .c-util { background: #95a5a6; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-card { background: white; width: 95%; max-width: 500px; border-radius: 8px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; font-weight: 700; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-body { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; text-align: right; background: #fff; flex-shrink: 0; }

        /* FORM ELEMENTS */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.75rem; font-weight: 700; color: #666; text-transform: uppercase; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; }
        .row { display: flex; gap: 10px; } .col { flex: 1; }
        
        .sub-list { border: 1px solid #eee; border-radius: 4px; padding: 10px; background: #fafafa; margin-bottom: 10px; }
        .sub-item { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; background: #fff; padding: 5px; border: 1px solid #eee; border-radius: 4px; }
        .btn-mini { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: 1px solid #ccc; background: #fff; border-radius: 4px; cursor: pointer; color: #555; }
        .btn-add-sub { width: 100%; padding: 8px; border: 1px dashed #ccc; background: #f9f9f9; color: #666; font-weight: 600; cursor: pointer; border-radius: 4px; }

        /* CITY SEARCH */
        .city-search-box { position: relative; }
        .city-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; max-height: 150px; overflow-y: auto; z-index: 2000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .city-opt { padding: 8px; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f0f0f0; } .city-opt:hover { background: #f5f5f5; }

        .hidden { display: none !important; }
        .link-textarea { width: 100%; height: 60px; font-family: monospace; font-size: 0.75rem; border: 1px solid #ddd; padding: 8px; background: #f9f9f9; resize: none; word-break: break-all; white-space: normal; }

        /* PREVIEW TYPOGRAPHY */
        .txt-lg { font-size: 1.5em; font-weight: 700; line-height: 1.1; }
        .txt-sub { font-size: 0.85em; opacity: 0.8; }
        .txt-lbl { font-size: 0.7em; text-transform: uppercase; font-weight: 700; opacity: 0.5; margin-bottom: 3px; }
        .clock-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div class="app-container">
    <div class="app-header">
        <div class="header-bar">
            <div class="header-title" onclick="togglePanel('link-panel')">Link Generator <span class="header-arrow" id="arr-link">▼</span></div>
            <div class="header-actions">
                <button class="btn-blue" style="padding:6px 12px; border:none; border-radius:4px; color:white; cursor:pointer" onclick="refresh()">Ref</button>
                <button class="btn-green" style="padding:6px 12px; border:none; border-radius:4px; color:white; cursor:pointer" onclick="copyLink()">Copy</button>
                <button class="btn-grey" style="padding:6px 12px; border:none; border-radius:4px; color:white; cursor:pointer" onclick="openLink()">Open</button>
            </div>
        </div>
        <div id="link-panel" class="panel">
            <div class="panel-content">
                <textarea class="link-textarea" id="result-url" readonly onclick="this.select()"></textarea>
            </div>
        </div>
        <div class="settings-toggle" onclick="togglePanel('settings-panel')"><span class="header-arrow" id="arr-set">▼</span> General Settings</div>
        <div id="settings-panel" class="panel">
            <div class="panel-grid">
                <div><label>Time Format</label><select id="s-time" onchange="updateGlobal()"><option value="12">12 Hour</option><option value="24">24 Hour</option></select></div>
                <div><label>Week Start</label><select id="s-week" onchange="updateGlobal()"><option value="monday">Monday</option><option value="sunday">Sunday</option></select></div>
                <div><label>Theme</label><select id="s-theme" onchange="updateGlobal()"><option value="standard">Standard</option><option value="card">Cards</option><option value="minimal">Minimal</option></select></div>
                <div><label>Font</label><select id="s-font" onchange="updateGlobal()"><option value="sans">Sans-Serif</option><option value="serif">Serif</option><option value="mono">Monospace</option></select></div>
                <div><label>Size</label><select id="s-size" onchange="updateGlobal()"><option value="medium">Medium</option><option value="small">Small</option><option value="large">Large</option></select></div>
                <div><label>Padding</label><select id="s-pad" onchange="updateGlobal()"><option value="comfortable">Normal</option><option value="compact">Compact</option><option value="spacious">Spacious</option></select></div>
            </div>
        </div>
    </div>

    <div class="canvas-area">
        <div class="canvas-watermark">Block Space</div>
        <div id="canvas" onmousemove="handleDrag(event)" onmouseup="stopDrag()"></div>
    </div>

    <div class="app-footer">
        <div class="footer-scroll">
            <div class="footer-buttons">
                <button class="add-btn c-text" onclick="addBlock('header')">Text</button>
                <button class="add-btn c-date" onclick="addBlock('date_display')">Date</button>
                <button class="add-btn c-time" onclick="addBlock('world_clock')">Time</button>
                <button class="add-btn c-grid" onclick="addBlock('visual_grid')">Grid</button>
                <button class="add-btn c-auto" onclick="addBlock('progress_group')">Auto Progress</button>
                <button class="add-btn c-custom" onclick="addBlock('progress_custom')">Custom Progress</button>
                <button class="add-btn c-cycle" onclick="addBlock('progress_cycle')">Cycle</button>
                <button class="add-btn c-count" onclick="addBlock('countdown')">Countdown</button>
                <button class="add-btn c-timer" onclick="addBlock('timer')">Timer</button>
                <button class="add-btn c-seq" onclick="addBlock('sequence')">Sequence</button>
                <button class="add-btn c-cnt" onclick="addBlock('counter')">Counter</button>
                <button class="add-btn c-moon" onclick="addBlock('moon_phase')">Moon Phase</button>
                <button class="add-btn c-util" onclick="addBlock('spacer')">Spacer</button>
                <button class="add-btn c-util" onclick="addBlock('empty')">Empty Block</button>
            </div>
        </div>
    </div>
</div>

<div id="warehouse" class="hidden">
    <div id="tpl-colors">
        <div class="form-group"><label>Colors</label><div class="row">
            <div class="col"><label style="font-size:0.6rem">Background</label><select data-ref="bg-sel"></select><input type="color" data-ref="bg-pick" style="width:100%;height:30px;padding:0;margin-top:2px"></div>
            <div class="col"><label style="font-size:0.6rem">Text</label><select data-ref="txt-sel"></select><input type="color" data-ref="txt-pick" style="width:100%;height:30px;padding:0;margin-top:2px"></div>
            <div class="col"><label style="font-size:0.6rem">Accent</label><select data-ref="acc-sel"></select><input type="color" data-ref="acc-pick" style="width:100%;height:30px;padding:0;margin-top:2px"></div>
        </div></div>
    </div>

    <div id="set-world_clock">
        <div class="form-group"><label>Toggles</label><div style="display:flex;gap:10px">
            <label><input type="checkbox" data-key="showSeconds"> Seconds</label>
            <label><input type="checkbox" data-key="showDate"> Date</label>
            <label><input type="checkbox" data-key="showTimezone"> Timezone</label>
        </div></div>
        <div class="form-group"><label>Cities</label><div class="sub-list" id="list-cities"></div>
            <div class="city-search-box"><input id="city-search" placeholder="Search City..."><div class="city-results" id="city-results"></div></div>
        </div>
    </div>

    <div id="set-date_display">
        <div class="form-group"><label>Line 1</label><div class="sub-list" id="list-l1"></div><button class="btn-add-sub" onclick="addDateItem('line1')">+ Element</button></div>
        <div class="form-group"><label>Line 2</label><div class="sub-list" id="list-l2"></div><button class="btn-add-sub" onclick="addDateItem('line2')">+ Element</button></div>
    </div>
    
    <div id="set-visual_grid">
        <div class="form-group"><div class="row">
            <div class="col"><label>Type</label><select data-key="gridType" onchange="toggleGridFields()"><option value="year">Year</option><option value="month">Month</option><option value="week">Week</option><option value="day">Day</option><option value="life">Life</option></select></div>
            <div class="col"><label>Shape</label><select data-key="shape"><option value="square">Square</option><option value="wide">Wide</option><option value="ultrawide">Ultrawide</option></select></div>
        </div></div>
        <div class="form-group"><div class="row">
            <div class="col"><label>Size</label><select data-key="blockSize"><option value="12px">Small</option><option value="16px">Medium</option><option value="24px">Large</option></select></div>
        </div></div>
        <div class="form-group" id="grid-life-fields" style="display:none"><div class="row">
            <div class="col"><label>DOB</label><input type="date" data-key="dob"></div>
            <div class="col"><label>Expectancy</label><input type="number" data-key="expectancy"></div>
        </div></div>
    </div>

    <div id="set-progress_group">
        <div class="form-group"><label>Items</label><div class="sub-list" id="list-prog"></div></div>
    </div>
    
    <div id="set-sequence">
        <div class="form-group"><label>Steps</label><div class="sub-list" id="list-steps"></div><button class="btn-add-sub" onclick="addStep()">+ Step</button></div>
    </div>
    
    <div id="set-timer">
        <div class="form-group"><div class="row"><div class="col"><label>Hours</label><input type="number" data-key="hours"></div><div class="col"><label>Minutes</label><input type="number" data-key="minutes"></div></div></div>
    </div>
    
    <div id="set-countdown">
        <div class="form-group"><label>Target Date</label><input type="date" data-key="date"></div>
        <div class="form-group"><label><input type="checkbox" data-key="includeTime"> Include Time</label></div>
        <div class="form-group"><label>Time</label><input type="time" data-key="time"></div>
    </div>
    
    <div id="set-progress_custom">
        <div class="form-group"><div class="row"><div class="col"><label>Start</label><input type="date" data-key="start"></div><div class="col"><label>End</label><input type="date" data-key="end"></div></div></div>
    </div>
    
    <div id="set-progress_cycle">
        <div class="form-group"><div class="row"><div class="col"><label>Start Date</label><input type="date" data-key="anchor"></div><div class="col"><label>Duration (Days)</label><input type="number" data-key="days"></div></div></div>
        <div class="form-group"><label>Reset</label><select data-key="resetMode"><option value="manual">Manual</option><option value="auto">Auto Loop</option></select></div>
    </div>
    
    <div id="set-moon_phase">
        <div class="form-group"><div style="display:flex;gap:10px">
            <label><input type="checkbox" data-key="showIcon"> Icon</label>
            <label><input type="checkbox" data-key="showPhase"> Name</label>
            <label><input type="checkbox" data-key="showAge"> Age</label>
        </div></div>
    </div>
    
    <div id="set-spacer">
        <div class="form-group"><div class="row"><div class="col"><label>Style</label><select data-key="style"><option value="solid">Solid</option><option value="dotted">Dotted</option><option value="dashed">Dashed</option></select></div><div class="col"><label>Thickness</label><select data-key="thickness"><option value="1px">Thin</option><option value="2px">Medium</option><option value="4px">Thick</option></select></div></div></div>
    </div>
</div>

<div class="modal-overlay" id="modal-overlay">
    <div class="modal-card">
        <div class="modal-header"><span id="modal-title">Settings</span><span style="cursor:pointer" onclick="closeModal()">✕</span></div>
        <div class="modal-body">
            <div class="form-group"><div class="row">
                <div class="col"><label>Width (1-12)</label><input type="number" id="in-cols" min="1" max="12"></div>
                <div class="col"><label>Height (px)</label><input type="number" id="in-rows" step="10"></div>
            </div></div>
            <div class="form-group" id="wrap-label"><label>Label</label><input type="text" id="in-label"></div>
            <div class="form-group" id="wrap-text"><label>Text</label><input type="text" id="in-text"></div>
            
            <div id="modal-slot"></div>
            <div id="color-slot"></div>
        </div>
        <div class="modal-footer"><button class="add-btn c-time" onclick="saveModal()">Done</button></div>
    </div>
</div>

<script>
    let settings = { use24h: '12', weekStart: 'monday', theme: 'standard', font: 'sans', textSize: 'medium', padding: 'comfortable' };
    let blocks = [];
    let editIdx = -1;
    let resizingIdx = -1;
    let resizeMode = ''; let startX, startY, startW, startH;

    const cityDB = [{name:"London",tz:"Europe/London"},{name:"New York",tz:"America/New_York"},{name:"Tokyo",tz:"Asia/Tokyo"},{name:"Paris",tz:"Europe/Paris"},{name:"Sydney",tz:"Australia/Sydney"},{name:"Dubai",tz:"Asia/Dubai"},{name:"Berlin",tz:"Europe/Berlin"},{name:"Singapore",tz:"Asia/Singapore"},{name:"Los Angeles",tz:"America/Los_Angeles"},{name:"Hong Kong",tz:"Asia/Hong_Kong"},{name:"Mumbai",tz:"Asia/Kolkata"}];
    const dateTokens = [{v:'day_name_full',t:'Day Name'},{v:'day_name_short',t:'Day (Mon)'},{v:'date_num',t:'Date (28)'},{v:'month_full',t:'Month Name'},{v:'month_short',t:'Month (Jan)'},{v:'month_num',t:'Month (01)'},{v:'year',t:'Year'},{v:'week_num',t:'Week #'},{v:'day_year',t:'Day of Year'},{v:'quarter',t:'Quarter'},{v:'separator',t:'Separator'},{v:'space',t:'Space'},{v:'slash',t:'/'}];
    const colorPalette = [{val:'default', hex:'#FFFFFF', name:'Default (White)'}, {val:'#34495e', hex:'#34495e', name:'Navy'}, {val:'#3498db', hex:'#3498db', name:'Blue'}, {val:'#27ae60', hex:'#27ae60', name:'Green'}, {val:'#c0392b', hex:'#c0392b', name:'Red'}, {val:'#f39c12', hex:'#f39c12', name:'Orange'}, {val:'#8e44ad', hex:'#8e44ad', name:'Purple'}, {val:'#7f8c8d', hex:'#7f8c8d', name:'Grey'}];

    function init() {
        try {
            const h = window.location.hash.substring(1);
            if(h) {
                const d = JSON.parse(decodeURIComponent(escape(window.atob(h))));
                settings = d.settings || settings; blocks = d.blocks || blocks;
            } else { blocks = [{type:'header', text:'Welcome', cols:12, height:100, id:'b1'}]; }
        } catch(e) {}
        
        ['time','week','theme','font','size','pad'].forEach(k => {
            let key = k==='time'?'use24h': k==='week'?'weekStart': k==='size'?'textSize': k==='pad'?'padding': k;
            const el = document.getElementById('s-'+k); if(el) el.value = settings[key] || (key==='use24h'?'12':'standard');
        });
        
        updateGlobalStyles(); render(); updateLink();
    }

    function render() {
        const cvs = document.getElementById('canvas'); cvs.innerHTML = '';
        blocks.forEach((b, i) => {
            if(!b.id) b.id = 'blk_'+Date.now();
            const div = document.createElement('div');
            div.className = 'widget-block';
            div.id = `card-${i}`; div.draggable = true; div.dataset.index = i;
            
            div.style.gridColumn = `span ${b.cols||6}`;
            div.style.gridRowEnd = `span ${Math.ceil((b.height||100)/10)}`;
            div.style.height = `${b.height||100}px`;
            
            let bg = b.bgColor || '#ffffff';
            let txt = b.textColor || '#333333';
            if(b.type === 'empty') { bg = 'transparent'; div.style.borderStyle = 'dashed'; div.style.opacity = '0.5'; }
            
            let inner = `<div class="block-inner" style="background:${bg}; color:${txt}">
                ${renderBlockContent(b)}
            </div>`;
            
            div.innerHTML = `
                <div class="block-controls">
                    <div class="ctrl-btn" onclick="openModal(${i})">⚙️</div>
                    <div class="ctrl-btn ctrl-del" onclick="delBlock(${i})">✕</div>
                </div>
                ${inner}
                <div class="handle-w" onmousedown="initResize(${i},'w',event)"></div>
                <div class="handle-h" onmousedown="initResize(${i},'h',event)"></div>
            `;
            cvs.appendChild(div);
        });
        bindDrag();
    }

    function renderBlockContent(b) {
        let h = ''; let acc = b.accentColor || '#3498db';
        if(b.type==='header') h = `<div class="txt-lg">${b.text}</div>`;
        else if(b.type==='world_clock') {
            if(b.locations) b.locations.forEach(l => {
                let ts = new Date().toLocaleTimeString('en-US', {timeZone:l.timezone, hour:settings.use24h=='24'?'2-digit':'numeric', minute:'2-digit', second:b.showSeconds?'2-digit':undefined});
                let ds = b.showDate ? new Date().toLocaleDateString('en-US',{weekday:'short',day:'numeric'}) : '';
                h += `<div class="clock-row"><span>${l.label} <small>${ds}</small></span><span style="font-weight:700">${ts}</span></div>`;
            });
        }
        else if(b.type==='date_display') {
            h = `<div class="txt-lg">Monday</div><div class="txt-sub">Jan 01</div>`;
        }
        else if(b.type==='visual_grid') {
            h = `<div class="txt-lbl">${b.gridType.toUpperCase()} GRID</div><div style="display:flex;flex-wrap:wrap;gap:2px">`;
            for(let i=0; i<30; i++) h+=`<div style="width:10px;height:10px;background:${acc};opacity:0.3"></div>`;
            h += `</div>`;
        }
        else if(b.type!=='empty') {
            h = `<div class="txt-lbl">${b.type.replace('_',' ')}</div><div class="txt-lg">${b.label||''}</div>`;
        }
        return h;
    }

    window.openModal = (i) => {
        editIdx = i; const b = blocks[i];
        document.getElementById('in-cols').value = b.cols || 6;
        document.getElementById('in-rows').value = b.height || 100;
        document.getElementById('in-label').value = b.label || '';
        document.getElementById('in-text').value = b.text || '';
        
        const noLbl = ['date_display','world_clock','empty','spacer'];
        document.getElementById('wrap-label').style.display = noLbl.includes(b.type) ? 'none' : 'block';
        document.getElementById('wrap-text').style.display = b.type==='header' ? 'block' : 'none';
        
        const colSlot = document.getElementById('color-slot');
        colSlot.innerHTML = ''; 
        const colTpl = document.getElementById('tpl-colors');
        colSlot.appendChild(colTpl); 
        
        ['bgColor','textColor','accentColor'].forEach(k => {
            const sel = colTpl.querySelector(`select[data-ref="${k==='bgColor'?'bg-sel':k==='textColor'?'txt-sel':'acc-sel'}"]`);
            const pick = colTpl.querySelector(`input[data-ref="${k==='bgColor'?'bg-pick':k==='textColor'?'txt-pick':'acc-pick'}"]`);
            sel.innerHTML = colorPalette.map(c=>`<option value="${c.hex}">${c.name}</option>`).join('') + `<option value="custom">Custom</option>`;
            let val = b[k] || (k==='bgColor'?'#ffffff': k==='accentColor'?'#3498db':'#333333');
            pick.value = val;
            let match = colorPalette.find(c=>c.hex.toLowerCase()===val.toLowerCase());
            sel.value = match ? match.hex : 'custom';
            sel.onchange = () => { if(sel.value!=='custom') pick.value = sel.value; };
            pick.onchange = () => { sel.value = 'custom'; };
        });

        const dynSlot = document.getElementById('modal-slot');
        Array.from(dynSlot.children).forEach(c => document.getElementById('warehouse').appendChild(c));
        
        const tpl = document.getElementById(`set-${b.type}`);
        if(tpl) {
            dynSlot.appendChild(tpl);
            if(b.type==='world_clock') {
                tpl.querySelectorAll('input[type="checkbox"]').forEach(ch => ch.checked = b[ch.dataset.key] === true);
                renderCityList(); bindCitySearch();
            }
            if(b.type==='date_display') { renderDateList('mod-l1', b.line1); renderDateList('mod-l2', b.line2); }
            if(b.type==='visual_grid') {
                tpl.querySelectorAll('select, input').forEach(el => { if(b[el.dataset.key]) el.value = b[el.dataset.key]; });
                toggleGridFields();
            }
            if(b.type==='progress_group') renderProgList();
            if(b.type==='sequence') renderSteps();
            if(b.type==='moon_phase'||b.type==='countdown'||b.type==='timer'||b.type==='progress_custom'||b.type==='progress_cycle'||b.type==='spacer') {
                tpl.querySelectorAll('select, input').forEach(el => { 
                    if(el.type==='checkbox') el.checked = b[el.dataset.key]===true;
                    else if(b[el.dataset.key]) el.value = b[el.dataset.key]; 
                });
            }
        }
        document.getElementById('modal-overlay').style.display = 'flex';
    };

    window.saveModal = () => {
        const b = blocks[editIdx];
        b.cols = parseInt(document.getElementById('in-cols').value);
        b.height = parseInt(document.getElementById('in-rows').value);
        if(document.getElementById('wrap-label').style.display!=='none') b.label = document.getElementById('in-label').value;
        if(document.getElementById('wrap-text').style.display!=='none') b.text = document.getElementById('in-text').value;
        
        const colTpl = document.getElementById('tpl-colors');
        b.bgColor = colTpl.querySelector('input[data-ref="bg-pick"]').value;
        b.textColor = colTpl.querySelector('input[data-ref="txt-pick"]').value;
        b.accentColor = colTpl.querySelector('input[data-ref="acc-pick"]').value;
        document.getElementById('warehouse').appendChild(colTpl);
        
        const slot = document.getElementById('modal-slot');
        if(slot.children.length > 0) {
            const form = slot.children[0];
            form.querySelectorAll('input, select').forEach(el => {
                if(el.dataset.key) b[el.dataset.key] = el.type==='checkbox' ? el.checked : el.value;
            });
            document.getElementById('warehouse').appendChild(form);
        }
        
        render(); updateLink(); closeModal();
    };
    
    window.closeModal = () => {
        const slot = document.getElementById('modal-slot');
        Array.from(slot.children).forEach(c => document.getElementById('warehouse').appendChild(c));
        const cSlot = document.getElementById('color-slot');
        Array.from(cSlot.children).forEach(c => document.getElementById('warehouse').appendChild(c));
        document.getElementById('modal-overlay').style.display = 'none';
    };

    function renderCityList() {
        const l = document.getElementById('list-cities'); l.innerHTML = '';
        blocks[editIdx].locations.forEach((loc, i) => {
            l.innerHTML += `<div class="sub-item"><button class="btn-mini" onclick="movCity(${i},-1)">↑</button><input style="flex:1" value="${loc.label}" oninput="blocks[editIdx].locations[${i}].label=this.value"><button class="btn-mini" style="background:#fadbd8;color:#c0392b" onclick="delCity(${i})">×</button></div>`;
        });
    }
    window.movCity = (i, d) => { const a = blocks[editIdx].locations; if(i+d>=0 && i+d<a.length) { [a[i],a[i+d]] = [a[i+d],a[i]]; renderCityList(); } };
    window.delCity = (i) => { blocks[editIdx].locations.splice(i, 1); renderCityList(); };
    
    function bindCitySearch() {
        const inp = document.getElementById('city-search');
        const res = document.getElementById('city-results');
        inp.oninput = () => {
            const v = inp.value.toLowerCase(); res.innerHTML=''; res.style.display='none';
            if(v.length<2) return;
            const m = cityDB.filter(c=>c.name.toLowerCase().includes(v));
            if(m.length) { res.style.display='block'; m.forEach(x => { res.innerHTML += `<div class="city-opt" onclick="addCity('${x.name}','${x.tz}')">${x.name}</div>`; }); }
        };
    }
    window.addCity = (n, t) => { blocks[editIdx].locations.push({label:n, timezone:t}); renderCityList(); document.getElementById('city-results').style.display='none'; document.getElementById('city-search').value=''; };

    function renderDateList(id, arr) {
        const l = document.getElementById(id); l.innerHTML = '';
        arr.forEach((t, i) => {
            let val = typeof t === 'string' ? t : t.type;
            let opts = dateTokens.map(dt => `<option value="${dt.v}" ${val===dt.v?'selected':''}>${dt.t}</option>`).join('');
            l.innerHTML += `<div class="sub-item"><button class="btn-mini" onclick="movDate('${id}',${i},-1)">↑</button><select onchange="blocks[editIdx]['${id==='mod-l1'?'line1':'line2'}'][${i}]=this.value">${opts}</select><button class="btn-mini" style="background:#fadbd8;color:#c0392b" onclick="delDate('${id}',${i})">×</button></div>`;
        });
    }
    window.addDateItem = (l) => { blocks[editIdx][l].push('space'); renderDateList(l==='line1'?'mod-l1':'mod-l2', blocks[editIdx][l]); };
    window.delDate = (id, i) => { let k = id==='mod-l1'?'line1':'line2'; blocks[editIdx][k].splice(i, 1); renderDateList(id, blocks[editIdx][k]); };
    window.movDate = (id, i, d) => { let k = id==='mod-l1'?'line1':'line2'; let a = blocks[editIdx][k]; if(i+d>=0 && i+d<a.length) { [a[i],a[i+d]] = [a[i+d],a[i]]; renderDateList(id, a); } };

    function renderProgList() {
        const l = document.getElementById('list-prog'); l.innerHTML='';
        blocks[editIdx].items.forEach((it, i) => {
            l.innerHTML += `<div class="sub-item"><input type="checkbox" ${it.visible!==false?'checked':''} onchange="blocks[editIdx].items[${i}].visible=this.checked"><span style="font-size:0.8rem;width:50px">${it.type}</span><input value="${it.label}" oninput="blocks[editIdx].items[${i}].label=this.value">` + (it.type==='life' ? `<input type="date" value="${it.dob||''}" onchange="blocks[editIdx].items[${i}].dob=this.value">`:'') + `</div>`;
        });
    }
    function renderSteps() {
        const l = document.getElementById('list-steps'); l.innerHTML='';
        blocks[editIdx].steps.forEach((s, i) => {
            l.innerHTML += `<div class="sub-item"><button class="btn-mini" onclick="movStep(${i},-1)">↑</button><input value="${s.label}" oninput="blocks[editIdx].steps[${i}].label=this.value"><input type="number" value="${s.duration}" style="width:50px" oninput="blocks[editIdx].steps[${i}].duration=this.value"><button class="btn-mini" style="background:#fadbd8;color:#c0392b" onclick="delStep(${i})">×</button></div>`;
        });
    }
    window.addStep = () => { blocks[editIdx].steps.push({label:'Step', duration:10}); renderSteps(); };
    window.delStep = (i) => { blocks[editIdx].steps.splice(i, 1); renderSteps(); };
    window.movStep = (i, d) => { const a = blocks[editIdx].steps; if(i+d>=0 && i+d<a.length) { [a[i],a[i+d]] = [a[i+d],a[i]]; renderSteps(); } };

    window.toggleGridFields = () => {
        const t = document.querySelector('#set-visual_grid select[data-key="gridType"]').value;
        document.getElementById('grid-life-fields').style.display = t === 'life' ? 'block' : 'none';
    };

    window.updateGlobal = () => {
        ['time','week','theme','font','size','pad'].forEach(k => {
            let key = k==='time'?'use24h': k==='week'?'weekStart': k==='size'?'textSize': k==='pad'?'padding': k;
            settings[key] = document.getElementById('s-'+k).value;
        });
        updateGlobalStyles(); updateLink();
    };
    function updateGlobalStyles() {
        const r = document.documentElement.style;
        r.setProperty('--font', settings.font==='serif'?'Georgia':settings.font==='mono'?'monospace':'sans-serif');
        r.setProperty('--base-size', settings.textSize==='small'?'14px':settings.textSize==='large'?'18px':'16px');
        const area = document.getElementById('canvas');
        if(settings.theme==='card') area.style.gap = '15px';
    }
    window.addBlock = (t) => {
        let b = { type: t, cols: 6, height: 100, id:'b_'+Date.now() };
        if(t==='header') { b.text = 'Text'; b.height = 60; }
        if(t==='world_clock') { b.locations = [{label:'London',timezone:'Europe/London'}]; b.height = 100; b.showSeconds=false; b.showDate=true; }
        if(t==='date_display') { b.line1=['day_name_full']; b.line2=['date_num','month_full']; b.height=80; }
        if(t==='visual_grid') { b.gridType='year'; b.shape='square'; b.height=150; }
        if(t==='progress_group') { b.items = [{type:'life', label:'Life', visible:true},{type:'year', label:'Year', visible:true}]; b.height=120; }
        if(t==='sequence') b.steps = [{label:'Focus', duration:25}];
        if(t==='spacer') b.height = 30;
        if(t==='empty') b.height = 50;
        blocks.push(b); render(); updateLink();
        const area = document.querySelector('.canvas-area'); setTimeout(() => area.scrollTop = area.scrollHeight, 50);
    };
    window.delBlock = (i) => { blocks.splice(i, 1); render(); updateLink(); };
    window.togglePanel = (id) => { document.getElementById(id).classList.toggle('open'); document.getElementById(id==='link-panel'?'arr-link':'arr-set').classList.toggle('open'); };
    window.updateLink = () => { const u = window.location.href.split('#')[0].replace('admin.html','index.html'); document.getElementById('result-url').value = `${u}#${window.btoa(unescape(encodeURIComponent(JSON.stringify({settings,blocks})))}`; };
    window.copyLink = () => { document.getElementById('result-url').select(); document.navigator.clipboard.writeText(document.getElementById('result-url').value); };
    window.openLink = () => window.open(document.getElementById('result-url').value, '_blank');
    window.refresh = () => render();

    window.initResize = (i, m, e) => { e.stopPropagation(); resizingIdx = i; resizeMode = m; startX = e.clientX; startY = e.clientY; startW = document.getElementById(`card-${i}`).offsetWidth; startH = blocks[i].height; };
    window.handleDrag = (e) => {
        if(resizingIdx === -1) return;
        const b = blocks[resizingIdx];
        if(resizeMode === 'w') {
            const gridW = document.getElementById('canvas').offsetWidth / 12;
            const px = startW + (e.clientX - startX);
            b.cols = Math.max(1, Math.min(12, Math.round(px / gridW)));
        } else { b.height = Math.max(30, startH + (e.clientY - startY)); }
        render();
    };
    window.stopDrag = () => { if(resizingIdx !== -1) { resizingIdx = -1; updateLink(); } };
    function bindDrag() {
        document.querySelectorAll('.widget-block').forEach(item => {
            item.addEventListener('dragstart', function(e) { dragSrc = this; e.dataTransfer.effectAllowed = 'move'; this.classList.add('dragging'); });
            item.addEventListener('dragend', function() { this.classList.remove('dragging'); });
            item.addEventListener('dragover', function(e) { e.preventDefault(); return false; });
            item.addEventListener('drop', function(e) {
                e.stopPropagation();
                if (dragSrc !== this) {
                    const s = parseInt(dragSrc.dataset.index); const d = parseInt(this.dataset.index);
                    const t = blocks[s]; blocks.splice(s, 1); blocks.splice(d, 0, t);
                    render(); updateLink();
                }
                return false;
            });
        });
    }

    init();
</script>
</body>
</html>
