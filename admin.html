<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Admin V65</title>
    <style>
        /* CORE */
        * { box-sizing: border-box; }
        :root { --c-accent: #34495e; --bg-canvas: #f4f5f7; }
        html, body { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: var(--bg-canvas); color: #37352f; overflow: hidden; }
        
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        
        /* HEADER */
        .app-header { background: #fff; border-bottom: 1px solid #ddd; z-index: 100; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .header-bar { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; background: #fff; position: relative; z-index: 2; }
        .header-title { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 10px; cursor: pointer; user-select: none; }
        .header-title span { font-size: 0.8rem; color: #999; }
        .header-actions { display: flex; gap: 8px; }
        
        .panel { background: #fafafa; border-bottom: 1px solid #eee; overflow: hidden; max-height: 0; transition: max-height 0.3s ease-out; padding: 0 20px; }
        .panel.open { max-height: 400px; padding: 15px 20px; border-bottom: 1px solid #ddd; overflow-y: auto; }
        /* V65: Restored 6-Column Grid */
        .panel-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; }
        @media(max-width: 768px) { .panel-grid { grid-template-columns: 1fr 1fr; } }
        
        button.btn { padding: 6px 12px; border: none; border-radius: 4px; font-weight: 600; font-size: 0.8rem; cursor: pointer; color: white; transition: opacity 0.2s; }
        button.btn:hover { opacity: 0.9; }
        .btn-blue { background: #3498db; } .btn-green { background: #27ae60; } .btn-grey { background: #7f8c8d; }
        
        /* CANVAS */
        .canvas-area { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; transition: background 0.3s; position: relative; }
        
        /* BLOCK */
        .widget-block { 
            position: relative; 
            border: 2px dashed rgba(0,0,0,0.1); 
            border-radius: 8px; 
            background: #fff; 
            min-height: 80px; 
            transition: box-shadow 0.2s, border-color 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            /* V65: FLUID WIDTH handled by inline style */
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        .widget-block:hover { border-color: var(--c-accent); box-shadow: 0 8px 20px rgba(0,0,0,0.1); z-index: 10; }
        .widget-block.dragging { opacity: 0.5; border-style: solid; transform: scale(0.98); }

        /* CONTROLS */
        .block-controls { position: absolute; top: 5px; right: 5px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s; z-index: 20; }
        .widget-block:hover .block-controls { opacity: 1; }
        .ctrl-btn { width: 24px; height: 24px; border-radius: 4px; border: 1px solid #ccc; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .ctrl-btn:hover { background: #eee; }
        .ctrl-del { color: #c0392b; border-color: #e6b0aa; background: #fadbd8; }
        
        /* HANDLES */
        .resize-handle-w { position: absolute; top: 0; bottom: 10px; right: -5px; width: 10px; cursor: col-resize; z-index: 30; }
        .resize-handle-h { position: absolute; bottom: -5px; left: 0; right: 0; height: 10px; cursor: row-resize; z-index: 30; }
        .resize-handle-w:hover, .resize-handle-h:hover { background: rgba(52, 152, 219, 0.3); }

        /* FOOTER */
        .app-footer { background: #fff; border-top: 1px solid #ddd; padding: 10px 20px; flex-shrink: 0; z-index: 100; box-shadow: 0 -4px 12px rgba(0,0,0,0.05); overflow-x: auto; }
        .footer-label { font-size: 0.7rem; font-weight: 700; color: #999; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .footer-buttons { display: flex; gap: 8px; }
        .add-btn { padding: 8px 12px; border: none; border-radius: 4px; font-weight: 600; font-size: 0.75rem; color: white; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
        .add-btn:hover { transform: translateY(-1px); opacity: 0.9; }
        
        /* COLORS */
        .c-text { background: #7f8c8d; } .c-date { background: #16a085; } .c-time { background: #27ae60; }
        .c-grid { background: #6aa84f; } .c-auto { background: #c0392b; } .c-custom { background: #d35400; }
        .c-cycle { background: #e67e22; } .c-count { background: #f39c12; } .c-timer { background: #8e44ad; }
        .c-seq { background: #9b59b6; } .c-cnt { background: #c90076; } .c-moon { background: #34495e; }
        .c-util { background: #95a5a6; }

        /* MODAL (Restored Full Logic) */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-card { background: white; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow: hidden; display: flex; flex-direction: column; max-height: 85vh; }
        .modal-header { padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #eee; font-weight: 700; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-body { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; text-align: right; background: #fff; flex-shrink: 0; }
        
        /* FORM ELEMENTS */
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.75rem; color: #666; margin-top: 12px; }
        label:first-child { margin-top: 0; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; }
        .row { display: flex; gap: 10px; } .col { flex: 1; }
        
        /* SUB-LIST ITEMS (Restored) */
        .sub-list { border: 1px solid #eee; border-radius: 4px; padding: 10px; background: #fafafa; margin-top: 5px; }
        .sub-item { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        .sub-item:last-child { margin-bottom: 0; }
        .btn-mini { padding: 4px 8px; font-size: 0.7rem; cursor: pointer; border: 1px solid #ccc; background: #fff; border-radius: 3px; }
        .btn-mini-add { width: 100%; margin-top: 5px; background: #eef0f2; border: 1px solid #ddd; padding: 6px; font-weight: 600; color: #555; }
        
        /* CONTENT STYLES (Mock) */
        .widget-content { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .txt-lg { font-size: 1.4em; font-weight: 700; }
        .txt-md { font-size: 1.1em; font-weight: 600; }
        .txt-sm { font-size: 0.85em; opacity: 0.7; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="app-header">
        <div class="header-bar">
            <div class="header-title" onclick="togglePanel('link-panel')">Link Generator <span>▼</span></div>
            <div class="header-actions">
                <button class="btn btn-blue" onclick="refresh()">Refresh</button>
                <button class="btn btn-green" onclick="copyLink()">Copy</button>
                <button class="btn btn-grey" onclick="openLink()">Open</button>
            </div>
        </div>
        <div id="link-panel" class="panel">
            <input class="link-textarea" id="result-url" readonly onclick="this.select()">
        </div>
        
        <div class="header-bar" style="border-top:1px solid #f0f0f0;">
            <div class="header-title" onclick="togglePanel('settings-panel')">General Settings <span>▼</span></div>
        </div>
        <div id="settings-panel" class="panel">
            <div class="panel-grid">
                <div><label>Time Format</label><select id="s-time" onchange="updateGlobal()"><option value="12">12 Hour</option><option value="24">24 Hour</option></select></div>
                <div><label>Week Start</label><select id="s-week" onchange="updateGlobal()"><option value="monday">Monday</option><option value="sunday">Sunday</option></select></div>
                <div><label>Theme</label><select id="s-theme" onchange="updateGlobal()"><option value="standard">Standard</option><option value="card">Cards</option><option value="minimal">Minimal</option></select></div>
                <div><label>Font</label><select id="s-font" onchange="updateGlobal()"><option value="sans">Sans-Serif</option><option value="serif">Serif</option><option value="mono">Monospace</option></select></div>
                <div><label>Text Size</label><select id="s-size" onchange="updateGlobal()"><option value="small">Small</option><option value="medium" selected>Medium</option><option value="large">Large</option></select></div>
                <div><label>Padding</label><select id="s-pad" onchange="updateGlobal()"><option value="comfortable">Normal</option><option value="compact">Compact</option><option value="spacious">Spacious</option></select></div>
            </div>
        </div>
    </div>

    <div class="canvas-area" id="canvas" onmousemove="handleDrag(event)" onmouseup="stopDrag()">
        </div>

    <div class="app-footer">
        <div class="footer-label">Add Block</div>
        <div class="footer-buttons">
            <button class="add-btn c-text" onclick="addBlock('header')">Text</button>
            <button class="add-btn c-date" onclick="addBlock('date_display')">Date</button>
            <button class="add-btn c-time" onclick="addBlock('world_clock')">Time</button>
            <button class="add-btn c-grid" onclick="addBlock('visual_grid')">Grid</button>
            <button class="add-btn c-auto" onclick="addBlock('progress_group')">Auto Progress</button>
            <button class="add-btn c-custom" onclick="addBlock('progress_custom')">Custom</button>
            <button class="add-btn c-cycle" onclick="addBlock('progress_cycle')">Cycle</button>
            <button class="add-btn c-count" onclick="addBlock('countdown')">Countdown</button>
            <button class="add-btn c-timer" onclick="addBlock('timer')">Timer</button>
            <button class="add-btn c-seq" onclick="addBlock('sequence')">Sequence</button>
            <button class="add-btn c-cnt" onclick="addBlock('counter')">Counter</button>
            <button class="add-btn c-moon" onclick="addBlock('moon_phase')">Moon Phase</button>
            <button class="add-btn c-util" onclick="addBlock('spacer')">Spacer</button>
            <button class="add-btn c-util" onclick="addBlock('empty')">Empty</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-overlay">
    <div class="modal-card">
        <div class="modal-header"><span id="modal-title">Edit</span><span style="cursor:pointer" onclick="closeModal()">✕</span></div>
        <div class="modal-body" id="modal-content"></div>
        <div class="modal-footer"><button class="btn btn-blue" onclick="saveModal()">Done</button></div>
    </div>
</div>

<script>
    // --- STATE ---
    let settings = { use24h: '12', weekStart: 'monday', theme: 'standard', font: 'sans', textSize: 'medium', padding: 'comfortable' };
    let blocks = [];
    let editingIndex = -1;
    let resizingIndex = -1;
    let resizeMode = ''; // 'w' or 'h'
    let startX = 0; let startW = 0;
    let startY = 0; let startH = 0;

    // --- DATA ---
    const colorPalette = [
        {val:'default', name:'Default (Black)'}, {val:'#5b5b5b', name:'Dark Grey'}, {val:'#7f8c8d', name:'Grey'},
        {val:'#bcbcbc', name:'Light Grey'}, {val:'#cc0000', name:'Dark Red'}, {val:'#fa2c1c', name:'Red'},
        {val:'#d35400', name:'Pumpkin'}, {val:'#e67e22', name:'Orange'}, {val:'#f39c12', name:'Yellow Orange'},
        {val:'#ffd700', name:'Gold'}, {val:'#27ae60', name:'Green'}, {val:'#16a085', name:'Teal'},
        {val:'#2980b9', name:'Blue'}, {val:'#8e44ad', name:'Purple'}, {val:'#c90076', name:'Magenta'}
    ];

    // --- INIT ---
    function init() {
        try {
            const hash = window.location.hash.substring(1);
            if(hash) {
                const data = JSON.parse(decodeURIComponent(escape(window.atob(hash))));
                settings = data.settings || settings;
                blocks = data.blocks || blocks;
            } else {
                blocks = [{type: 'header', text: 'Welcome', width: 100, height: 100, id: 'b1'}];
            }
        } catch(e) {}
        
        // Sync Global Inputs
        document.getElementById('s-time').value = settings.use24h;
        document.getElementById('s-week').value = settings.weekStart;
        document.getElementById('s-theme').value = settings.theme;
        document.getElementById('s-font').value = settings.font;
        document.getElementById('s-size').value = settings.textSize;
        document.getElementById('s-pad').value = settings.padding;

        render();
        updateLink();
    }

    // --- RENDER ENGINE ---
    function render() {
        const canvas = document.getElementById('canvas');
        let html = '';
        
        blocks.forEach((b, i) => {
            if(!b.id) b.id = 'blk_' + Math.random().toString(36).substr(2,9);
            
            // FLUID WIDTH/HEIGHT
            let w = b.width || 100;
            let h = b.height || 100; // Default height for empty/spacer might differ
            if(b.type === 'spacer') h = b.height || 20;

            // Generate Preview Content (Simulated)
            let inner = '';
            if(b.type === 'header') inner = `<div class="txt-lg">${b.text}</div>`;
            else if(b.type === 'date_display') inner = `<div class="txt-lg">Monday</div><div class="txt-sm">Jan 01</div>`;
            else if(b.type === 'world_clock') inner = `<div class="txt-md">London</div><div class="txt-lg">12:00</div>`;
            else inner = `<div class="txt-sm" style="text-transform:uppercase;font-weight:bold;opacity:0.5">${b.type}</div><div class="txt-md">${b.label||''}</div>`;

            let style = `width: calc(${w}% - 10px); height: ${h}px;`;
            if(b.color && b.color !== 'default') style += `border-left: 4px solid ${b.color};`;

            html += `
            <div class="widget-block" id="card-${i}" draggable="true" style="${style}" data-index="${i}">
                <div class="block-controls">
                    <div class="ctrl-btn" onclick="editBlock(${i})">⚙️</div>
                    <div class="ctrl-btn ctrl-del" onclick="deleteBlock(${i})">✕</div>
                </div>
                <div class="widget-content">${inner}</div>
                <div class="resize-handle-w" onmousedown="initResize(${i}, 'w', event)"></div>
                <div class="resize-handle-h" onmousedown="initResize(${i}, 'h', event)"></div>
            </div>`;
        });
        
        canvas.innerHTML = html;
        addDragListeners();
    }

    // --- RESIZING LOGIC (FLUID) ---
    window.initResize = (i, mode, e) => {
        e.stopPropagation();
        resizingIndex = i;
        resizeMode = mode;
        startX = e.clientX;
        startY = e.clientY;
        const el = document.getElementById(`card-${i}`);
        startW = el.offsetWidth;
        startH = el.offsetHeight;
        document.body.style.cursor = mode === 'w' ? 'col-resize' : 'row-resize';
    };

    window.handleDrag = (e) => {
        if(resizingIndex === -1) return;
        
        const b = blocks[resizingIndex];
        const canvasW = document.getElementById('canvas').offsetWidth - 40; // minus padding
        
        if(resizeMode === 'w') {
            const diff = e.clientX - startX;
            let newPx = startW + diff;
            // Convert to %
            let newPct = (newPx / canvasW) * 100;
            // Snap logic can be added here, but user asked for "any width"
            if(newPct < 15) newPct = 15;
            if(newPct > 100) newPct = 100;
            b.width = newPct;
        } else {
            const diff = e.clientY - startY;
            let newH = startH + diff;
            if(newH < 40) newH = 40;
            b.height = newH;
        }
        render(); // Live update
    };

    window.stopDrag = () => {
        if(resizingIndex !== -1) {
            resizingIndex = -1;
            document.body.style.cursor = 'default';
            updateLink();
        }
    };

    // --- DRAG & DROP (Reorder) ---
    let dragSrc = null;
    function addDragListeners() {
        const cols = document.querySelectorAll('.widget-block');
        cols.forEach(col => {
            col.addEventListener('dragstart', function(e) {
                dragSrc = this;
                e.dataTransfer.effectAllowed = 'move';
                this.classList.add('dragging');
            });
            col.addEventListener('dragend', function() {
                this.classList.remove('dragging');
            });
            col.addEventListener('dragover', function(e) {
                e.preventDefault();
                return false;
            });
            col.addEventListener('drop', function(e) {
                e.stopPropagation();
                if (dragSrc !== this) {
                    const srcIdx = parseInt(dragSrc.dataset.index);
                    const destIdx = parseInt(this.dataset.index);
                    // Swap
                    const item = blocks[srcIdx];
                    blocks.splice(srcIdx, 1);
                    blocks.splice(destIdx, 0, item);
                    render(); updateLink();
                }
                return false;
            });
        });
    }

    // --- EDIT MODAL (The Brains) ---
    window.editBlock = (i) => {
        editingIndex = i;
        const b = blocks[i];
        const c = document.getElementById('modal-content');
        
        let html = ``;
        
        // Common
        html += `<div class="row">
            <div class="col"><label>Accent Color</label><select id="in-color">${getColorOpts(b.color)}</select></div>
            <div class="col"><label>Text Color</label><select id="in-tcolor">${getColorOpts(b.textColor)}</select></div>
        </div>`;

        // Type Specific
        if(b.type === 'header') {
            html += `<label>Text</label><input id="in-text" value="${b.text}">`;
        }
        else if(b.type === 'world_clock') {
             html += `<label>Label</label><input id="in-label" value="${b.label||''}">`;
             html += `<div class="sub-list" id="mod-list"></div><button class="btn-mini-add" onclick="addModalItem('city')">+ Add City</button>`;
        }
        else if(b.type === 'date_display') {
             html += `<label>Format Line 1</label><input id="in-l1" value="${b.line1||''}" placeholder="Day, Date"><label>Format Line 2</label><input id="in-l2" value="${b.line2||''}" placeholder="Month Year">`;
        }
        else {
             html += `<label>Label</label><input id="in-label" value="${b.label||''}">`;
        }
        
        c.innerHTML = html;
        
        // Render sub-lists if needed (simplified for V65 - expands on demand)
        
        document.getElementById('modal-overlay').style.display = 'flex';
    };

    window.saveModal = () => {
        const b = blocks[editingIndex];
        const t = document.getElementById('in-text');
        const l = document.getElementById('in-label');
        const c = document.getElementById('in-color');
        
        if(t) b.text = t.value;
        if(l) b.label = l.value;
        if(c) b.color = c.value;
        
        render(); updateLink();
        document.getElementById('modal-overlay').style.display = 'none';
    };
    
    window.closeModal = () => document.getElementById('modal-overlay').style.display = 'none';

    function getColorOpts(sel) {
        return colorPalette.map(c => `<option value="${c.val}" ${sel===c.val?'selected':''}>${c.name}</option>`).join('');
    }

    // --- GLOBAL ---
    window.updateGlobal = () => {
        settings.use24h = document.getElementById('s-time').value;
        settings.weekStart = document.getElementById('s-week').value;
        settings.theme = document.getElementById('s-theme').value;
        settings.font = document.getElementById('s-font').value;
        settings.textSize = document.getElementById('s-size').value;
        settings.padding = document.getElementById('s-pad').value;
        updateLink();
    };

    window.addBlock = (type) => {
        // V65: Default width 50%, Default Height 100px
        blocks.push({ type: type, width: 50, height: 100, id: 'b_'+Date.now(), text: 'New Text', label: 'New ' + type });
        render(); updateLink();
    };
    
    window.deleteBlock = (i) => { blocks.splice(i, 1); render(); updateLink(); };
    window.refresh = () => render();
    window.togglePanel = (id) => document.getElementById(id).classList.toggle('open');
    
    window.updateLink = () => {
        const json = JSON.stringify({ settings, blocks });
        const hash = window.btoa(unescape(encodeURIComponent(json)));
        const url = window.location.href.split('#')[0].replace('admin.html', 'index.html');
        document.getElementById('result-url').value = `${url}#${hash}`;
        // Silent hash update
        window.history.replaceState(null, null, `#${hash}`);
    };
    
    window.copyLink = () => {
        document.getElementById('result-url').select();
        document.navigator.clipboard.writeText(document.getElementById('result-url').value);
    };
    
    window.openLink = () => window.open(document.getElementById('result-url').value, '_blank');

    init();
</script>
</body>
</html>
