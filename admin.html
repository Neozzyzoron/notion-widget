<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Admin V74</title>
    <style>
        /* CORE */
        * { box-sizing: border-box; }
        :root { --bg: #f4f5f7; --font: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; --pad: 1rem; --c-acc: #34495e; }
        html, body { margin: 0; padding: 0; height: 100%; font-family: var(--font); background: var(--bg); color: #333; overflow: hidden; }
        
        /* LAYOUT GRID */
        .app { display: flex; flex-direction: column; height: 100vh; }
        .main-body { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* HEADER */
        .header { height: 50px; background: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; z-index: 20; }
        .header h1 { font-size: 1rem; font-weight: 700; margin: 0; }
        .header-actions { display: flex; gap: 10px; }
        
        /* CANVAS (CENTER) */
        .canvas-container { flex: 1; overflow-y: auto; padding: 40px; padding-bottom: 160px; /* Space for footer */ background: #f4f5f7; position: relative; }
        #canvas { 
            display: grid; 
            grid-template-columns: repeat(12, 1fr); 
            grid-auto-rows: 10px; /* Fine grain height */
            grid-gap: 15px; 
            grid-auto-flow: dense; /* Enables smart stacking */
            max-width: 1200px; margin: 0 auto;
        }
        .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 2rem; font-weight: 700; opacity: 0.05; pointer-events: none; }

        /* INSPECTOR (RIGHT SIDEBAR) */
        .inspector { 
            width: 340px; background: #fff; border-left: 1px solid #ddd; 
            overflow-y: auto; padding-bottom: 140px; /* Space for footer */
            display: flex; flex-direction: column; z-index: 10;
        }
        .insp-header { padding: 15px; background: #fafafa; border-bottom: 1px solid #eee; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; color: #555; }
        .insp-content { padding: 15px; flex: 1; }
        .settings-group { display: none; } /* Hidden by default */
        .settings-group.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* FOOTER (BOTTOM) */
        .footer { 
            position: fixed; bottom: 0; left: 0; right: 0; height: 110px; 
            background: #fff; border-top: 1px solid #ccc; 
            padding: 15px 20px; z-index: 100; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); 
            display: flex; flex-direction: column; justify-content: center;
        }
        .footer-title { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #999; margin-bottom: 10px; }
        .footer-scroll { overflow-x: auto; white-space: nowrap; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .footer-scroll::-webkit-scrollbar { height: 6px; }
        .footer-scroll::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        
        /* BUTTONS */
        .btn { padding: 6px 12px; border: none; border-radius: 4px; font-weight: 600; font-size: 0.8rem; cursor: pointer; color: white; }
        .btn-blue { background: #3498db; } .btn-green { background: #27ae60; } .btn-grey { background: #7f8c8d; }
        
        .add-btn { display: inline-block; padding: 10px 15px; margin-right: 8px; border-radius: 6px; border: none; color: white; font-weight: 600; font-size: 0.75rem; cursor: pointer; transition: transform 0.1s; }
        .add-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        
        /* COLORS (V59 Palette) */
        .c-text { background: #7f8c8d; } .c-date { background: #16a085; } .c-time { background: #27ae60; }
        .c-grid { background: #6aa84f; } .c-auto { background: #c0392b; } .c-custom { background: #d35400; }
        .c-cycle { background: #e67e22; } .c-count { background: #f39c12; } .c-timer { background: #8e44ad; }
        .c-seq { background: #9b59b6; } .c-cnt { background: #c90076; } .c-moon { background: #34495e; }
        .c-util { background: #95a5a6; }

        /* BLOCK VISUALS */
        .widget-block { 
            position: relative; border-radius: 8px; 
            border: 2px dashed #ccc; background: #fff; 
            transition: box-shadow 0.2s, border-color 0.2s;
            overflow: hidden; 
        }
        .widget-block.selected { border: 2px solid #3498db; box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1); z-index: 5; }
        .widget-block:hover { border-color: #999; }
        .widget-block.dragging { opacity: 0.5; }
        
        .block-inner { width: 100%; height: 100%; padding: var(--pad); pointer-events: none; display: flex; flex-direction: column; justify-content: center; }
        
        /* HANDLES & CONTROLS */
        .handle { position: absolute; z-index: 10; }
        .handle-r { top: 0; bottom: 10px; right: 0; width: 15px; cursor: col-resize; }
        .handle-b { bottom: 0; left: 0; right: 0; height: 15px; cursor: row-resize; }
        .handle:hover { background: rgba(52,152,219,0.1); }
        
        .block-actions { position: absolute; top: 5px; right: 5px; display: none; gap: 5px; z-index: 20; }
        .widget-block:hover .block-actions, .widget-block.selected .block-actions { display: flex; }
        .act-btn { width: 24px; height: 24px; background: white; border: 1px solid #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #555; }
        .act-btn:hover { background: #eee; }
        .act-del { color: #c0392b; border-color: #e6b0aa; background: #fadbd8; }

        /* FORM ELEMENTS (V59 Style) */
        .form-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .form-section:last-child { border: none; }
        label { display: block; font-size: 0.7rem; font-weight: 700; color: #666; margin-bottom: 5px; text-transform: uppercase; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; margin-bottom: 10px; }
        .row { display: flex; gap: 10px; } .col { flex: 1; }
        
        /* LISTS */
        .list-container { border: 1px solid #eee; background: #fafafa; border-radius: 4px; padding: 10px; margin-bottom: 10px; }
        .list-item { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; background: #fff; padding: 5px; border: 1px solid #eee; border-radius: 4px; }
        .btn-mini { width: 24px; height: 24px; border: 1px solid #ccc; background: #fff; border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .btn-add { width: 100%; padding: 8px; background: #eef0f2; border: 1px dashed #ccc; border-radius: 4px; color: #666; font-weight: 600; cursor: pointer; }
        
        /* LINK BOX */
        .link-box { position: absolute; top: 60px; right: 20px; width: 300px; background: white; border: 1px solid #ddd; box-shadow: 0 5px 20px rgba(0,0,0,0.1); padding: 15px; border-radius: 8px; display: none; z-index: 500; }
        .link-box.active { display: block; }
        textarea { width: 100%; height: 80px; font-family: monospace; font-size: 0.8rem; resize: none; border: 1px solid #ddd; padding: 8px; }

        /* PREVIEW TYPOGRAPHY */
        .txt-lg { font-size: 1.5em; font-weight: 700; line-height: 1.1; }
        .txt-sub { font-size: 0.85em; opacity: 0.8; }
        .txt-lbl { font-size: 0.7em; text-transform: uppercase; font-weight: 700; opacity: 0.5; margin-bottom: 3px; }
        .clock-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .grid-wrap { display: flex; flex-wrap: wrap; gap: 2px; }
        .grid-sq { border-radius: 1px; flex-shrink: 0; opacity: 0.15; background: currentColor; }
        .grid-sq.filled { opacity: 0.9; }
    </style>
</head>
<body>

<div class="app">
    <div class="header">
        <h1>Widget Builder V74</h1>
        <div class="header-actions">
            <button class="btn btn-blue" onclick="refresh()">Refresh</button>
            <button class="btn btn-green" onclick="toggleLink()">Get Link</button>
            <button class="btn btn-grey" onclick="openPreview()">Open</button>
        </div>
    </div>
    
    <div class="link-box" id="link-box">
        <label>Share Link</label>
        <textarea id="result-url" readonly onclick="this.select()"></textarea>
        <button class="btn btn-green" style="width:100%; margin-top:10px" onclick="copyLink()">Copy to Clipboard</button>
    </div>

    <div class="main-body">
        <div class="canvas-container">
            <div class="watermark">Dashboard Area</div>
            <div id="canvas"></div>
        </div>

        <div class="inspector" id="inspector">
            <div class="insp-header">Settings</div>
            
            <div class="insp-content" id="global-settings">
                <div class="form-section">
                    <label>Global Styles</label>
                    <select id="g-theme" onchange="updateGlobal()"><option value="standard">Standard Theme</option><option value="card">Card Theme</option><option value="minimal">Minimal Theme</option></select>
                    <div class="row">
                        <div class="col"><select id="g-font" onchange="updateGlobal()"><option value="sans">Sans-Serif</option><option value="serif">Serif</option><option value="mono">Mono</option></select></div>
                        <div class="col"><select id="g-size" onchange="updateGlobal()"><option value="medium">Medium Txt</option><option value="small">Small</option><option value="large">Large</option></select></div>
                    </div>
                    <div class="row">
                        <div class="col"><select id="g-time" onchange="updateGlobal()"><option value="12">12 Hour</option><option value="24">24 Hour</option></select></div>
                        <div class="col"><select id="g-week" onchange="updateGlobal()"><option value="monday">Mon Start</option><option value="sunday">Sun Start</option></select></div>
                    </div>
                </div>
            </div>

            <div class="insp-content" id="insp-empty" style="text-align:center; color:#999; margin-top:50px;">
                Select a block to edit
            </div>

            <div class="insp-content" id="insp-dynamic" style="display:none">
                <div class="form-section">
                    <label>Appearance</label>
                    <div class="row"><div class="col"><label>Width (1-12)</label><input type="number" id="in-cols" min="1" max="12"></div><div class="col"><label>Height (px)</label><input type="number" id="in-height" step="10"></div></div>
                    <label>Colors</label>
                    <div class="row">
                        <div class="col"><label style="font-size:9px">Background</label><input type="color" id="in-bg" style="height:30px;padding:0"></div>
                        <div class="col"><label style="font-size:9px">Text</label><input type="color" id="in-txt" style="height:30px;padding:0"></div>
                        <div class="col"><label style="font-size:9px">Accent</label><input type="color" id="in-acc" style="height:30px;padding:0"></div>
                    </div>
                    <div id="wrap-label"><label>Label</label><input type="text" id="in-label"></div>
                    <div id="wrap-text" style="display:none"><label>Text Content</label><input type="text" id="in-text"></div>
                </div>

                <div id="set-world_clock" class="settings-group">
                    <label>Toggles</label>
                    <div style="display:flex; gap:10px; margin-bottom:10px">
                        <label><input type="checkbox" data-key="showSeconds"> Seconds</label>
                        <label><input type="checkbox" data-key="showDate"> Date</label>
                        <label><input type="checkbox" data-key="showTimezone"> Timezone</label>
                    </div>
                    <label>Cities</label>
                    <div class="list-container" id="list-cities"></div>
                    <select id="city-select" onchange="addCity(this.value)"><option value="">+ Add City</option></select>
                </div>

                <div id="set-date_display" class="settings-group">
                    <label>Line 1</label><div class="list-container" id="list-l1"></div><button class="btn-add" onclick="addDateToken('line1')">+ Element</button>
                    <br><label>Line 2</label><div class="list-container" id="list-l2"></div><button class="btn-add" onclick="addDateToken('line2')">+ Element</button>
                </div>

                <div id="set-visual_grid" class="settings-group">
                    <label>Grid Config</label>
                    <select data-key="gridType" onchange="toggleGridUI()"><option value="year">Year</option><option value="month">Month</option><option value="life">Life</option></select>
                    <select data-key="blockSize"><option value="12px">Small</option><option value="16px">Medium</option><option value="24px">Large</option></select>
                    <div id="grid-life-ui" style="display:none">
                        <label>Date of Birth</label><input type="date" data-key="dob">
                        <label>Expectancy</label><input type="number" data-key="expectancy">
                    </div>
                </div>

                <div id="set-progress_group" class="settings-group">
                    <label>Progress Bars</label>
                    <div class="list-container" id="list-prog"></div>
                </div>

                <div id="set-countdown" class="settings-group">
                    <label>Target Date</label><input type="date" data-key="date">
                    <label><input type="checkbox" data-key="includeTime"> Include Time</label>
                </div>
                
                <div id="set-sequence" class="settings-group">
                    <label>Steps</label><div class="list-container" id="list-steps"></div>
                    <button class="btn-add" onclick="addStep()">+ Step</button>
                </div>
                
                <div id="set-moon_phase" class="settings-group">
                    <label><input type="checkbox" data-key="showIcon"> Show Icon</label>
                    <label><input type="checkbox" data-key="showPhase"> Show Name</label>
                    <label><input type="checkbox" data-key="showAge"> Show Age</label>
                </div>

                <div style="margin-top:20px; text-align:right">
                    <button class="btn btn-blue" style="width:100%" onclick="saveSettings()">Update Block</button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="footer-title">Add Block</div>
        <div class="footer-scroll">
            <div class="footer-buttons">
                <button class="add-btn c-text" onclick="addBlock('header')">Text</button>
                <button class="add-btn c-date" onclick="addBlock('date_display')">Date</button>
                <button class="add-btn c-time" onclick="addBlock('world_clock')">Time</button>
                <button class="add-btn c-grid" onclick="addBlock('visual_grid')">Grid</button>
                <button class="add-btn c-auto" onclick="addBlock('progress_group')">Auto Progress</button>
                <button class="add-btn c-custom" onclick="addBlock('progress_custom')">Custom Progress</button>
                <button class="add-btn c-cycle" onclick="addBlock('progress_cycle')">Cycle</button>
                <button class="add-btn c-count" onclick="addBlock('countdown')">Countdown</button>
                <button class="add-btn c-timer" onclick="addBlock('timer')">Timer</button>
                <button class="add-btn c-seq" onclick="addBlock('sequence')">Sequence</button>
                <button class="add-btn c-cnt" onclick="addBlock('counter')">Counter</button>
                <button class="add-btn c-moon" onclick="addBlock('moon_phase')">Moon Phase</button>
                <button class="add-btn c-util" onclick="addBlock('spacer')">Spacer</button>
                <button class="add-btn c-util" onclick="addBlock('empty')">Empty Block</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- DATA KERNEL (V59) ---
    let settings = { use24h:'12', weekStart:'monday', theme:'standard', font:'sans', textSize:'medium', padding:'comfortable' };
    let blocks = [];
    let selIdx = -1;
    let resizing = false; let rMode=''; let rStart={};

    const cityDB = [ {name:"London",tz:"Europe/London"},{name:"New York",tz:"America/New_York"},{name:"Tokyo",tz:"Asia/Tokyo"},{name:"Paris",tz:"Europe/Paris"},{name:"Sydney",tz:"Australia/Sydney"},{name:"Dubai",tz:"Asia/Dubai"},{name:"Los Angeles",tz:"America/Los_Angeles"},{name:"Singapore",tz:"Asia/Singapore"},{name:"Berlin",tz:"Europe/Berlin"},{name:"Toronto",tz:"America/Toronto"} ]; // (Truncated for brevity, full logic supported)
    const dateTokens = [ {v:'day_name_full',t:'Day Name'},{v:'date_num',t:'Date'},{v:'month_full',t:'Month'},{v:'year',t:'Year'},{v:'week_num',t:'Week #'},{v:'separator',t:'|'},{v:'space',t:'Space'} ];

    // --- INIT ---
    function init() {
        try {
            const h = window.location.hash.substring(1);
            if(h) {
                const d = JSON.parse(decodeURIComponent(escape(window.atob(h))));
                settings = d.settings || settings; blocks = d.blocks || blocks;
            } else {
                blocks = [{type:'header', text:'Welcome', cols:12, height:100, id:'b1'}];
            }
        } catch(e) {}
        
        // Populate City Select
        const cs = document.getElementById('city-select');
        cityDB.forEach(c => cs.innerHTML += `<option value="${c.name}|${c.tz}">${c.name}</option>`);
        
        updateGlobalUI();
        render();
        updateLink();
    }

    // --- RENDERER (Shared Brain) ---
    function render() {
        const cvs = document.getElementById('canvas'); cvs.innerHTML = '';
        blocks.forEach((b, i) => {
            if(!b.id) b.id = 'blk_'+Date.now();
            const div = document.createElement('div');
            div.className = `widget-block ${i===selIdx?'selected':''}`;
            div.id = `card-${i}`; div.dataset.idx = i;
            div.draggable = true;
            
            // Grid Logic
            div.style.gridColumn = `span ${b.cols||6}`;
            div.style.gridRowEnd = `span ${Math.ceil((b.height||100)/10)}`;
            
            // Colors
            let bg = b.bgColor || '#ffffff';
            let txt = b.textColor || '#333333';
            if(b.type === 'empty') { bg = 'transparent'; div.style.borderStyle = 'dashed'; div.style.opacity = '0.5'; }
            
            div.innerHTML = `
                <div class="block-actions">
                    <div class="act-btn" onclick="copyBlock(${i})">C</div>
                    <div class="act-btn act-del" onclick="delBlock(${i})">✕</div>
                </div>
                <div class="block-inner" style="background:${bg}; color:${txt}">
                    ${renderContent(b)}
                </div>
                <div class="handle handle-r" onmousedown="startResize(${i},'w',event)"></div>
                <div class="handle handle-b" onmousedown="startResize(${i},'h',event)"></div>
            `;
            
            div.onclick = (e) => {
                if(!e.target.closest('.block-actions') && !e.target.closest('.handle')) selectBlock(i);
            };
            
            cvs.appendChild(div);
        });
        bindDrag();
    }

    function renderContent(b) {
        let h = ''; let acc = b.accentColor || '#3498db';
        if(b.type==='header') h = `<div class="txt-lg">${b.text}</div>`;
        else if(b.type==='world_clock') {
            if(b.locations) b.locations.forEach(l => {
                let ts = new Date().toLocaleTimeString('en-US',{timeZone:l.timezone, hour:settings.use24h=='24'?'2-digit':'numeric', minute:'2-digit'});
                h += `<div class="clock-row"><span>${l.label}</span><strong>${ts}</strong></div>`;
            });
        }
        else if(b.type==='date_display') h = `<div class="txt-lg">Monday</div><div class="txt-sub">Jan 01</div>`;
        else if(b.type==='visual_grid') {
            h = `<div class="txt-lbl">${b.gridType.toUpperCase()}</div><div class="grid-wrap">`;
            for(let i=0; i<20; i++) h+=`<div class="grid-sq" style="width:10px;height:10px;background:${acc}"></div>`;
            h+=`</div>`;
        }
        else if(b.type!=='empty') h = `<div class="txt-lbl">${b.type}</div><div class="txt-lg">${b.label||''}</div>`;
        return h;
    }

    // --- INSPECTOR LOGIC ---
    function selectBlock(i) {
        selIdx = i; render(); // Refresh selection visual
        const b = blocks[i];
        
        document.getElementById('insp-empty').style.display = 'none';
        document.getElementById('insp-dynamic').style.display = 'block';
        
        // 1. Common Fields
        document.getElementById('in-cols').value = b.cols || 6;
        document.getElementById('in-height').value = b.height || 100;
        document.getElementById('in-bg').value = b.bgColor || '#ffffff';
        document.getElementById('in-txt').value = b.textColor || '#333333';
        document.getElementById('in-acc').value = b.accentColor || '#3498db';
        
        document.getElementById('wrap-label').style.display = ['header','spacer','empty'].includes(b.type) ? 'none' : 'block';
        document.getElementById('in-label').value = b.label || '';
        document.getElementById('wrap-text').style.display = b.type==='header' ? 'block' : 'none';
        document.getElementById('in-text').value = b.text || '';

        // 2. Hide all groups, Show specific
        document.querySelectorAll('.settings-group').forEach(el => el.classList.remove('active'));
        const group = document.getElementById(`set-${b.type}`);
        if(group) {
            group.classList.add('active');
            
            // 3. Load Data into Form
            if(b.type==='world_clock') {
                renderCityList();
                ['showSeconds','showDate','showTimezone'].forEach(k => 
                    group.querySelector(`input[data-key="${k}"]`).checked = b[k]===true
                );
            }
            if(b.type==='date_display') { renderDateList('list-l1', b.line1); renderDateList('list-l2', b.line2); }
            if(b.type==='visual_grid') {
                group.querySelector('select[data-key="gridType"]').value = b.gridType;
                toggleGridUI();
                group.querySelector('input[data-key="dob"]').value = b.dob || '';
            }
            if(b.type==='progress_group') renderProgList();
            if(b.type==='sequence') renderSteps();
            // Generic Auto-Fill for simple inputs
            group.querySelectorAll('input, select').forEach(el => {
                if(el.dataset.key && b[el.dataset.key] !== undefined) {
                    if(el.type === 'checkbox') el.checked = b[el.dataset.key];
                    else el.value = b[el.dataset.key];
                }
            });
        }
    }

    function saveSettings() {
        if(selIdx === -1) return;
        const b = blocks[selIdx];
        
        // Save Common
        b.cols = parseInt(document.getElementById('in-cols').value);
        b.height = parseInt(document.getElementById('in-height').value);
        b.bgColor = document.getElementById('in-bg').value;
        b.textColor = document.getElementById('in-txt').value;
        b.accentColor = document.getElementById('in-acc').value;
        if(document.getElementById('wrap-label').style.display!=='none') b.label = document.getElementById('in-label').value;
        if(document.getElementById('wrap-text').style.display!=='none') b.text = document.getElementById('in-text').value;
        
        // Save Specific
        const group = document.getElementById(`set-${b.type}`);
        if(group) {
            group.querySelectorAll('input, select').forEach(el => {
                if(el.dataset.key) b[el.dataset.key] = el.type==='checkbox' ? el.checked : el.value;
            });
        }
        
        render(); updateLink();
    }

    // --- FORM HELPERS (V59 Port) ---
    function renderCityList() {
        const l = document.getElementById('list-cities'); l.innerHTML='';
        blocks[selIdx].locations.forEach((loc, i) => {
            l.innerHTML += `<div class="list-item"><button class="btn-mini" onclick="movCity(${i},-1)">↑</button><span style="flex:1;font-size:0.8rem">${loc.label}</span><button class="btn-mini" style="color:red" onclick="delCity(${i})">×</button></div>`;
        });
    }
    window.addCity = (val) => { if(!val) return; const [n,t] = val.split('|'); blocks[selIdx].locations.push({label:n, timezone:t}); renderCityList(); document.getElementById('city-select').value=''; };
    window.delCity = (i) => { blocks[selIdx].locations.splice(i,1); renderCityList(); };
    window.movCity = (i,d) => { const a=blocks[selIdx].locations; if(i+d>=0&&i+d<a.length) { [a[i],a[i+d]]=[a[i+d],a[i]]; renderCityList(); } };

    function renderDateList(id, arr) {
        const l = document.getElementById(id); l.innerHTML='';
        arr.forEach((t, i) => {
            let val = typeof t==='string'?t:t.type;
            let opts = dateTokens.map(d=>`<option value="${d.v}" ${val===d.v?'selected':''}>${d.t}</option>`).join('');
            l.innerHTML += `<div class="list-item"><button class="btn-mini" onclick="movDate('${id}',${i},-1)">↑</button><select onchange="updDate('${id}',${i},this.value)" style="margin:0">${opts}</select><button class="btn-mini" style="color:red" onclick="delDate('${id}',${i})">×</button></div>`;
        });
    }
    window.addDateToken = (l) => { blocks[selIdx][l].push('space'); renderDateList(l==='line1'?'list-l1':'list-l2', blocks[selIdx][l]); };
    window.updDate = (id, i, v) => { blocks[selIdx][id==='list-l1'?'line1':'line2'][i] = v; };
    window.delDate = (id, i) => { let k=id==='list-l1'?'line1':'line2'; blocks[selIdx][k].splice(i,1); renderDateList(id, blocks[selIdx][k]); };
    window.movDate = (id, i, d) => { let k=id==='list-l1'?'line1':'line2'; let a=blocks[selIdx][k]; if(i+d>=0&&i+d<a.length) { [a[i],a[i+d]]=[a[i+d],a[i]]; renderDateList(id, a); } };

    function renderProgList() {
        const l = document.getElementById('list-prog'); l.innerHTML='';
        blocks[selIdx].items.forEach((it,i) => {
            l.innerHTML += `<div class="list-item"><input type="checkbox" ${it.visible!==false?'checked':''} onchange="blocks[selIdx].items[${i}].visible=this.checked" style="width:auto;margin:0"><span style="font-size:0.8rem">${it.type}</span><input value="${it.label}" oninput="blocks[selIdx].items[${i}].label=this.value" style="margin:0"></div>`;
        });
    }
    
    function renderSteps() {
        const l = document.getElementById('list-steps'); l.innerHTML='';
        blocks[selIdx].steps.forEach((s,i) => {
            l.innerHTML += `<div class="list-item"><input value="${s.label}" oninput="blocks[selIdx].steps[${i}].label=this.value" style="margin:0"><input type="number" value="${s.duration}" oninput="blocks[selIdx].steps[${i}].duration=this.value" style="width:50px;margin:0"><button class="btn-mini" onclick="delStep(${i})">×</button></div>`;
        });
    }
    window.addStep = () => { blocks[selIdx].steps.push({label:'Step', duration:10}); renderSteps(); };
    window.delStep = (i) => { blocks[selIdx].steps.splice(i,1); renderSteps(); };

    window.toggleGridUI = () => {
        const type = document.querySelector('#set-visual_grid select[data-key="gridType"]').value;
        document.getElementById('grid-life-ui').style.display = type==='life'?'block':'none';
    };

    // --- GLOBAL ---
    window.addBlock = (t) => {
        let b = { type:t, cols:6, height:100, id:'b_'+Date.now() };
        if(t==='header') { b.text='Header'; b.height=60; }
        if(t==='world_clock') { b.locations=[{label:'London',timezone:'Europe/London'}]; }
        if(t==='date_display') { b.line1=['day_name_full']; b.line2=['date_num','month_full']; b.height=80; }
        if(t==='visual_grid') { b.gridType='year'; b.height=150; }
        if(t==='progress_group') { b.items=[{type:'year',label:'Year',visible:true},{type:'month',label:'Month',visible:true}]; b.height=140; }
        if(t==='sequence') b.steps = [{label:'Step 1', duration:15}];
        if(t==='spacer') b.height=40;
        blocks.push(b); render(); selectBlock(blocks.length-1); updateLink();
    };
    window.delBlock = (i) => { blocks.splice(i, 1); selIdx = -1; document.getElementById('insp-dynamic').style.display='none'; document.getElementById('insp-empty').style.display='block'; render(); updateLink(); };
    window.updateGlobal = () => {
        ['time','week','theme','font','size','pad'].forEach(k => {
            let key = k==='time'?'use24h': k==='week'?'weekStart': k==='size'?'textSize': k==='pad'?'padding': k;
            settings[key] = document.getElementById(k==='time'||k==='week'||k==='theme'||k==='font'||k==='size'||k==='pad'?'s-'+k:'g-'+k).value;
        });
        updateGlobalUI(); updateLink();
    };
    function updateGlobalUI() {
        const r = document.documentElement.style;
        r.setProperty('--font', settings.font==='serif'?'Georgia':settings.font==='mono'?'monospace':'sans-serif');
        document.getElementById('canvas').style.gap = settings.theme==='card'?'15px':'10px';
    }
    
    // --- RESIZE ---
    window.startResize = (i, m, e) => { e.stopPropagation(); resizing=true; selIdx=i; rMode=m; startX=e.clientX; startY=e.clientY; startW=document.getElementById(`card-${i}`).offsetWidth; startH=blocks[i].height; };
    window.handleDrag = (e) => {
        if(!resizing) return;
        const b = blocks[selIdx];
        if(rMode==='w') {
            const gridW = document.getElementById('canvas').offsetWidth / 12;
            b.cols = Math.max(1, Math.min(12, Math.round((startW + (e.clientX - startX)) / gridW)));
        } else {
            b.height = Math.max(40, startH + (e.clientY - startY));
        }
        render();
    };
    window.stopDrag = () => { if(resizing) { resizing=false; selectBlock(selIdx); updateLink(); } };
    
    // --- DRAG ---
    let dragSrc=null;
    function bindDrag() {
        document.querySelectorAll('.widget-block').forEach(item => {
            item.addEventListener('dragstart', function(e) { dragSrc=this; e.dataTransfer.effectAllowed='move'; this.style.opacity='0.4'; });
            item.addEventListener('dragend', function() { this.style.opacity='1'; });
            item.addEventListener('dragover', function(e) { e.preventDefault(); return false; });
            item.addEventListener('drop', function(e) {
                e.stopPropagation();
                if(dragSrc!==this) {
                    const s = parseInt(dragSrc.dataset.idx); const d = parseInt(this.dataset.idx);
                    const t = blocks[s]; blocks.splice(s, 1); blocks.splice(d, 0, t);
                    render(); updateLink();
                }
                return false;
            });
        });
    }

    window.togglePanel = (id) => document.getElementById(id).classList.toggle('open');
    window.toggleLink = () => { const b = document.getElementById('link-box'); b.classList.toggle('active'); updateLink(); };
    window.updateLink = () => { const u=window.location.href.split('#')[0].replace('admin.html','index.html'); document.getElementById('result-url').value = `${u}#${window.btoa(unescape(encodeURIComponent(JSON.stringify({settings,blocks})))}`; };
    window.copyLink = () => { document.getElementById('result-url').select(); document.navigator.clipboard.writeText(document.getElementById('result-url').value); };
    window.openPreview = () => window.open(document.getElementById('result-url').value, '_blank');
    window.refresh = () => render();

    init();
</script>
</body>
</html>
