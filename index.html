<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Widget Viewer</title>
    <style>
        :root {
            --bg-color: #FFFFFF;
            --text-color: #37352F;
            --accent-color: #E3E2E0;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            --base-size: 16px;

            /* Notion Palette Defaults */
            --c-gray: #9B9A97;
            --c-brown: #64473A;
            --c-orange: #D9730D;
            --c-yellow: #DFAB01;
            --c-green: #0F7B6C;
            --c-blue: #0B6E99;
            --c-purple: #6940A5;
            --c-pink: #AD1A72;
            --c-red: #E03E3E;
            --c-default: #37352F;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #191919;
                --text-color: #D4D4D4;
                --accent-color: #2F2F2F;
                
                --c-default: #D4D4D4;
                /* Dark mode tweaks if needed */
            }
        }
        
        body {
            font-family: var(--font-stack);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 1.25rem; 
            box-sizing: border-box;
            font-size: var(--base-size);
            min-height: 100vh;
            position: relative;
        }

        /* --- LAYOUT GRID --- */
        #dashboard { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 1.5rem; 
            max-width: 800px; 
            margin: 0 auto; 
            align-items: flex-start;
        }

        .widget-block {
            width: 100%; /* Default */
            box-sizing: border-box;
        }
        .widget-block.half-width {
            width: calc(50% - 0.75rem); /* 50% minus half the gap */
        }

        /* --- THEMES & STYLES --- */
        .theme-card .widget-block { border: 1px solid var(--accent-color); padding: 1rem; border-radius: 8px; }
        .theme-minimal .clock-time, .theme-minimal .countdown-time { font-weight: 400 !important; }
        .theme-minimal .progress-bg { height: 4px !important; }

        /* Typography */
        .widget-header { 
            font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; opacity: 0.6; 
            margin-bottom: 0.5rem; font-weight: 600; 
            color: var(--block-color, inherit); /* Dynamic Color */
        }
        
        /* Time */
        .clock-row { display: flex; justify-content: space-between; align-items: baseline; border-bottom: 1px solid var(--accent-color); padding: 0.5rem 0; }
        .clock-row:last-child { border-bottom: none; }
        .clock-time { font-family: "SF Mono", "Monaco", monospace; font-weight: 700; color: var(--block-color, inherit); }

        /* Progress */
        .progress-wrapper { margin-bottom: 0.75rem; }
        .progress-meta { display: flex; justify-content: space-between; font-size: 0.85em; margin-bottom: 0.25rem; font-weight: 500; }
        .progress-bg { height: 10px; background-color: var(--accent-color); border-radius: 5px; overflow: hidden; }
        .progress-fill { 
            height: 100%; 
            background-color: var(--block-color, var(--text-color)); /* Dynamic Color */
            width: 0%; 
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        /* Countdown */
        .countdown-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .countdown-label { font-weight: 500; }
        .countdown-time { 
            font-family: "SF Mono", "Monaco", monospace; font-weight: 700; 
            background: var(--accent-color); padding: 2px 6px; border-radius: 4px; font-size: 0.9em; 
            color: var(--block-color, inherit);
        }

        /* Timer */
        .timer-container { text-align: center; padding: 10px; background: var(--accent-color); border-radius: 8px; }
        .timer-display { 
            font-size: 2em; font-weight: 700; font-family: "SF Mono", monospace; margin: 10px 0; 
            color: var(--block-color, inherit);
        }
        .timer-controls { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;}
        .timer-btn { 
            background: var(--bg-color); color: var(--text-color); 
            border: 2px solid transparent; /* Prepare for colored border */
            padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: 600; flex: 1; 
        }
        .timer-btn:hover { opacity: 0.8; }
        
        /* Edit Button */
        #edit-btn {
            position: fixed; bottom: 10px; right: 10px;
            background: var(--text-color); color: var(--bg-color);
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s; cursor: pointer;
            text-decoration: none; font-size: 14px; z-index: 999;
        }
        body:hover #edit-btn { opacity: 0.4; }
        #edit-btn:hover { opacity: 1; }

        .error { width: 100%; color: #eb5757; font-size: 0.9em; text-align: center; padding: 20px;}
    </style>
</head>
<body>
    <div id="dashboard"></div>
    <a id="edit-btn" href="#" target="_blank" title="Edit Widget">âœŽ</a>

    <script>
        function getConfig() {
            try {
                const hash = window.location.hash.substring(1); 
                if (!hash) return null;
                const data = JSON.parse(atob(hash));
                if (Array.isArray(data)) return { settings: {}, blocks: data };
                return data;
            } catch (e) { return null; }
        }

        const container = document.getElementById('dashboard');

        function render() {
            const data = getConfig();
            if (!data) {
                container.innerHTML = `<div class="error">No settings found.<br>Use admin.html to generate a link.</div>`;
                return;
            }

            // Edit Link Logic
            document.getElementById('edit-btn').href = window.location.href.replace('index.html', 'admin.html');

            // Global Settings
            const settings = data.settings || {};
            document.body.className = `theme-${settings.theme || 'standard'}`;
            if(settings.fontSize === 'small') document.documentElement.style.setProperty('--base-size', '14px');
            if(settings.fontSize === 'large') document.documentElement.style.setProperty('--base-size', '18px');

            // --- RENDER BLOCKS ---
            // We rebuild DOM only if count changes to avoid flickering inputs/timers
            // For simple "live update" feel without React, clearing innerHTML is safest 
            // but resets timers. If that's annoying, we can optimize. For now: clear.
            container.innerHTML = ''; 

            data.blocks.forEach((block, index) => {
                const blockDiv = document.createElement('div');
                blockDiv.className = 'widget-block';
                blockDiv.id = `block-${index}`;
                
                // Layout: Width
                if (block.width === '50') blockDiv.classList.add('half-width');

                // Visuals: Color
                if (block.color) {
                    // Check if hex or preset
                    if (block.color.startsWith('#')) {
                        blockDiv.style.setProperty('--block-color', block.color);
                    } else if (block.color !== 'default') {
                        blockDiv.style.setProperty('--block-color', `var(--c-${block.color})`);
                    }
                }

                if (block.type === 'header') renderHeader(block, blockDiv);
                else if (block.type === 'world_clock') renderWorldClock(block, blockDiv, settings);
                else if (block.type === 'progress_group') renderProgressGroup(block, blockDiv);
                else if (block.type === 'progress_custom') renderCustomBar(block, blockDiv);
                else if (block.type === 'progress_cycle') renderCycleProgress(block, blockDiv);
                else if (block.type === 'countdown') renderCountdown(block, blockDiv);
                else if (block.type === 'timer') renderTimer(block, blockDiv, index);
                
                container.appendChild(blockDiv);
            });
            
            updateDynamicElements(data.blocks, settings);
        }

        // --- RENDERERS ---
        function renderHeader(data, parent) {
            const el = document.createElement('div');
            el.className = 'widget-header';
            el.style.opacity = "1"; // Headers usually full opacity
            el.innerText = data.text;
            parent.appendChild(el);
        }
        function renderWorldClock(data, parent) {
            data.locations.forEach((loc, i) => {
                const row = document.createElement('div');
                row.className = 'clock-row';
                row.innerHTML = `<span class="clock-label">${loc.label}</span><span class="clock-time" id="clock-${parent.id}-${i}">--:--</span>`;
                parent.appendChild(row);
            });
        }
        function renderProgressGroup(data, parent) {
            data.items.forEach(item => {
                const dates = getDatesForType(item.type);
                if(dates) parent.appendChild(createBarElement(item.label, dates.start, dates.end));
            });
        }
        function renderCustomBar(data, parent) {
            parent.appendChild(createBarElement(data.label, new Date(data.start), new Date(data.end)));
        }
        function renderCycleProgress(data, parent) {
            const wrapper = document.createElement('div');
            wrapper.className = 'progress-wrapper';
            wrapper.id = `cycle-${parent.id}`;
            wrapper.innerHTML = `<div class="progress-meta"><span id="cycle-label-${parent.id}">${data.label}</span><span id="cycle-pct-${parent.id}">0%</span></div><div class="progress-bg"><div class="progress-fill" id="cycle-bar-${parent.id}" style="width: 0%"></div></div>`;
            parent.appendChild(wrapper);
        }
        function renderCountdown(data, parent) {
            const row = document.createElement('div');
            row.className = 'countdown-row';
            row.innerHTML = `<span class="countdown-label">${data.label}</span><span class="countdown-time" id="cnt-${parent.id}">Loading...</span>`;
            parent.appendChild(row);
        }
        function renderTimer(data, parent, id) {
            const hrs = parseInt(data.hours) || 0;
            const mins = parseInt(data.minutes) || 0;
            const totalMins = (hrs * 60) + mins;
            const displayTime = hrs > 0 ? `${hrs}h ${mins}m` : `${mins}m`;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'timer-container';
            wrapper.innerHTML = `
                <div style="font-size:0.8em; opacity:0.7; text-transform:uppercase;">${data.label || 'Timer'}</div>
                <div class="timer-display" id="timer-display-${id}">00:00</div>
                <div class="timer-controls">
                    <button class="timer-btn" onclick="startTimer(${id}, ${totalMins})">Start ${displayTime}</button>
                    <button class="timer-btn" style="color:#eb5757; border-color:#eb5757" onclick="stopTimer(${id})">Stop</button>
                </div>
            `;
            parent.appendChild(wrapper);
        }

        // --- DYNAMIC UPDATES ---
        function updateDynamicElements(blocks, settings) {
            const now = new Date();
            const use24h = settings.use24h === true;

            blocks.forEach((block, bIdx) => {
                if (block.type === 'world_clock') {
                    block.locations.forEach((loc, lIdx) => {
                        const el = document.getElementById(`clock-block-${bIdx}-${lIdx}`);
                        if(el) {
                            const options = { hour: use24h ? '2-digit' : 'numeric', minute: '2-digit', hour12: !use24h };
                            if (loc.timezone && loc.timezone !== 'local') options.timeZone = loc.timezone;
                            let timeStr = now.toLocaleTimeString([], options);
                            if(!use24h) timeStr = timeStr.replace(' ', '');
                            el.innerText = timeStr;
                        }
                    });
                }
                if (block.type === 'countdown') {
                    const el = document.getElementById(`cnt-block-${bIdx}`);
                    if(el) {
                        const diff = new Date(block.date) - now;
                        if (diff <= 0) el.innerText = "Done";
                        else {
                            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            if (block.style === 'days') el.innerText = `${days}d`;
                            else el.innerText = `${days}d ${hours}h`;
                        }
                    }
                }
                if (block.type === 'progress_cycle') {
                    const anchor = new Date(block.anchor);
                    const days = parseFloat(block.days) || 1; 
                    const duration = days * 24 * 60 * 60 * 1000;
                    let elapsed = now - anchor;
                    if (elapsed < 0) updateCycleUI(bIdx, 0); 
                    else {
                        const currentCycleElapsed = elapsed % duration;
                        const percent = (currentCycleElapsed / duration) * 100;
                        updateCycleUI(bIdx, percent);
                    }
                }
                if (block.type === 'timer') updateTimerDisplay(bIdx);
            });
        }

        function updateCycleUI(id, percent) {
            const bar = document.getElementById(`cycle-bar-block-${id}`);
            const txt = document.getElementById(`cycle-pct-block-${id}`);
            if(bar && txt) {
                bar.style.width = `${percent}%`;
                txt.innerText = `${percent.toFixed(1)}%`;
            }
        }

        // --- HELPERS ---
        window.startTimer = (id, m) => { localStorage.setItem(`notion_timer_${id}`, new Date().getTime() + (m * 60000)); updateTimerDisplay(id); };
        window.stopTimer = (id) => { localStorage.removeItem(`notion_timer_${id}`); updateTimerDisplay(id); };
        function updateTimerDisplay(id) {
            const el = document.getElementById(`timer-display-${id}`);
            const end = localStorage.getItem(`notion_timer_${id}`);
            if (!end) { el.innerText = "00:00"; return; }
            const distance = end - new Date().getTime();
            if (distance < 0) { el.innerText = "Done!"; localStorage.removeItem(`notion_timer_${id}`); return; }
            const m = Math.floor(distance / 60000); 
            const s = Math.floor((distance % 60000) / 1000);
            el.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
        function createBarElement(label, start, end) {
            const now = new Date();
            let percent = 0;
            if (now > end) percent = 100;
            else if (now > start) percent = ((now - start) / (end - start)) * 100;
            const wrapper = document.createElement('div');
            wrapper.className = 'progress-wrapper';
            wrapper.innerHTML = `<div class="progress-meta"><span>${label}</span><span>${percent.toFixed(1)}%</span></div><div class="progress-bg"><div class="progress-fill" style="width: ${percent}%"></div></div>`;
            return wrapper;
        }
        function getDatesForType(type) {
            const now = new Date();
            const y = now.getFullYear(), m = now.getMonth();
            if (type === 'day') return { start: new Date(y, m, now.getDate()), end: new Date(y, m, now.getDate(), 23, 59, 59) };
            if (type === 'week') { const d = now.getDay(), diff = now.getDate() - d + (d === 0 ? -6 : 1); const s = new Date(now.setDate(diff)); s.setHours(0,0,0,0); const e = new Date(s); e.setDate(s.getDate() + 7); return { start: s, end: e }; }
            if (type === 'month') return { start: new Date(y, m, 1), end: new Date(y, m + 1, 0) };
            if (type === 'quarter') { const q = Math.floor(m / 3); return { start: new Date(y, q * 3, 1), end: new Date(y, (q + 1) * 3, 1) }; }
            if (type === 'year') return { start: new Date(y, 0, 1), end: new Date(y + 1, 0, 1) };
            return null;
        }

        render();
        // Loop for dynamic updates
        setInterval(() => { 
            // We pass the current config to updateDynamicElements 
            // In a real app we might optimize this, but for simplicity we fetch config
            const d = getConfig(); 
            if(d) updateDynamicElements(d.blocks, d.settings); 
        }, 1000);

    </script>
</body>
</html>
