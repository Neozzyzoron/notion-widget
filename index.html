<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget V68</title>
    <style>
        :root { --c-bg: #FFFFFF; --c-txt: #37352F; --font: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; --pad: 1rem; --rad: 8px; }
        @media (prefers-color-scheme: dark) { :root { --c-bg: #191919; --c-txt: #D4D4D4; } }
        
        body { margin: 0; padding: var(--pad); font-family: var(--font); background: var(--c-bg); color: var(--c-txt); overflow-x: hidden; }
        
        #dashboard { display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; width: 100%; }
        
        /* BLOCK CONTAINER */
        .widget-block {
            box-sizing: border-box;
            position: relative;
            border-radius: var(--rad);
            overflow: hidden;
            display: flex; flex-direction: column; justify-content: center;
            background: #f4f5f7; color: inherit;
            transition: all 0.2s ease;
            min-height: 40px;
        }
        
        /* THEMES */
        .theme-card .widget-block { box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .theme-minimal .widget-block { background: transparent !important; }
        
        /* CONTENT PADDING */
        .w-content { padding: 12px 15px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; }
        
        /* TYPOGRAPHY */
        .txt-label { font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; margin-bottom: 4px; font-weight: 600; }
        .txt-main { font-size: 1.2em; font-weight: 700; line-height: 1.2; }
        .txt-sub { font-size: 0.9em; opacity: 0.8; }
        
        /* SPECIFIC BLOCKS */
        /* Grid */
        .grid-container { display: flex; flex-wrap: wrap; gap: 2px; margin-top: 5px; }
        .grid-cell { background: currentColor; border-radius: 1px; flex-shrink: 0; opacity: 0.15; } 
        .grid-cell.filled { opacity: 0.9; }
        
        /* Progress */
        .prog-row { margin-bottom: 6px; }
        .prog-meta { display: flex; justify-content: space-between; font-size: 0.8em; margin-bottom: 2px; }
        .prog-track { height: 6px; background: rgba(0,0,0,0.1); border-radius: 3px; overflow: hidden; }
        .prog-fill { height: 100%; background: currentColor; }
        
        /* Clock */
        .clock-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); padding: 4px 0; }
        .clock-row:last-child { border: none; }
        
        /* Moon */
        .moon-row { display: flex; align-items: center; gap: 12px; }
        .moon-icon { font-size: 2em; line-height: 1; }
        
        /* Spacer */
        .spacer-line { width: 100%; opacity: 0.5; }
        
        /* EDIT BUTTON */
        .edit-fab { position: fixed; top: 10px; right: 10px; width: 35px; height: 35px; background: #fff; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 9999; color: #333; text-decoration: none; font-weight: bold; transition: transform 0.2s; }
        .edit-fab:hover { transform: scale(1.1); }
    </style>
</head>
<body>
    <a id="edit-btn" class="edit-fab" href="#" title="Edit Widget" style="display:none">âœŽ</a>
    <div id="dashboard"></div>

    <script>
        function decode(str) { try { return JSON.parse(decodeURIComponent(escape(window.atob(str)))); } catch(e) { return null; } }

        function render() {
            const hash = window.location.hash.substring(1);
            if(!hash) return;
            const data = decode(hash);
            if(!data) return;

            const s = data.settings || {};
            document.documentElement.style.setProperty('--font', s.font === 'serif' ? 'Georgia, serif' : s.font === 'mono' ? 'monospace' : '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif');
            document.documentElement.style.setProperty('--pad', s.padding === 'compact' ? '0.5rem' : s.padding === 'spacious' ? '1.5rem' : '1rem');
            
            let baseSize = '16px';
            if(s.textSize === 'small') baseSize = '14px';
            if(s.textSize === 'large') baseSize = '18px';
            document.body.style.fontSize = baseSize;
            
            document.body.className = `theme-${s.theme}`;

            const params = new URLSearchParams(window.location.search);
            if(params.get('preview') !== 'true') {
                const btn = document.getElementById('edit-btn');
                btn.style.display = 'flex';
                btn.onclick = (e) => {
                    e.preventDefault();
                    let url = window.location.href.split('#')[0].replace('index.html', 'admin.html');
                    if(url.endsWith('/')) url += 'admin.html';
                    window.location.href = url + window.location.hash;
                };
            }

            const root = document.getElementById('dashboard');
            root.innerHTML = '';

            data.blocks.forEach((b, i) => {
                const div = document.createElement('div');
                div.className = 'widget-block';
                div.id = `blk-${i}`;
                
                div.style.width = `calc(${b.width}% - 10px)`;
                div.style.height = `${b.height}px`;
                
                // BUBBLE STYLING (Accent = Background)
                if(b.type !== 'empty' && b.type !== 'spacer') {
                    if(b.color && b.color !== 'default') div.style.backgroundColor = b.color;
                    if(b.textColor && b.textColor !== 'default') div.style.color = b.textColor;
                    // Auto-white text if accent is standard color? 
                    // For now, rely on manual text color setting
                    if(b.color && b.color !== 'default' && (!b.textColor || b.textColor === 'default')) {
                        div.style.color = '#fff'; // Smart default
                    }
                }

                const content = document.createElement('div');
                content.className = 'w-content';
                
                if(b.type === 'header') {
                    content.innerHTML = `<div class="txt-main" style="font-size:1.5em">${b.text}</div>`;
                }
                else if(b.type === 'date_display') {
                    content.innerHTML = `<div class="txt-main">${buildDateString(b.line1)}</div><div class="txt-sub">${buildDateString(b.line2)}</div>`;
                }
                else if(b.type === 'world_clock') {
                    if(b.locations) {
                        b.locations.forEach(loc => {
                            const timeStr = new Date().toLocaleTimeString('en-US', {timeZone: loc.timezone, hour: s.use24h=='24'?'2-digit':'numeric', minute:'2-digit', hour12: s.use24h!='24'});
                            content.innerHTML += `<div class="clock-row"><span class="txt-sub">${loc.label}</span><span class="txt-main" style="font-family:monospace">${timeStr}</span></div>`;
                        });
                    }
                }
                else if(b.type === 'visual_grid') {
                    // Visual Logic
                    let size = b.blockSize === '24px' ? 24 : 16;
                    content.innerHTML = `<div class="txt-label">${b.gridType} Grid</div><div class="grid-container">` + 
                    Array(20).fill(0).map(() => `<div class="grid-cell filled" style="width:${size}px;height:${size}px"></div>`).join('') +
                    `</div>`;
                }
                else if(b.type === 'progress_group') {
                    if(b.items) {
                        b.items.forEach(item => {
                            if(item.visible !== false) {
                                content.innerHTML += `<div class="prog-row"><div class="prog-meta"><span>${item.label}</span><span>50%</span></div><div class="prog-track"><div class="prog-fill" style="width:50%"></div></div></div>`;
                            }
                        });
                    }
                }
                else if(b.type === 'countdown') {
                    const target = new Date(b.date);
                    const now = new Date();
                    const diff = Math.ceil((target - now) / (1000 * 60 * 60 * 24));
                    const val = diff > 0 ? `${diff} Days` : "Done";
                    content.innerHTML = `<div class="clock-row"><span class="txt-label">${b.label}</span><span class="txt-main">${val}</span></div>`;
                }
                else if(b.type === 'spacer') {
                    div.style.background = 'transparent';
                    div.style.boxShadow = 'none';
                    let col = b.color === 'default' ? 'currentColor' : b.color;
                    content.innerHTML = `<div class="spacer-line" style="border-bottom: ${b.thickness||'2px'} ${b.style||'solid'} ${col}"></div>`;
                }
                else if(b.type === 'empty') {
                    div.style.background = 'transparent';
                    div.style.boxShadow = 'none';
                }
                else {
                    content.innerHTML = `<div class="txt-label">${b.type}</div><div class="txt-main">${b.label||''}</div>`;
                }

                div.appendChild(content);
                root.appendChild(div);
            });
        }

        // Logic Helpers
        function buildDateString(tokens) {
            if(!tokens) return '';
            const now = new Date();
            return tokens.map(t => {
                const type = (typeof t === 'string') ? t : t.type;
                if(type === 'day_name_full') return now.toLocaleDateString([], {weekday:'long'});
                if(type === 'date_num') return now.getDate();
                if(type === 'month_full') return now.toLocaleDateString([], {month:'long'});
                if(type === 'year') return now.getFullYear();
                if(type === 'separator') return '|';
                if(type === 'space') return ' ';
                if(type === 'day_year') {
                    const start = new Date(now.getFullYear(), 0, 0);
                    const diff = now - start;
                    const oneDay = 1000 * 60 * 60 * 24;
                    const day = Math.floor(diff / oneDay);
                    return `Day ${day}/365`;
                }
                return '';
            }).join('');
        }

        window.addEventListener('hashchange', render);
        render();
    </script>
</body>
</html>
