<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Widget Viewer</title>
    <style>
        body { margin: 0; padding: 0; background: transparent; overflow: hidden; }
        #canvas { display: grid; grid-template-columns: repeat(12, 1fr); gap: 15px; padding: 10px; }
        .block { grid-column: span 12; border-radius: 8px; overflow: hidden; }
        #edit-link { 
            position: fixed; top: 5px; right: 5px; opacity: 0.1; 
            font-size: 10px; color: #000; text-decoration: none; 
        }
        #edit-link:hover { opacity: 1; }
    </style>
</head>
<body>
    <div id="canvas"></div>
    <a id="edit-link" href="admin.html">âœŽ Edit</a>

<script>
const Engine = {
    render(block) {
        let html = `<div style="padding:15px; background:${block.colors?.bg || '#fff'}; color:${block.colors?.text || '#000'}; height:100%; border-radius:inherit; box-sizing:border-box;">`;
        switch(block.type) {
            case 'header': html += `<h2 style="margin:0">${block.content || 'Header'}</h2>`; break;
            case 'life':
                const dob = new Date(block.dob || '1990-01-01');
                const diff = new Date() - dob;
                const weeksLived = Math.floor(diff / (1000 * 60 * 60 * 24 * 7));
                const totalWeeks = (block.years || 80) * 52;
                html += `<div>Life Progress</div><div style="display:grid; grid-template-columns:repeat(52, 1fr); gap:1px; margin-top:5px;">`;
                for(let i=0; i<totalWeeks; i++) {
                    const color = i < weeksLived ? (block.colors?.accent || '#37352f') : '#e9e9e8';
                    html += `<div style="width:100%; aspect-ratio:1; background:${color}"></div>`;
                }
                html += `</div>`;
                break;
            case 'moon': html += `<div style="font-size:2em; text-align:center;">${this.getMoonPhase()}</div>`; break;
            case 'spacer': html += `<div style="height:${block.h}px"></div>`; break;
            default: html += `Block: ${block.type}`;
        }
        html += `</div>`;
        return html;
    },
    getMoonPhase() {
        const phases = ['ðŸŒ‘','ðŸŒ’','ðŸŒ“','ðŸŒ”','ðŸŒ•','ðŸŒ–','ðŸŒ—','ðŸŒ˜'];
        return phases[new Date().getDate() % 8];
    }
};

function init() {
    const hash = window.location.hash.substring(1);
    if(!hash) return;
    
    try {
        const state = JSON.parse(atob(hash));
        const canvas = document.getElementById('canvas');
        document.body.style.fontFamily = state.settings?.font || 'sans-serif';
        
        state.blocks.forEach(block => {
            const div = document.createElement('div');
            div.className = 'block';
            div.style.gridColumn = `span ${block.w}`;
            div.innerHTML = Engine.render(block);
            canvas.appendChild(div);
        });

        if(window.location.search.includes('preview=true')) {
            document.getElementById('edit-link').style.display = 'none';
        } else {
            document.getElementById('edit-link').href = 'admin.html#' + hash;
        }
    } catch(e) {
        document.body.innerHTML = "Error loading configuration.";
    }
}

init();
</script>
</body>
</html>
