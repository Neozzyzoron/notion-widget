<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget V71</title>
    <style>
        :root { --c-bg: #FFFFFF; --c-txt: #333; --font: sans-serif; --pad: 1rem; --base-size: 16px; }
        @media (prefers-color-scheme: dark) { :root { --c-bg: #191919; --c-txt: #D4D4D4; } }
        body { margin: 0; padding: var(--pad); font-family: var(--font); background: var(--c-bg); color: var(--c-txt); font-size: var(--base-size); overflow-x: hidden; }
        
        #dashboard { display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px; width: 100%; }
        
        .widget-block {
            box-sizing: border-box; border-radius: 8px; overflow: hidden;
            display: flex; flex-direction: column; justify-content: center;
            padding: var(--pad); transition: all 0.2s ease;
        }
        
        .theme-card .widget-block { box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .theme-minimal .widget-block { background: transparent !important; }
        
        .txt-lg { font-size: 1.5em; font-weight: 700; line-height: 1.1; }
        .txt-sub { font-size: 0.85em; opacity: 0.8; }
        .txt-lbl { font-size: 0.7em; text-transform: uppercase; font-weight: 700; opacity: 0.5; margin-bottom: 4px; }
        .clock-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); padding: 4px 0; }
        
        .edit-fab { position: fixed; top: 10px; right: 10px; width: 35px; height: 35px; background: #fff; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 9999; color: #333; text-decoration: none; }
    </style>
</head>
<body>
    <a id="edit-btn" class="edit-fab" href="#" style="display:none">âœŽ</a>
    <div id="dashboard"></div>

    <script>
        function decode(str) { try { return JSON.parse(decodeURIComponent(escape(window.atob(str)))); } catch(e) { return null; } }

        function render() {
            const hash = window.location.hash.substring(1);
            if(!hash) return;
            const data = decode(hash);
            if(!data) return;

            const s = data.settings || {};
            const r = document.documentElement;
            r.style.setProperty('--font', s.font==='serif'?'Georgia':s.font==='mono'?'monospace':'sans-serif');
            r.style.setProperty('--pad', s.padding==='compact'?'0.5rem':s.padding==='spacious'?'1.5rem':'1rem');
            r.style.setProperty('--base-size', s.textSize==='small'?'14px':s.textSize==='large'?'18px':'16px');
            document.body.className = `theme-${s.theme}`;
            
            const root = document.getElementById('dashboard');
            root.innerHTML = '';
            
            if(new URLSearchParams(window.location.search).get('preview')!=='true') {
                const btn = document.getElementById('edit-btn');
                btn.style.display = 'flex';
                btn.onclick = (e) => { e.preventDefault(); window.location.href = window.location.href.replace('index.html','admin.html'); };
            }

            data.blocks.forEach(b => {
                const div = document.createElement('div');
                div.className = 'widget-block';
                div.style.width = `calc(${b.width}% - 10px)`;
                div.style.height = `${b.height}px`;
                div.style.background = b.bgColor || '#fff';
                div.style.color = b.textColor || '#333';
                if(b.type === 'empty') div.style.background = 'transparent';
                
                div.innerHTML = renderContent(b, s);
                root.appendChild(div);
            });
        }

        function renderContent(b, s) {
            let h = '';
            if(b.type==='header') h = `<div class="txt-lg">${b.text}</div>`;
            else if(b.type==='date_display') {
                h = `<div class="txt-lg">${buildDate(b.line1)}</div><div class="txt-sub">${buildDate(b.line2)}</div>`;
            }
            else if(b.type==='world_clock') {
                if(b.locations) b.locations.forEach(l => {
                    let ts = new Date().toLocaleTimeString('en-US', {timeZone:l.timezone, hour:s.use24h=='24'?'2-digit':'numeric', minute:'2-digit', second:b.showSeconds?'2-digit':undefined});
                    let ds = b.showDate ? new Date().toLocaleDateString('en-US', {weekday:'short',day:'numeric'}) : '';
                    let tz = b.showTimezone ? `<span style="opacity:0.5;font-size:0.7em">(${l.timezone.split('/')[1]})</span>` : '';
                    h += `<div class="clock-row">
                        <div><div style="font-weight:600">${l.label} ${tz}</div><div style="font-size:0.7em;opacity:0.7">${ds}</div></div>
                        <div class="txt-lg" style="font-family:monospace">${ts}</div>
                    </div>`;
                });
            }
            else if(b.type !== 'empty') {
                h = `<div class="txt-lbl">${b.type.replace('_',' ')}</div><div class="txt-lg">${b.label||''}</div>`;
            }
            return h;
        }
        
        function buildDate(tokens) {
            if(!tokens) return '';
            const now = new Date();
            return tokens.map(t => {
                if(t==='day_name_full') return now.toLocaleDateString([], {weekday:'long'});
                if(t==='date_num') return now.getDate();
                if(t==='month_full') return now.toLocaleDateString([], {month:'long'});
                if(t==='space') return ' ';
                if(t==='separator') return '|';
                return t; 
            }).join('');
        }

        window.addEventListener('hashchange', render);
        render(); setInterval(render, 1000);
    </script>
</body>
</html>
